<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pediatrics Shelf Study Guide</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { slate: { 850: '#172033' } },
          fontFamily: {
            sans: ['system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
            mono: ['JetBrains Mono', 'Fira Code', 'monospace'],
          }
        }
      }
    }
  </script>
  <style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    .choice-btn { transition: all 0.15s ease; }
    .choice-btn:hover { transform: translateX(4px); }
    .flashcard-flip { perspective: 1000px; }
    .flashcard-inner { transition: transform 0.5s; transform-style: preserve-3d; }
    .flashcard-inner.flipped { transform: rotateY(180deg); }
    .flashcard-front, .flashcard-back { backface-visibility: hidden; }
    .flashcard-back { transform: rotateY(180deg); }
    body { background: #0f172a; transition: background-color 0.3s ease; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LIGHT THEME OVERRIDES
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    body.theme-light { background: #f1f5f9 !important; }

    /* Structural elements */
    body.theme-light aside { background: #ffffff !important; border-color: #e2e8f0 !important; }
    body.theme-light header { background: rgba(255,255,255,0.92) !important; border-color: #e2e8f0 !important; }

    /* Text color remapping (darkâ†’light friendly) */
    body.theme-light .text-white { color: #0f172a !important; }
    body.theme-light .text-slate-100 { color: #1e293b !important; }
    body.theme-light .text-slate-200 { color: #334155 !important; }
    body.theme-light .text-slate-300 { color: #475569 !important; }
    body.theme-light .text-slate-400 { color: #64748b !important; }
    body.theme-light .text-slate-400 { color: #94a3b8 !important; }
    body.theme-light .text-slate-600 { color: #94a3b8 !important; }
    body.theme-light .text-slate-700 { color: #94a3b8 !important; }

    /* Background remapping */
    body.theme-light .bg-slate-900 { background-color: #f1f5f9 !important; }
    body.theme-light .bg-slate-950 { background-color: #ffffff !important; }
    body.theme-light [class*="bg-slate-800"] { background-color: #ffffff !important; }
    body.theme-light [class*="bg-slate-700"] { background-color: #f1f5f9 !important; }
    body.theme-light aside button.bg-slate-800 { background-color: #e2e8f0 !important; }
    body.theme-light [class*="bg-black"] { background-color: rgba(0,0,0,0.06) !important; }

    /* Border remapping */
    body.theme-light .border-slate-800 { border-color: #e2e8f0 !important; }
    body.theme-light [class*="border-slate-700"] { border-color: #e2e8f0 !important; }
    body.theme-light [class*="border-slate-600"] { border-color: #cbd5e1 !important; }

    /* Hover states */
    body.theme-light [class*="hover:bg-slate-800"]:hover { background-color: #f1f5f9 !important; }
    body.theme-light [class*="hover:border-slate"]:hover { border-color: #cbd5e1 !important; }
    body.theme-light [class*="hover:text-white"]:hover { color: #0f172a !important; }
    body.theme-light [class*="hover:text-slate"]:hover { color: #334155 !important; }

    /* Colored tinted backgrounds â†’ lighter pastel versions */
    body.theme-light [class*="bg-emerald-950"] { background-color: #ecfdf5 !important; }
    body.theme-light [class*="bg-red-950"] { background-color: #fef2f2 !important; }
    body.theme-light [class*="bg-violet-950"] { background-color: #f5f3ff !important; }
    body.theme-light [class*="bg-amber-950"] { background-color: #fffbeb !important; }
    body.theme-light [class*="bg-blue-950"] { background-color: #eff6ff !important; }

    /* Colored text â†’ darker for readability on light backgrounds */
    body.theme-light .text-emerald-300, body.theme-light .text-emerald-400 { color: #059669 !important; }
    body.theme-light .text-blue-300, body.theme-light .text-blue-400 { color: #2563eb !important; }
    body.theme-light .text-red-300, body.theme-light .text-red-400 { color: #dc2626 !important; }
    body.theme-light .text-violet-300 { color: #7c3aed !important; }
    body.theme-light .text-amber-300, body.theme-light .text-amber-400 { color: #d97706 !important; }
    body.theme-light .text-pink-300 { color: #db2777 !important; }
    body.theme-light .text-sky-300 { color: #0284c7 !important; }
    body.theme-light .text-rose-300 { color: #e11d48 !important; }
    body.theme-light .text-teal-300 { color: #0d9488 !important; }
    body.theme-light .text-fuchsia-300 { color: #c026d3 !important; }
    body.theme-light .text-orange-300 { color: #ea580c !important; }
    body.theme-light .text-cyan-300 { color: #0891b2 !important; }
    body.theme-light .text-lime-300 { color: #65a30d !important; }
    body.theme-light .text-indigo-300 { color: #4f46e5 !important; }
    body.theme-light .text-yellow-300 { color: #ca8a04 !important; }
    body.theme-light .text-green-300 { color: #16a34a !important; }

    /* Rich text classes */
    body.theme-light .rich-text { color: #475569; }
    body.theme-light .rich-text strong, body.theme-light .rich-text b { color: #1e293b; }
    body.theme-light .rich-text .highlight-term { color: #2563eb; }
    body.theme-light .rich-text ul li::before { color: #94a3b8; }
    body.theme-light .vignette-stem { color: #475569; }
    body.theme-light .vignette-stem strong { color: #1e293b; }
    body.theme-light .feedback-text { color: #475569; }
    body.theme-light .feedback-text strong { color: #2563eb; }
    body.theme-light .feedback-text ul li::before { color: #94a3b8; }
    body.theme-light .pearl-text { color: #92400e; opacity: 1; }
    body.theme-light .pearl-text strong { color: #b45309; }

    /* Accent borders â†’ softer for light mode */
    body.theme-light [class*="border-emerald-700"], body.theme-light [class*="border-emerald-800"] { border-color: #a7f3d0 !important; }
    body.theme-light [class*="border-red-700"], body.theme-light [class*="border-red-800"] { border-color: #fecaca !important; }
    body.theme-light [class*="border-violet-800"] { border-color: #ddd6fe !important; }
    body.theme-light [class*="border-amber-700"] { border-color: #fde68a !important; }
    body.theme-light [class*="border-blue-500"] { border-color: #93c5fd !important; }

    /* Forms & inputs */
    body.theme-light select { background: #ffffff !important; border-color: #e2e8f0 !important; color: #334155 !important; }
    body.theme-light input { color: #1e293b !important; }
    body.theme-light input::placeholder { color: #94a3b8 !important; }

    /* Scrollbar */
    body.theme-light .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; }

    /* Dividers */
    body.theme-light [class*="divide-slate"] > :not([hidden]) ~ :not([hidden]) { border-color: #e2e8f0 !important; }

    /* Flashcard override */
    body.theme-light .flashcard-back { border-color: #a7f3d0 !important; }

    /* Theme toggle */
    .theme-toggle { transition: background-color 0.3s ease; }

    /* â”€â”€ Rich text formatting â”€â”€ */
    .rich-text { font-size: 0.9375rem; line-height: 1.8; color: #cbd5e1; }
    .rich-text p { margin-bottom: 0.85em; }
    .rich-text p:last-child { margin-bottom: 0; }
    .rich-text strong, .rich-text b { color: #e2e8f0; font-weight: 600; }
    .rich-text ul { list-style: none; padding-left: 0; margin: 0.6em 0; }
    .rich-text ul li { position: relative; padding-left: 1.2em; margin-bottom: 0.4em; line-height: 1.65; }
    .rich-text ul li::before { content: "â€¢"; position: absolute; left: 0; color: #64748b; font-weight: bold; }
    .rich-text .highlight-term { color: #93c5fd; font-weight: 600; }

    /* â”€â”€ Vignette stem â”€â”€ */
    .vignette-stem { font-size: 0.9375rem; line-height: 1.85; color: #cbd5e1; letter-spacing: 0.005em; }
    .vignette-stem p { margin-bottom: 1em; }
    .vignette-stem p:last-child { margin-bottom: 0; }
    .vignette-stem strong { color: #e2e8f0; font-weight: 600; }

    /* â”€â”€ Feedback text â”€â”€ */
    .feedback-text { font-size: 0.8125rem; line-height: 1.75; color: #cbd5e1; }
    .feedback-text p { margin-bottom: 0.65em; }
    .feedback-text p:last-child { margin-bottom: 0; }
    .feedback-text strong { color: #93c5fd; font-weight: 600; }
    .feedback-text ul { list-style: none; padding-left: 0; margin: 0.5em 0; }
    .feedback-text ul li { position: relative; padding-left: 1.1em; margin-bottom: 0.35em; }
    .feedback-text ul li::before { content: "â€“"; position: absolute; left: 0; color: #64748b; }

    /* â”€â”€ Pearl text â”€â”€ */
    .pearl-text { font-size: 0.875rem; line-height: 1.7; color: #fde68a; opacity: 0.85; }
    .pearl-text strong { color: #fbbf24; font-weight: 600; }
  </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
  <div id="root"></div>
  <script type="text/babel" data-type="module">
    const { useState, useEffect, useCallback, useMemo, useRef, createContext, useContext } = React;

    // â”€â”€â”€ MEDICAL TERM DICTIONARY for auto-bolding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const BOLD_TERMS = [
      'DKA','VSD','ASD','PDA','SVT','RSV','GBS','UTI','ITP','ALL','AML','HUS','HSP',
      'PKU','CAH','SCFE','DDH','NEC','RDS','TTN','MAS','PPHN','SIADH','ARDS','SBP',
      'Kawasaki','intussusception','pyloric stenosis','Hirschsprung','volvulus',
      'malrotation','meconium','bronchiolitis','croup','epiglottitis','pertussis',
      'measles','varicella','anaphylaxis','sepsis','meningitis','osteomyelitis',
      'nephrotic syndrome','glomerulonephritis','febrile seizure','retinoblastoma',
      'leukocoria','phototherapy','Pavlik harness','Barlow','Ortolani','Kernig',
      'Brudzinski','McBurney','Rovsing','psoas sign','obturator sign',
      'strawberry tongue','currant jelly','sausage-shaped mass','target sign',
      'olive-shaped mass','steeple sign','thumbprint sign','boot-shaped heart',
      'egg on a string','rib notching','pneumatosis intestinalis',
      'Kussmaul breathing','fruity breath','cherry-red spot','blue dot sign',
      'slapped cheek','lacy reticular rash','honey-crusted','herald patch',
      'rachitic rosary','widened physis','pencil-in-cup',
      'hyperbilirubinemia','jaundice','phototherapy','exchange transfusion',
      'surfactant','ECMO','IV fluids','normal saline','bolus','epinephrine',
      'albuterol','corticosteroids','antibiotics','IVIG','aspirin',
      'insulin','dextrose','calcium gluconate','sodium bicarbonate','naloxone',
      'palivizumab','amoxicillin','ceftriaxone','vancomycin','acyclovir',
      'CT scan','MRI','ultrasound','X-ray','echocardiography','EEG','LP',
      'lumbar puncture','CBC','BMP','CMP','CRP','ESR','UA','blood culture',
      'CSF analysis','newborn screen','VCUG','DMSA scan',
      'trisomy 21','22q11','Turner syndrome','Klinefelter',
    ];

    // Build a regex from the term list (case-insensitive, word boundary where possible)
    const boldRegex = new RegExp(
      '\\b(' + BOLD_TERMS.map(t => t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|') + ')\\b', 'gi'
    );

    // â”€â”€â”€ FORMATTED TEXT COMPONENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Converts raw strings into structured HTML with paragraphs, bullets, and bold terms
    function FormattedText({ text, className = 'rich-text', boldKeywords = true }) {
      if (!text) return null;

      const processLine = (line) => {
        if (!boldKeywords) return line;
        // Split on bold regex matches
        const parts = [];
        let lastIdx = 0;
        const str = String(line);
        str.replace(boldRegex, (match, p1, offset) => {
          if (offset > lastIdx) parts.push(str.slice(lastIdx, offset));
          parts.push(<strong key={offset}>{match}</strong>);
          lastIdx = offset + match.length;
        });
        if (lastIdx < str.length) parts.push(str.slice(lastIdx));
        return parts.length > 0 ? parts : line;
      };

      // Split into paragraphs on double newlines; detect bullet lines
      const raw = String(text).trim();
      const blocks = raw.split(/\n\s*\n/);

      const elements = blocks.map((block, bi) => {
        const lines = block.trim().split('\n');

        // Check if this block is a bullet list
        const isBulletBlock = lines.every(l => /^\s*[-â€¢â€“*]\s/.test(l.trim()) || l.trim() === '');
        if (isBulletBlock) {
          return (
            <ul key={bi}>
              {lines.filter(l => l.trim()).map((l, li) => (
                <li key={li}>{processLine(l.replace(/^\s*[-â€¢â€“*]\s*/, ''))}</li>
              ))}
            </ul>
          );
        }

        // Check if individual lines within a single block are bullets mixed with text
        const mixedContent = [];
        let currentBullets = [];
        const flushBullets = () => {
          if (currentBullets.length > 0) {
            mixedContent.push(
              <ul key={`ul-${mixedContent.length}`}>
                {currentBullets.map((b, bi2) => <li key={bi2}>{processLine(b)}</li>)}
              </ul>
            );
            currentBullets = [];
          }
        };

        lines.forEach((l, li) => {
          const trimmed = l.trim();
          if (/^\s*[-â€¢â€“*]\s/.test(trimmed)) {
            currentBullets.push(trimmed.replace(/^\s*[-â€¢â€“*]\s*/, ''));
          } else if (trimmed) {
            flushBullets();
            mixedContent.push(<p key={`p-${li}`}>{processLine(trimmed)}</p>);
          }
        });
        flushBullets();

        if (mixedContent.length > 0) return <React.Fragment key={bi}>{mixedContent}</React.Fragment>;

        // Default: simple paragraph
        return <p key={bi}>{processLine(block.trim())}</p>;
      });

      return <div className={className}>{elements}</div>;
    }

    // â”€â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const DOMAIN_META = {
      newborn: { label: 'Newborn / Neonatology', icon: 'ğŸ¼', color: 'bg-pink-500/20 text-pink-300 border-pink-500/30' },
      growth_development: { label: 'Growth & Development', icon: 'ğŸ“', color: 'bg-emerald-500/20 text-emerald-300 border-emerald-500/30' },
      cardiology: { label: 'Cardiology', icon: 'â¤ï¸', color: 'bg-red-500/20 text-red-300 border-red-500/30' },
      pulmonology: { label: 'Pulmonology', icon: 'ğŸ«', color: 'bg-sky-500/20 text-sky-300 border-sky-500/30' },
      gi_nutrition: { label: 'GI / Nutrition', icon: 'ğŸ½ï¸', color: 'bg-amber-500/20 text-amber-300 border-amber-500/30' },
      renal: { label: 'Renal', icon: 'ğŸ«˜', color: 'bg-yellow-500/20 text-yellow-300 border-yellow-500/30' },
      endocrine: { label: 'Endocrine', icon: 'âš—ï¸', color: 'bg-violet-500/20 text-violet-300 border-violet-500/30' },
      infectious_disease: { label: 'Infectious Disease', icon: 'ğŸ¦ ', color: 'bg-lime-500/20 text-lime-300 border-lime-500/30' },
      neurology: { label: 'Neurology', icon: 'ğŸ§ ', color: 'bg-indigo-500/20 text-indigo-300 border-indigo-500/30' },
      heme_onc: { label: 'Hematology / Oncology', icon: 'ğŸ©¸', color: 'bg-rose-950/20 text-rose-300 border-rose-500/30' },
      rheum_immunology: { label: 'Rheumatology / Immunology', icon: 'ğŸ›¡ï¸', color: 'bg-teal-500/20 text-teal-300 border-teal-500/30' },
      genetics_metabolic: { label: 'Genetics / Metabolic', icon: 'ğŸ§¬', color: 'bg-fuchsia-500/20 text-fuchsia-300 border-fuchsia-500/30' },
      adolescent: { label: 'Adolescent Medicine', icon: 'ğŸ§‘â€âš•ï¸', color: 'bg-orange-500/20 text-orange-300 border-orange-500/30' },
      child_abuse_ethics: { label: 'Child Abuse / Ethics', icon: 'âš–ï¸', color: 'bg-slate-500/20 text-slate-300 border-slate-500/30' },
      general: { label: 'General Pediatrics', icon: 'ğŸ¥', color: 'bg-cyan-500/20 text-cyan-300 border-cyan-500/30' },
    };

    const DOMAIN_ORDER = [
      'newborn','growth_development','cardiology','pulmonology','gi_nutrition',
      'renal','endocrine','infectious_disease','neurology','heme_onc',
      'rheum_immunology','genetics_metabolic','adolescent','child_abuse_ethics','general'
    ];

    // â”€â”€â”€ DATA CONTEXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const DataContext = createContext(null);
    function DataProvider({ children }) {
      const [data, setData] = useState({ domains: null, vignettes: null, concepts: null, mnemonics: null, pearls: null, playbook: null, frequency: null, loading: true, error: null });
      useEffect(() => {
        async function load() {
          try {
            const [domains, vignettes, concepts, mnemonics, pearls, playbook, frequency] = await Promise.all([
              fetch('/api/domains').then(r => r.json()), fetch('/api/vignettes').then(r => r.json()),
              fetch('/api/concepts').then(r => r.json()), fetch('/api/mnemonics').then(r => r.json()),
              fetch('/api/pearls').then(r => r.json()), fetch('/api/playbook').then(r => r.json()),
              fetch('/api/frequency').then(r => r.json()),
            ]);
            setData({ domains, vignettes, concepts, mnemonics, pearls, playbook, frequency, loading: false, error: null });
          } catch (e) { setData(prev => ({ ...prev, loading: false, error: e.message })); }
        }
        load();
      }, []);
      return <DataContext.Provider value={data}>{children}</DataContext.Provider>;
    }
    function useData() { return useContext(DataContext); }

    // â”€â”€â”€ PROGRESS CONTEXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const ProgressContext = createContext(null);
    function ProgressProvider({ children }) {
      const [progress, setProgress] = useState(() => {
        try { return JSON.parse(localStorage.getItem('peds_progress') || '{}'); } catch { return {}; }
      });
      const updateProgress = useCallback((key, value) => {
        setProgress(prev => { const next = { ...prev, [key]: value }; localStorage.setItem('peds_progress', JSON.stringify(next)); return next; });
      }, []);
      const markVignetteComplete = useCallback((id, score) => {
        updateProgress(`vig_${id}`, { completed: true, score, timestamp: Date.now() });
      }, [updateProgress]);
      const getFlashcardState = useCallback((id) => {
        return progress[`fc_${id}`] || { interval: 0, ease: 2.5, reps: 0, nextReview: 0 };
      }, [progress]);
      const updateFlashcard = useCallback((id, quality) => {
        const state = progress[`fc_${id}`] || { interval: 0, ease: 2.5, reps: 0, nextReview: 0 };
        let { interval, ease, reps } = state;
        if (quality < 2) { reps = 0; interval = 1; }
        else {
          if (reps === 0) interval = 1; else if (reps === 1) interval = 3;
          else interval = Math.round(interval * ease);
          ease = Math.max(1.3, ease + 0.1 - (4 - quality) * (0.08 + (4 - quality) * 0.02)); reps++;
        }
        updateProgress(`fc_${id}`, { interval, ease, reps, nextReview: Date.now() + interval * 86400000, lastReview: Date.now() });
      }, [progress, updateProgress]);
      return <ProgressContext.Provider value={{ progress, markVignetteComplete, getFlashcardState, updateFlashcard }}>{children}</ProgressContext.Provider>;
    }
    function useProgress() { return useContext(ProgressContext); }

    // â”€â”€â”€ THEME CONTEXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const ThemeContext = createContext(null);
    function ThemeProvider({ children }) {
      const [isDark, setIsDark] = useState(() => {
        try { return localStorage.getItem('peds_theme') !== 'light'; } catch { return true; }
      });
      useEffect(() => {
        document.body.classList.toggle('theme-light', !isDark);
        localStorage.setItem('peds_theme', isDark ? 'dark' : 'light');
      }, [isDark]);
      const toggleTheme = useCallback(() => setIsDark(prev => !prev), []);
      return <ThemeContext.Provider value={{ isDark, toggleTheme }}>{children}</ThemeContext.Provider>;
    }
    function useTheme() { return useContext(ThemeContext); }

    // â”€â”€â”€ THEME TOGGLE SWITCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function ThemeToggle() {
      const { isDark, toggleTheme } = useTheme();
      return (
        <button onClick={toggleTheme}
          className={`relative w-14 h-7 rounded-full transition-colors duration-300 ${isDark ? 'bg-slate-700' : 'bg-sky-200'}`}
          title={isDark ? 'Switch to light mode' : 'Switch to dark mode'}>
          <span className={`absolute top-0.5 w-6 h-6 rounded-full flex items-center justify-center transition-all duration-300 shadow-sm ${isDark ? 'left-0.5 bg-slate-900 text-yellow-300' : 'left-[1.75rem] bg-white text-amber-500'}`}>
            {isDark ? <Icons.Moon /> : <Icons.Sun />}
          </span>
        </button>
      );
    }

    // â”€â”€â”€ ICONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const Icons = {
      Menu: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>,
      X: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
      Search: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
      Home: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>,
      Book: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>,
      Zap: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
      Target: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" strokeWidth={2}/><circle cx="12" cy="12" r="6" strokeWidth={2}/><circle cx="12" cy="12" r="2" strokeWidth={2}/></svg>,
      Cards: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>,
      ChevronRight: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>,
      Check: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
      AlertTriangle: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>,
      Clock: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
      Lightbulb: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>,
      Shuffle: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4h4l3 8-3 8H4m16-16h-4l-3 8 3 8h4" /></svg>,
      Sun: () => <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5" strokeWidth={2}/><path strokeLinecap="round" strokeWidth={2} d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" /></svg>,
      Moon: () => <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" /></svg>,
    };

    // â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function Sidebar({ currentView, setView, sidebarOpen, setSidebarOpen }) {
      const data = useData();
      const stats = data.domains || {};
      const NavBtn = ({ type, label, icon, indent }) => (
        <button onClick={() => setView({ type })}
          className={`w-full flex items-center gap-2.5 px-3 py-2 rounded-md text-[13px] mb-0.5 transition ${currentView.type === type ? 'bg-blue-50 text-blue-700 font-semibold border border-blue-200' : 'text-slate-600 hover:text-slate-800 hover:bg-slate-100'} ${indent ? 'pl-5' : ''}`}>
          <span className="w-5 text-center shrink-0">{icon}</span> {label}
        </button>
      );
      return (
        <aside className={`fixed inset-y-0 left-0 z-40 w-64 bg-white border-r border-slate-200 shadow-sm transform transition-transform duration-200 lg:translate-x-0 lg:static lg:z-auto ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
          <div className="flex items-center justify-between h-14 px-4 border-b border-slate-200">
            <button onClick={() => setView({ type: 'dashboard' })} className="flex items-center gap-2 text-sm font-bold text-slate-800 hover:text-blue-600 transition">
              <span className="text-lg">ğŸ“š</span><span>Peds Shelf Guide</span>
            </button>
            <button onClick={() => setSidebarOpen(false)} className="lg:hidden text-slate-400 hover:text-slate-800"><Icons.X /></button>
          </div>
          <nav className="p-2 overflow-y-auto h-[calc(100vh-3.5rem)]">
            <NavBtn type="dashboard" label="Dashboard" icon={<Icons.Home />} />

            <div className="mt-4 mb-1.5 px-3"><span className="text-[10px] font-bold uppercase tracking-widest text-slate-400">Specialty Hubs</span></div>
            <NavBtn type="id_hub" label="ID & Antibiotics" icon={<span className="text-sm">ğŸ¦ </span>} />
            <NavBtn type="cardio_hub" label="Cardiology" icon={<span className="text-sm">â¤ï¸</span>} />

            <div className="mt-4 mb-1.5 px-3"><span className="text-[10px] font-bold uppercase tracking-widest text-slate-400">Progress</span></div>
            <NavBtn type="performance" label="Performance" icon="ğŸ“Š" />
            <NavBtn type="smart_study" label="Smart Study" icon="ğŸ¯" />
            <NavBtn type="achievements" label="Achievements" icon="ğŸ†" />

            <div className="mt-4 mb-1.5 px-3"><span className="text-[10px] font-bold uppercase tracking-widest text-slate-400">Study Tools</span></div>
            <NavBtn type="rapid_review" label="Rapid Review" icon={<Icons.Zap />} />
            <NavBtn type="nbme_strategy" label="NBME Strategy" icon={<Icons.Target />} />
            <NavBtn type="all_vignettes" label="All Vignettes" icon={<Icons.Book />} />

            <div className="mt-4 mb-1.5 px-3"><span className="text-[10px] font-bold uppercase tracking-widest text-slate-400">Systems</span></div>
            {DOMAIN_ORDER.filter(d => stats[d]).map(domain => {
              const meta = DOMAIN_META[domain]; const stat = stats[domain];
              const isActive = currentView.type === 'domain' && currentView.domain === domain;
              return (
                <button key={domain} onClick={() => setView({ type: 'domain', domain })}
                  className={`w-full flex items-center justify-between px-3 py-2 rounded-md text-[13px] mb-0.5 transition ${isActive ? 'bg-blue-50 text-blue-700 font-semibold border border-blue-200' : 'text-slate-600 hover:text-slate-800 hover:bg-slate-100'}`}>
                  <span className="flex items-center gap-2.5 truncate">
                    <span className="text-sm w-5 text-center">{meta?.icon}</span>
                    <span className="truncate">{meta?.label || domain}</span>
                  </span>
                  <span className="text-[11px] text-slate-400 tabular-nums ml-1">{stat?.count}</span>
                </button>
              );
            })}
          </nav>
        </aside>
      );
    }

    // â”€â”€â”€ TOPBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function TopBar({ setSidebarOpen, searchQuery, setSearchQuery, currentView, setView }) {
      const [showSearch, setShowSearch] = useState(false);
      const [hidden, setHidden] = useState(false);
      const lastScrollY = useRef(0);
      useEffect(() => {
        const onScroll = () => {
          const y = window.scrollY;
          if (y > lastScrollY.current && y > 60) setHidden(true);
          else setHidden(false);
          lastScrollY.current = y;
        };
        window.addEventListener('scroll', onScroll, { passive: true });
        return () => window.removeEventListener('scroll', onScroll);
      }, []);
      return (
        <header className="sticky top-0 z-30 h-14 bg-slate-900/80 backdrop-blur border-b border-slate-800 flex items-center px-5 gap-3" style={{ transform: hidden ? 'translateY(-100%)' : 'translateY(0)', transition: 'transform 0.3s ease' }}>
          <button onClick={() => setSidebarOpen(true)} className="lg:hidden text-slate-400 hover:text-white"><Icons.Menu /></button>
          <Breadcrumb currentView={currentView} setView={setView} />
          <div className="ml-auto flex items-center gap-3">
            <ThemeToggle />
            {showSearch ? (
              <div className="flex items-center gap-2 bg-slate-800 rounded-md px-3 py-1.5">
                <Icons.Search />
                <input autoFocus value={searchQuery} onChange={e => { setSearchQuery(e.target.value); if (e.target.value) setView({ type: 'search', query: e.target.value }); }}
                  placeholder="Search topics, tags..." className="bg-transparent border-none outline-none text-sm text-slate-200 w-52 placeholder-slate-500" />
                <button onClick={() => { setShowSearch(false); setSearchQuery(''); }} className="text-slate-400 hover:text-white"><Icons.X /></button>
              </div>
            ) : (
              <button onClick={() => setShowSearch(true)} className="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md"><Icons.Search /></button>
            )}
          </div>
        </header>
      );
    }

    function Breadcrumb({ currentView, setView }) {
      const parts = [{ label: 'Dashboard', onClick: () => setView({ type: 'dashboard' }) }];
      if (currentView.type === 'domain') parts.push({ label: DOMAIN_META[currentView.domain]?.label || currentView.domain });
      else if (currentView.type === 'vignette') {
        if (currentView.fromDomain) parts.push({ label: DOMAIN_META[currentView.fromDomain]?.label, onClick: () => setView({ type: 'domain', domain: currentView.fromDomain }) });
        parts.push({ label: currentView.title || 'Vignette' });
      } else if (currentView.type === 'id_hub') parts.push({ label: 'ID & Antibiotics Hub' });
      else if (currentView.type === 'cardio_hub') parts.push({ label: 'Cardiology Hub' });
      else if (currentView.type === 'nbme_strategy') parts.push({ label: 'NBME Strategy' });
      else if (currentView.type === 'rapid_review') parts.push({ label: 'Rapid Review' });
      else if (currentView.type === 'all_vignettes') parts.push({ label: 'All Vignettes' });
      else if (currentView.type === 'performance') parts.push({ label: 'Performance Summary' });
      else if (currentView.type === 'smart_study') parts.push({ label: 'Smart Study Session' });
      else if (currentView.type === 'achievements') parts.push({ label: 'Achievements' });
      else if (currentView.type === 'search') parts.push({ label: `Search: "${currentView.query}"` });
      return (
        <div className="flex items-center gap-1.5 text-sm text-slate-400">
          {parts.map((p, i) => (
            <React.Fragment key={i}>
              {i > 0 && <Icons.ChevronRight />}
              {p.onClick ? <button onClick={p.onClick} className="hover:text-slate-300 transition">{p.label}</button> : <span className="text-slate-300 font-medium">{p.label}</span>}
            </React.Fragment>
          ))}
        </div>
      );
    }

    // â”€â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function DashboardView({ setView }) {
      const data = useData(); const { progress } = useProgress();
      if (data.loading) return <LoadingScreen />;
      const stats = data.domains || {};
      const totalVignettes = Object.values(stats).reduce((s, d) => s + (d.count || 0), 0);
      const completedVigs = Object.keys(progress).filter(k => k.startsWith('vig_') && progress[k].completed).length;
      const reviewedCards = Object.keys(progress).filter(k => k.startsWith('fc_')).length;
      return (
        <div className="animate-fadeIn p-8 max-w-6xl mx-auto space-y-10">
          <div className="flex items-start justify-between">
            <div>
              <h1 className="text-2xl font-bold text-slate-800 tracking-tight">Pediatrics Shelf Exam</h1>
              <p className="text-slate-500 mt-2 text-sm leading-relaxed">NBME-aligned study guide â€” <strong className="text-slate-700">164 interactive vignettes</strong> across <strong className="text-slate-700">15 organ-system domains</strong>, with flashcards, rapid review, and shelf strategy.</p>
            </div>
            {(() => { const gs = GameEngine.getState(); const lv = GameEngine.getLevel(gs.totalXP); return (
              <button onClick={() => setView({ type: 'achievements' })} className="flex items-center gap-3 px-4 py-2.5 bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-xl hover:border-amber-400 transition shrink-0">
                <span className="text-2xl">{lv.emoji}</span>
                <div className="text-left">
                  <div className="text-xs font-bold text-amber-800">{lv.name}</div>
                  <div className="text-[10px] text-amber-600">{gs.totalXP} XP{gs.dailyStreak > 0 ? ` Â· ğŸ”¥${gs.dailyStreak}d` : ''}</div>
                </div>
              </button>
            ); })()}
          </div>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <StatCard label="Vignettes" value={totalVignettes} sub={`${completedVigs} completed`} />
            <StatCard label="Concepts" value={(data.concepts || []).length} sub="canonical entries" />
            <StatCard label="Mnemonics" value={(data.mnemonics || []).length} sub="high-yield" />
            <StatCard label="Cards Reviewed" value={reviewedCards} sub="with SRS tracking" />
          </div>

          <div>
            <h2 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Specialty Hubs</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <button onClick={() => setView({ type: 'id_hub' })} className="flex items-start gap-4 p-6 bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-emerald-200 rounded-xl hover:border-emerald-400 hover:shadow-md text-left transition">
                <div className="p-3 bg-emerald-100 rounded-xl shrink-0 text-2xl">ğŸ¦ </div>
                <div>
                  <div className="text-base font-bold text-slate-800 mb-1">ID & Antibiotics Hub</div>
                  <div className="text-sm text-slate-600 leading-relaxed">10 modules â€” bug-drug matching, rash gallery, empiric therapy, vaccines & more</div>
                </div>
              </button>
              <button onClick={() => setView({ type: 'cardio_hub' })} className="flex items-start gap-4 p-6 bg-gradient-to-br from-red-50 to-rose-50 border-2 border-rose-200 rounded-xl hover:border-rose-400 hover:shadow-md text-left transition">
                <div className="p-3 bg-rose-100 rounded-xl shrink-0 text-2xl">â¤ï¸</div>
                <div>
                  <div className="text-base font-bold text-slate-800 mb-1">Cardiology Hub</div>
                  <div className="text-sm text-slate-600 leading-relaxed">11 modules â€” CHD lesions, murmurs, ECGs, fetal circulation, shelf scenarios & more</div>
                </div>
              </button>
            </div>
          </div>

          <div>
            <h2 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Your Progress</h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
              <button onClick={() => setView({ type: 'performance' })} className="flex items-start gap-4 p-5 bg-white border border-slate-200 rounded-lg hover:border-slate-400 hover:shadow-sm text-left transition">
                <div className="p-2.5 bg-violet-100 rounded-lg shrink-0 mt-0.5">ğŸ“Š</div>
                <div><div className="text-sm font-semibold text-slate-800 mb-1">Performance Summary</div><div className="text-xs text-slate-500 leading-relaxed">View overall scores and weak areas across all modules</div></div>
              </button>
              <button onClick={() => setView({ type: 'smart_study' })} className="flex items-start gap-4 p-5 bg-white border border-slate-200 rounded-lg hover:border-slate-400 hover:shadow-sm text-left transition">
                <div className="p-2.5 bg-pink-100 rounded-lg shrink-0 mt-0.5">ğŸ¯</div>
                <div><div className="text-sm font-semibold text-slate-800 mb-1">Smart Study Session</div><div className="text-xs text-slate-500 leading-relaxed">Personalized quiz focusing on your weaknesses</div></div>
              </button>
              <button onClick={() => setView({ type: 'achievements' })} className="flex items-start gap-4 p-5 bg-gradient-to-br from-amber-50 to-orange-50 border-2 border-amber-200 rounded-lg hover:border-amber-400 hover:shadow-sm text-left transition">
                <div className="p-2.5 bg-amber-100 rounded-lg shrink-0 mt-0.5">ğŸ†</div>
                <div><div className="text-sm font-semibold text-amber-800 mb-1">Achievements</div><div className="text-xs text-amber-600 leading-relaxed">XP, levels, badges, streaks & mastery</div></div>
              </button>
            </div>
          </div>

          <div>
            <h2 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Study Tools</h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              {[
                { type: 'rapid_review', icon: <Icons.Zap />, bg: 'bg-amber-100', title: 'Rapid Review', desc: 'Mnemonics, pearls, and one-liners for last-week cramming' },
                { type: 'all_vignettes', icon: <Icons.Book />, bg: 'bg-blue-100', title: 'Practice Vignettes', desc: 'Shelf-style clinical stems with branching decisions' },
                { type: 'nbme_strategy', icon: <Icons.Target />, bg: 'bg-emerald-100', title: 'NBME Strategy', desc: 'Task patterns, common traps, and timing optimization' },
              ].map(a => (
                <button key={a.type} onClick={() => setView({ type: a.type })} className="flex items-start gap-4 p-5 bg-white border border-slate-200 rounded-lg hover:border-slate-400 hover:shadow-sm text-left transition">
                  <div className={`p-2.5 ${a.bg} rounded-lg shrink-0 mt-0.5`}>{a.icon}</div>
                  <div><div className="text-sm font-semibold text-slate-800 mb-1">{a.title}</div><div className="text-xs text-slate-500 leading-relaxed">{a.desc}</div></div>
                </button>
              ))}
            </div>
          </div>

          <div>
            <h2 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Study by System</h2>
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              {DOMAIN_ORDER.filter(d => stats[d]).map(domain => {
                const meta = DOMAIN_META[domain]; const stat = stats[domain];
                return (
                  <button key={domain} onClick={() => setView({ type: 'domain', domain })}
                    className={`flex items-start gap-3.5 p-5 rounded-lg border text-left hover:brightness-110 transition ${meta.color}`}>
                    <span className="text-2xl mt-0.5">{meta.icon}</span>
                    <div className="flex-1 min-w-0">
                      <div className="font-semibold text-sm">{meta.label}</div>
                      <div className="text-xs opacity-70 mt-1">{stat.count} vignettes</div>
                      <div className="flex flex-wrap gap-1.5 mt-2.5">
                        {Object.entries(stat.difficulties || {}).map(([d, n]) => (
                          <span key={d} className="text-[10px] px-2 py-0.5 rounded-full bg-black/10 tabular-nums">{d}: {n}</span>
                        ))}
                      </div>
                    </div>
                  </button>
                );
              })}
            </div>
          </div>
          {data.frequency && (
            <div>
              <h2 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">NBME High-Frequency Topics</h2>
              <div className="bg-white border border-slate-200 rounded-lg p-6 shadow-sm">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  {Object.entries(data.frequency || {}).slice(0, 6).map(([section, concepts]) => (
                    <div key={section}>
                      <div className="text-xs font-bold text-slate-700 mb-2 pb-1 border-b border-slate-200">{section}</div>
                      <div className="space-y-1.5">
                        {(Array.isArray(concepts) ? concepts : []).slice(0, 4).map((c, i) => (
                          <div key={i} className="text-xs text-slate-600 flex justify-between items-center">
                            <span className="truncate pr-2">{c.concept || c.name || c}</span>
                            {c.frequency && <span className="text-slate-500 font-mono text-[10px] shrink-0 bg-slate-100 px-1.5 py-0.5 rounded">{c.frequency}x</span>}
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function StatCard({ label, value, sub }) {
      return (
        <div className="bg-white border border-slate-200 rounded-lg p-5 shadow-sm">
          <div className="text-3xl font-bold text-slate-800 tabular-nums">{value}</div>
          <div className="text-sm text-slate-700 mt-1 font-medium">{label}</div>
          <div className="text-xs text-slate-500 mt-0.5">{sub}</div>
        </div>
      );
    }

    // â”€â”€â”€ DOMAIN VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function DomainView({ domain, setView }) {
      const data = useData(); const [tab, setTab] = useState('vignettes');
      if (data.loading) return <LoadingScreen />;
      const meta = DOMAIN_META[domain]; const vignettes = (data.vignettes || {})[domain] || [];
      const domainConcepts = (data.concepts || []).filter(c => {
        const cd = (c.domain || '').toLowerCase();
        return cd.includes(domain.replace('_', '')) || cd.includes(domain.split('_')[0]);
      });
      const tabs = [
        { id: 'vignettes', label: 'Vignettes', icon: <Icons.Book />, count: vignettes.length },
        { id: 'concepts', label: 'Concepts', icon: <Icons.Lightbulb />, count: domainConcepts.length },
        { id: 'flashcards', label: 'Flashcards', icon: <Icons.Cards />, count: domainConcepts.length },
        { id: 'rapid', label: 'Rapid Review', icon: <Icons.Zap /> },
      ];
      return (
        <div className="animate-fadeIn p-8 max-w-5xl mx-auto">
          <div className="flex items-center gap-4 mb-8">
            <span className="text-4xl">{meta?.icon}</span>
            <div>
              <h1 className="text-2xl font-bold text-white tracking-tight">{meta?.label}</h1>
              <p className="text-sm text-slate-400 mt-1">{vignettes.length} vignettes &middot; {domainConcepts.length} concepts</p>
            </div>
          </div>
          <div className="flex gap-1 mb-8 border-b border-slate-700/50 pb-px">
            {tabs.map(t => (
              <button key={t.id} onClick={() => setTab(t.id)}
                className={`flex items-center gap-2 px-5 py-2.5 text-sm rounded-t-md border-b-2 transition ${tab === t.id ? 'border-blue-400 text-white bg-slate-800/40 font-medium' : 'border-transparent text-slate-400 hover:text-slate-300'}`}>
                {t.icon} {t.label} {t.count != null && <span className="text-xs text-slate-600 tabular-nums">({t.count})</span>}
              </button>
            ))}
          </div>
          {tab === 'vignettes' && <VignetteList vignettes={vignettes} domain={domain} setView={setView} />}
          {tab === 'concepts' && <ConceptList concepts={domainConcepts} />}
          {tab === 'flashcards' && <FlashcardDeck concepts={domainConcepts} domain={domain} />}
          {tab === 'rapid' && <DomainRapidReview domain={domain} />}
        </div>
      );
    }

    // â”€â”€â”€ VIGNETTE LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function VignetteList({ vignettes, domain, setView }) {
      const { progress } = useProgress(); const [filter, setFilter] = useState('all');
      const filtered = filter === 'all' ? vignettes : filter === 'completed' ? vignettes.filter(v => progress[`vig_${v.id}`]?.completed) : vignettes.filter(v => !progress[`vig_${v.id}`]?.completed);
      return (
        <div>
          <div className="flex gap-2 mb-5">
            {['all', 'incomplete', 'completed'].map(f => (
              <button key={f} onClick={() => setFilter(f)} className={`px-3.5 py-1.5 text-xs rounded-full font-medium transition ${filter === f ? 'bg-blue-500/20 text-blue-300 border border-blue-500/30' : 'bg-slate-800/60 text-slate-400 border border-slate-700/50 hover:text-slate-200'}`}>
                {f === 'all' ? `All (${vignettes.length})` : f === 'completed' ? `Done (${vignettes.filter(v => progress[`vig_${v.id}`]?.completed).length})` : `To Do (${vignettes.filter(v => !progress[`vig_${v.id}`]?.completed).length})`}
              </button>
            ))}
          </div>
          <div className="space-y-3">
            {filtered.map(v => {
              const done = progress[`vig_${v.id}`]?.completed;
              return (
                <button key={v.id} onClick={() => setView({ type: 'vignette', vignetteId: v.id, domain: v.domain, fromDomain: domain, title: v.title })}
                  className={`w-full text-left p-5 rounded-lg border transition hover:border-slate-600 ${done ? 'bg-emerald-950/20 border-emerald-800/30' : 'bg-slate-50 border-slate-300 hover:bg-slate-800/60'}`}>
                  <div className="flex items-start justify-between gap-3">
                    <div className="flex-1">
                      <div className="flex items-center gap-2.5 mb-2">
                        {done && <span className="text-emerald-400"><Icons.Check /></span>}
                        <span className="font-semibold text-sm text-white">{v.title}</span>
                        <span className={`text-[10px] px-2 py-0.5 rounded-full font-medium ${v.difficulty === 'advanced' ? 'bg-red-500/20 text-red-300' : v.difficulty === 'introductory' ? 'bg-green-500/20 text-green-300' : 'bg-blue-500/20 text-blue-300'}`}>{v.difficulty}</span>
                      </div>
                      <div className="flex flex-wrap gap-1.5">
                        {(v.tags || []).slice(0, 5).map((t, i) => <span key={i} className="text-[11px] px-2 py-0.5 bg-slate-700/40 text-slate-400 rounded">{t}</span>)}
                      </div>
                    </div>
                    <div className="text-slate-400 flex items-center gap-1.5 text-xs shrink-0"><Icons.Clock /> {v.estimatedMinutes}m</div>
                  </div>
                </button>
              );
            })}
          </div>
        </div>
      );
    }

    // â”€â”€â”€ ALL VIGNETTES VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function AllVignettesView({ setView }) {
      const data = useData(); const [filterDomain, setFilterDomain] = useState('all'); const [filterDiff, setFilterDiff] = useState('all');
      if (data.loading) return <LoadingScreen />;
      const allVigs = []; Object.entries(data.vignettes || {}).forEach(([domain, vigs]) => vigs.forEach(v => allVigs.push({ ...v, domain })));
      const filtered = allVigs.filter(v => (filterDomain === 'all' || v.domain === filterDomain) && (filterDiff === 'all' || v.difficulty === filterDiff));
      return (
        <div className="animate-fadeIn p-8 max-w-5xl mx-auto">
          <h1 className="text-2xl font-bold text-white mb-2 tracking-tight">All Clinical Vignettes</h1>
          <p className="text-sm text-slate-400 mb-6">{allVigs.length} shelf-style cases across all pediatric domains</p>
          <div className="flex flex-wrap gap-3 mb-6">
            <select value={filterDomain} onChange={e => setFilterDomain(e.target.value)} className="bg-slate-800 border border-slate-700 rounded-md px-3 py-2 text-sm text-slate-300 focus:border-slate-500 outline-none">
              <option value="all">All Domains</option>
              {DOMAIN_ORDER.filter(d => (data.vignettes || {})[d]).map(d => <option key={d} value={d}>{DOMAIN_META[d]?.label}</option>)}
            </select>
            <select value={filterDiff} onChange={e => setFilterDiff(e.target.value)} className="bg-slate-800 border border-slate-700 rounded-md px-3 py-2 text-sm text-slate-300 focus:border-slate-500 outline-none">
              <option value="all">All Difficulties</option>
              <option value="introductory">Introductory</option><option value="intermediate">Intermediate</option><option value="advanced">Advanced</option>
            </select>
            <span className="text-xs text-slate-400 self-center ml-1 tabular-nums">{filtered.length} results</span>
          </div>
          <VignetteList vignettes={filtered} domain="all" setView={setView} />
        </div>
      );
    }

    // â”€â”€â”€ VIGNETTE PLAYER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function VignettePlayer({ vignetteId, domain, setView, fromDomain }) {
      const data = useData(); const { markVignetteComplete } = useProgress();
      const [currentNodeId, setCurrentNodeId] = useState(null);
      const [selectedChoice, setSelectedChoice] = useState(null);
      const [showFeedback, setShowFeedback] = useState(false);
      const [history, setHistory] = useState([]); const [score, setScore] = useState({ correct: 0, total: 0 });

      useEffect(() => {
        if (data.loading || !currentNodeId) return;
        let vignette = null;
        for (const [d, vigs] of Object.entries(data.vignettes || {})) { const found = vigs.find(v => v.id === vignetteId); if (found) { vignette = found; break; } }
        if (!vignette) return;
        const node = vignette.nodes[currentNodeId];
        if (!node) {
          markVignetteComplete(vignetteId, score);
        }
      }, [currentNodeId, vignetteId, score, markVignetteComplete, data.loading, data.vignettes]);

      if (data.loading) return <LoadingScreen />;
      let vignette = null;
      for (const [d, vigs] of Object.entries(data.vignettes || {})) { const found = vigs.find(v => v.id === vignetteId); if (found) { vignette = found; break; } }
      if (!vignette) return <div className="p-8 text-slate-400">Vignette not found.</div>;
      const rootId = vignette.rootNodeId || 'node-1'; const activeNodeId = currentNodeId || rootId; const node = vignette.nodes[activeNodeId];

      if (!node) {
        const isGood = activeNodeId?.includes('good') || activeNodeId?.includes('optimal');
        return (
          <div className="animate-fadeIn p-8 max-w-3xl mx-auto">
            <div className={`p-8 rounded-xl border ${isGood ? 'bg-emerald-950/30 border-emerald-700/40' : 'bg-red-950/30 border-red-700/40'}`}>
              <h2 className="text-xl font-bold text-white mb-3">{isGood ? 'Excellent clinical reasoning!' : 'Review needed'}</h2>
              <p className="text-sm text-slate-300 mb-6">Score: <strong className="text-white">{score.correct}/{score.total}</strong> optimal choices</p>
              <div className="space-y-3 mb-6">
                {history.map((h, i) => (
                  <div key={i} className="flex items-start gap-3 text-sm p-3 bg-slate-900/40 rounded-lg">
                    <span className={`shrink-0 mt-0.5 text-lg ${h.wasOptimal ? 'text-emerald-400' : 'text-red-400'}`}>{h.wasOptimal ? 'âœ“' : 'âœ—'}</span>
                    <div>
                      <div className="text-slate-300 leading-relaxed">{h.question?.substring(0, 100)}{h.question?.length > 100 ? '...' : ''}</div>
                      <div className="text-slate-400 text-xs mt-1">Your answer: <span className="text-slate-400">{h.choiceText?.substring(0, 60)}</span></div>
                    </div>
                  </div>
                ))}
              </div>
              <div className="flex gap-3">
                <button onClick={() => { setCurrentNodeId(null); setSelectedChoice(null); setShowFeedback(false); setHistory([]); setScore({ correct: 0, total: 0 }); }}
                  className="px-5 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-white font-medium transition">Retry</button>
                <button onClick={() => setView({ type: 'domain', domain: fromDomain || domain })}
                  className="px-5 py-2.5 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm text-white font-medium transition">Back to Domain</button>
              </div>
            </div>
          </div>
        );
      }

      const handleSelect = (choice) => {
        setSelectedChoice(choice); setShowFeedback(true);
        setScore(prev => ({ correct: prev.correct + (choice.isOptimal ? 1 : 0), total: prev.total + 1 }));
        setHistory(prev => [...prev, { question: node.question, choiceText: choice.text, wasOptimal: choice.isOptimal }]);
      };
      const handleNext = () => {
        if (selectedChoice?.nextNodeId) setCurrentNodeId(selectedChoice.nextNodeId);
        else setCurrentNodeId('node-outcome-good');
        setSelectedChoice(null); setShowFeedback(false);
      };

      return (
        <div className="animate-fadeIn p-8 max-w-3xl mx-auto space-y-7">
          <div className="flex items-center justify-between">
            <h1 className="text-xl font-bold text-white tracking-tight">{vignette.title}</h1>
            <span className="text-[10px] text-slate-600 font-mono bg-slate-800/50 px-2 py-1 rounded">{activeNodeId}</span>
          </div>

          {/* Clinical stem â€” NBME format: stem + question only, no teaching content on root */}
          <div className="bg-white border border-slate-300 rounded-xl p-7">
            {activeNodeId === rootId && <FormattedText text={vignette.stem} className="vignette-stem" />}
            {activeNodeId !== rootId && node.content && <FormattedText text={node.content} className="vignette-stem" />}
            <div className={`mt-5 pt-4 border-t border-slate-300`}>
              <p className="text-red-700 font-semibold text-[15px] leading-relaxed">{node.question}</p>
            </div>
          </div>

          {/* Choices */}
          <div className="space-y-3">
            {(node.choices || []).map((choice, i) => {
              const letter = String.fromCharCode(65 + i);
              let borderClass = 'border-slate-300 hover:border-slate-500/60 bg-slate-800/20';
              if (showFeedback) {
                if (choice.isOptimal) borderClass = 'border-emerald-500/60 bg-emerald-950/30';
                else if (choice.id === selectedChoice?.id && !choice.isOptimal) borderClass = 'border-red-500/60 bg-red-950/30';
                else borderClass = 'border-slate-300 bg-slate-900/20 opacity-50';
              }
              return (
                <button key={choice.id} onClick={() => !showFeedback && handleSelect(choice)} disabled={showFeedback}
                  className={`choice-btn w-full text-left p-5 rounded-xl border transition ${borderClass}`}>
                  <div className="flex items-start gap-3.5">
                    <span className={`text-xs font-mono font-bold mt-0.5 w-6 h-6 rounded-full flex items-center justify-center shrink-0 ${showFeedback && choice.isOptimal ? 'bg-emerald-500/30 text-emerald-300' : showFeedback && choice.id === selectedChoice?.id ? 'bg-red-500/30 text-red-300' : 'bg-slate-700/50 text-slate-400'}`}>{letter}</span>
                    <span className="text-sm text-slate-200 leading-relaxed">{choice.text}</span>
                  </div>
                  {showFeedback && (choice.id === selectedChoice?.id || choice.isOptimal) && choice.feedback && (
                    <div className={`mt-4 ml-10 p-4 rounded-lg border-l-[3px] ${choice.isOptimal ? 'bg-emerald-950/20 border-emerald-500/50' : 'bg-slate-900/50 border-blue-500/40'}`}>
                      <div className="text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-2">
                        {choice.isOptimal ? (choice.id === selectedChoice?.id ? 'Correct â€” Explanation' : 'Best Answer â€” Explanation') : 'Why This Is Incorrect'}
                      </div>
                      <FormattedText text={choice.feedback} className="feedback-text" />
                    </div>
                  )}
                </button>
              );
            })}
          </div>

          {/* Teaching content â€” shown only AFTER answering on root node */}
          {showFeedback && activeNodeId === rootId && node.content && (
            <div className="bg-blue-50 border border-blue-200 rounded-xl p-6">
              <div className="text-[10px] font-bold uppercase tracking-wider text-blue-600 mb-3">Key Teaching Points</div>
              <FormattedText text={node.content} className="vignette-stem" />
            </div>
          )}

          {/* Clinical pearl */}
          {showFeedback && node.clinicalPearl && (
            <div className="bg-amber-50 border border-amber-200 rounded-xl p-6">
              <div className="flex items-center gap-2 text-amber-700 text-xs font-bold uppercase tracking-wider mb-3">
                <Icons.Lightbulb /> Clinical Pearl
              </div>
              <FormattedText text={node.clinicalPearl} className="pearl-text" />
            </div>
          )}

          {showFeedback && (
            <button onClick={handleNext} className="w-full py-3.5 bg-blue-600 hover:bg-blue-500 text-white rounded-xl text-sm font-semibold transition">
              Continue to Next Step â†’
            </button>
          )}
        </div>
      );
    }

    // â”€â”€â”€ CONCEPT LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function ConceptList({ concepts }) {
      const intentColors = {
        DX: 'bg-blue-500/20 text-blue-300 border-blue-500/20', MGMT: 'bg-emerald-500/20 text-emerald-300 border-emerald-500/20',
        MECH: 'bg-violet-500/20 text-violet-300 border-violet-500/20', DISTINGUISH: 'bg-amber-500/20 text-amber-300 border-amber-500/20',
        NUMBERS: 'bg-pink-500/20 text-pink-300 border-pink-500/20', SCREENING: 'bg-cyan-500/20 text-cyan-300 border-cyan-500/20',
        ETHICS: 'bg-slate-500/20 text-slate-300 border-slate-500/20',
      };
      const intentDescriptions = {
        DX: 'Recognize from presentation', MGMT: 'Select next step', MECH: 'Explain pathophysiology',
        DISTINGUISH: 'Differentiate entities', NUMBERS: 'Recall thresholds', SCREENING: 'Preventive care', ETHICS: 'Ethical reasoning',
      };
      if (concepts.length === 0) return <p className="text-slate-400 text-sm py-4">No concepts mapped to this domain yet.</p>;
      // Group by intent
      const grouped = {};
      concepts.forEach(c => { const k = c.intent || 'OTHER'; if (!grouped[k]) grouped[k] = []; grouped[k].push(c); });
      return (
        <div className="space-y-8">
          {Object.entries(grouped).map(([intent, list]) => (
            <div key={intent}>
              <div className="flex items-center gap-3 mb-4">
                <span className={`text-xs px-2.5 py-1 rounded-md font-bold border ${intentColors[intent] || 'bg-slate-700 text-slate-300 border-slate-600'}`}>{intent}</span>
                <span className="text-xs text-slate-400">{intentDescriptions[intent] || ''} &middot; {list.length} concepts</span>
              </div>
              <div className="space-y-2.5">
                {list.map((c, i) => (
                  <div key={i} className="p-4 bg-slate-800/30 border border-slate-300 rounded-lg hover:bg-slate-800/50 transition">
                    <div className="flex items-baseline gap-2.5">
                      <span className="text-sm font-semibold text-white">{c.condition}</span>
                      {c.id && <span className="text-[10px] text-slate-600 font-mono">{c.id}</span>}
                    </div>
                    {c.sourceCards && c.sourceCards.length > 0 && (
                      <div className="text-[11px] text-slate-400 mt-2">Source cards: <span className="font-mono text-slate-600">{c.sourceCards.join(', ')}</span></div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>
      );
    }

    // â”€â”€â”€ FLASHCARD DECK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function FlashcardDeck({ concepts, domain }) {
      const { getFlashcardState, updateFlashcard } = useProgress();
      const [currentIdx, setCurrentIdx] = useState(0); const [flipped, setFlipped] = useState(false); const [mode, setMode] = useState('sequential');
      const cards = useMemo(() => {
        const c = concepts.map(concept => ({
          id: concept.id || `fc-${concept.name}`, front: concept.intent === 'DX' ? 'What diagnosis presents with this pattern?' : concept.intent === 'MGMT' ? 'What is the next best step in management?' : concept.intent === 'MECH' ? 'What is the underlying mechanism?' : 'What is the key concept?',
          frontContext: concept.name, back: concept.name,
          backDetail: `Intent: ${concept.intent}\nDomain: ${concept.domain || domain}\n${concept.sourceCards?.length ? 'Source: ' + concept.sourceCards.join(', ') : ''}`,
          intent: concept.intent,
        }));
        if (mode === 'shuffle') return [...c].sort(() => Math.random() - 0.5); return c;
      }, [concepts, domain, mode]);
      if (cards.length === 0) return <p className="text-slate-400 text-sm py-4">No flashcards available for this domain.</p>;
      const card = cards[currentIdx]; const state = getFlashcardState(card.id);
      const handleRate = (quality) => { updateFlashcard(card.id, quality); setFlipped(false); setCurrentIdx(prev => (prev + 1) % cards.length); };
      return (
        <div className="max-w-xl mx-auto py-4">
          <div className="flex items-center justify-between mb-6">
            <span className="text-sm text-slate-400 font-medium tabular-nums">{currentIdx + 1} / {cards.length}</span>
            <button onClick={() => { setMode(mode === 'sequential' ? 'shuffle' : 'sequential'); setCurrentIdx(0); }}
              className="flex items-center gap-1.5 px-3.5 py-1.5 text-xs bg-slate-800 border border-slate-700 rounded-md text-slate-300 hover:text-white font-medium transition">
              <Icons.Shuffle /> {mode === 'shuffle' ? 'Sequential' : 'Shuffle'}
            </button>
          </div>
          <div className="flashcard-flip h-72 cursor-pointer" onClick={() => setFlipped(!flipped)}>
            <div className={`flashcard-inner relative w-full h-full ${flipped ? 'flipped' : ''}`}>
              <div className="flashcard-front absolute inset-0 bg-slate-800 border border-slate-700 rounded-xl p-8 flex flex-col items-center justify-center">
                <span className="text-[10px] font-bold uppercase tracking-widest text-slate-600 mb-3">{card.intent}</span>
                <p className="text-xl text-white font-semibold text-center leading-snug mb-3">{card.frontContext}</p>
                <p className="text-sm text-slate-400 text-center leading-relaxed">{card.front}</p>
                <span className="text-[10px] text-slate-700 mt-6">tap to flip</span>
              </div>
              <div className="flashcard-back absolute inset-0 bg-slate-800 border-2 border-emerald-700/40 rounded-xl p-8 flex flex-col items-center justify-center">
                <p className="text-xl text-emerald-300 font-semibold text-center mb-4">{card.back}</p>
                <pre className="text-xs text-slate-400 text-center whitespace-pre-wrap leading-relaxed">{card.backDetail}</pre>
              </div>
            </div>
          </div>
          {flipped && (
            <div className="flex gap-3 mt-6 justify-center">
              {[{ q: 1, label: 'Again', color: 'bg-red-600/80 hover:bg-red-600' }, { q: 2, label: 'Hard', color: 'bg-orange-600/80 hover:bg-orange-600' }, { q: 3, label: 'Good', color: 'bg-emerald-600/80 hover:bg-emerald-600' }, { q: 4, label: 'Easy', color: 'bg-blue-600/80 hover:bg-blue-600' }].map(b => (
                <button key={b.q} onClick={() => handleRate(b.q)} className={`px-5 py-2.5 ${b.color} rounded-lg text-sm text-white font-medium transition`}>{b.label}</button>
              ))}
            </div>
          )}
          {state.reps > 0 && (
            <div className="text-center mt-4 text-xs text-slate-400 tabular-nums">
              Interval: <strong className="text-slate-400">{state.interval}d</strong> &middot; Ease: <strong className="text-slate-400">{state.ease?.toFixed(2)}</strong> &middot; Reps: <strong className="text-slate-400">{state.reps}</strong>
            </div>
          )}
        </div>
      );
    }

    // â”€â”€â”€ DOMAIN RAPID REVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function DomainRapidReview({ domain }) {
      const data = useData();
      const mnemonics = (data.mnemonics || []).filter(m => { const md = (m.domain || m.meaning || '').toLowerCase(); return md.includes(domain.replace('_', ' ')) || md.includes(domain.split('_')[0]); });
      const pearls = (data.pearls || []).filter(p => { const pd = (p.domain || p.text || '').toLowerCase(); return pd.includes(domain.replace('_', ' ')) || pd.includes(domain.split('_')[0]); });
      const vignettes = (data.vignettes || {})[domain] || [];
      const oneLiners = vignettes.map(v => ({ clue: (v.tags || []).slice(0, 2).join(' + '), diagnosis: v.title })).filter(o => o.clue);
      return (
        <div className="space-y-8">
          {oneLiners.length > 0 && (
            <div>
              <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2"><Icons.Zap /> If You See â†’ Think</h3>
              <div className="bg-slate-50 border border-slate-300 rounded-xl overflow-hidden divide-y divide-slate-700/30">
                {oneLiners.map((o, i) => (
                  <div key={i} className="flex items-center px-5 py-3.5 text-sm hover:bg-slate-100 transition">
                    <span className="text-amber-300 flex-1 leading-relaxed">{o.clue}</span>
                    <span className="text-slate-600 mx-3 text-lg">â†’</span>
                    <span className="text-white font-semibold flex-1">{o.diagnosis}</span>
                  </div>
                ))}
              </div>
            </div>
          )}
          {mnemonics.length > 0 && (
            <div>
              <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Mnemonics</h3>
              <div className="space-y-3">
                {mnemonics.map((m, i) => (
                  <div key={i} className="p-5 bg-violet-950/20 border border-violet-800/25 rounded-xl">
                    <div className="text-base font-mono font-bold text-violet-300 tracking-wide">{m.mnemonic}</div>
                    <div className="text-sm text-slate-400 mt-2 leading-relaxed">{m.meaning}</div>
                  </div>
                ))}
              </div>
            </div>
          )}
          {pearls.length > 0 && (
            <div>
              <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Clinical Pearls</h3>
              <div className="space-y-2">
                {pearls.map((p, i) => (
                  <div key={i} className="flex items-start gap-3 p-4 bg-slate-100 border border-slate-300 rounded-lg">
                    <span className="text-amber-400 mt-0.5 shrink-0 text-base">ğŸ’¡</span>
                    <FormattedText text={p.text} className="rich-text text-sm" />
                  </div>
                ))}
              </div>
            </div>
          )}
          {mnemonics.length === 0 && pearls.length === 0 && oneLiners.length === 0 && (
            <div className="text-center py-8"><p className="text-slate-400 text-sm">No rapid review content specifically tagged for this domain.</p><p className="text-slate-600 text-xs mt-1">Check the global Rapid Review section in the sidebar.</p></div>
          )}
        </div>
      );
    }

    // â”€â”€â”€ GLOBAL RAPID REVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function RapidReviewView() {
      const data = useData(); const [tab, setTab] = useState('oneliners');
      if (data.loading) return <LoadingScreen />;
      const allVigs = []; Object.values(data.vignettes || {}).forEach(vigs => vigs.forEach(v => allVigs.push(v)));
      const oneLiners = allVigs.map(v => ({ clue: (v.tags || []).slice(0, 2).join(' + '), diagnosis: v.title, domain: v.domain })).filter(o => o.clue);
      return (
        <div className="animate-fadeIn p-8 max-w-4xl mx-auto">
          <h1 className="text-2xl font-bold text-white mb-2 tracking-tight">Rapid Review</h1>
          <p className="text-sm text-slate-400 mb-8 leading-relaxed">Last-week cram mode: <strong className="text-slate-700">mnemonics</strong>, <strong className="text-slate-700">one-liners</strong>, and <strong className="text-slate-700">clinical pearls</strong> for rapid pattern recognition.</p>
          <div className="flex gap-1 mb-8 border-b border-slate-300 pb-px">
            {[
              { id: 'oneliners', label: `One-Liners (${oneLiners.length})` },
              { id: 'mnemonics', label: `Mnemonics (${(data.mnemonics || []).length})` },
              { id: 'pearls', label: `Pearls (${(data.pearls || []).length})` },
            ].map(t => (
              <button key={t.id} onClick={() => setTab(t.id)}
                className={`px-5 py-2.5 text-sm rounded-t-md border-b-2 transition font-medium ${tab === t.id ? 'border-amber-400 text-white' : 'border-transparent text-slate-400 hover:text-slate-300'}`}>{t.label}</button>
            ))}
          </div>
          {tab === 'oneliners' && (
            <div className="bg-slate-50 border border-slate-300 rounded-xl overflow-hidden divide-y divide-slate-700/20">
              {oneLiners.map((o, i) => (
                <div key={i} className="flex items-center px-5 py-3.5 text-sm hover:bg-slate-100 transition">
                  <span className="w-8 text-xs text-slate-600 tabular-nums shrink-0">{i + 1}</span>
                  <span className="text-amber-300 flex-1 leading-relaxed">{o.clue}</span>
                  <span className="text-slate-600 mx-3 text-lg">â†’</span>
                  <span className="text-white font-semibold flex-1">{o.diagnosis}</span>
                  <span className="text-sm text-slate-700 ml-2 shrink-0">{DOMAIN_META[o.domain]?.icon}</span>
                </div>
              ))}
            </div>
          )}
          {tab === 'mnemonics' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {(data.mnemonics || []).map((m, i) => (
                <div key={i} className="p-5 bg-violet-950/20 border border-violet-800/25 rounded-xl">
                  <div className="text-base font-mono font-bold text-violet-300 tracking-wide mb-2">{m.mnemonic}</div>
                  <div className="text-sm text-slate-400 leading-relaxed">{m.meaning}</div>
                  <div className="text-[10px] text-slate-600 mt-3 uppercase tracking-wider">{m.source}</div>
                </div>
              ))}
            </div>
          )}
          {tab === 'pearls' && (
            <div className="space-y-2.5">
              {(data.pearls || []).map((p, i) => (
                <div key={i} className="flex items-start gap-3.5 p-4 bg-slate-100 border border-slate-300 rounded-lg">
                  <span className="text-amber-400 mt-0.5 shrink-0 text-base">ğŸ’¡</span>
                  <div className="flex-1">
                    <FormattedText text={p.text} className="rich-text text-sm" />
                    {p.source && <div className="text-[10px] text-slate-600 mt-2 uppercase tracking-wider">{p.source}</div>}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    // â”€â”€â”€ NBME STRATEGY VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function NBMEStrategyView() {
      const data = useData(); if (data.loading) return <LoadingScreen />;
      const playbook = data.playbook || {}; const taskTypes = playbook.taskTypes || []; const traps = playbook.commonTraps || []; const triage = playbook.triageAlgorithm || {};
      return (
        <div className="animate-fadeIn p-8 max-w-4xl mx-auto space-y-10">
          <div>
            <h1 className="text-2xl font-bold text-white tracking-tight">NBME Strategy Playbook</h1>
            <p className="text-sm text-slate-400 mt-2 leading-relaxed">Master the <strong className="text-slate-700">question patterns</strong>, avoid the <strong className="text-slate-700">traps</strong>, and optimize your <strong className="text-slate-700">timing</strong> for the Pediatrics Shelf.</p>
          </div>
          {triage.steps && (
            <div className="bg-slate-800/30 border border-emerald-700/25 rounded-xl p-7">
              <h2 className="text-sm font-bold text-emerald-300 mb-5 uppercase tracking-wider">Clinical Triage Algorithm</h2>
              <div className="space-y-4">
                {triage.steps.map((step, i) => (
                  <div key={i} className="flex items-start gap-4">
                    <span className="shrink-0 w-7 h-7 rounded-full bg-emerald-600/25 text-emerald-300 flex items-center justify-center text-xs font-bold">{i + 1}</span>
                    <div className="text-sm text-slate-300 leading-relaxed pt-0.5">{typeof step === 'string' ? step : step.description || JSON.stringify(step)}</div>
                  </div>
                ))}
              </div>
            </div>
          )}
          {taskTypes.length > 0 && (
            <div>
              <h2 className="text-sm font-bold text-slate-300 mb-5 uppercase tracking-wider">NBME Task Types</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {taskTypes.map((tt, i) => (
                  <div key={i} className="p-5 bg-slate-800/30 border border-slate-300 rounded-xl">
                    <div className="text-sm font-bold text-blue-300 mb-2">{tt.name || tt.type || `Type ${i + 1}`}</div>
                    <div className="text-xs text-slate-400 leading-relaxed">{tt.description || tt.stem || JSON.stringify(tt)}</div>
                    {tt.strategy && <div className="text-xs text-emerald-400/80 mt-3 leading-relaxed italic border-t border-slate-300 pt-3">Strategy: {tt.strategy}</div>}
                  </div>
                ))}
              </div>
            </div>
          )}
          {traps.length > 0 && (
            <div>
              <h2 className="text-sm font-bold text-slate-300 mb-5 uppercase tracking-wider flex items-center gap-2"><Icons.AlertTriangle /> Common NBME Traps</h2>
              <div className="space-y-3">
                {traps.map((trap, i) => (
                  <div key={i} className="p-5 bg-red-950/15 border border-red-800/25 rounded-xl">
                    <div className="text-sm font-bold text-red-300 mb-2">{trap.name || trap.trap || `Trap ${i + 1}`}</div>
                    <div className="text-xs text-slate-400 leading-relaxed">{trap.description || trap.example || JSON.stringify(trap)}</div>
                    {trap.avoidance && <div className="text-xs text-amber-300/80 mt-3 leading-relaxed border-t border-red-800/20 pt-3"><strong>Avoidance:</strong> {trap.avoidance}</div>}
                  </div>
                ))}
              </div>
            </div>
          )}
          <div className="bg-slate-50 border border-slate-300 rounded-xl p-7">
            <h2 className="text-sm font-bold text-slate-300 mb-5 uppercase tracking-wider flex items-center gap-2"><Icons.Clock /> Exam Timing Strategy</h2>
            <div className="space-y-4">
              <p className="text-sm text-slate-300 leading-relaxed">NBME Pediatrics Shelf: <strong className="text-white">110 questions</strong> in ~2h45m = approximately <strong className="text-blue-300">90 seconds per question</strong>.</p>
              <p className="text-xs text-slate-400 leading-relaxed">Budget: <strong className="text-slate-400">60s</strong> reading + <strong className="text-slate-400">20s</strong> elimination + <strong className="text-slate-400">10s</strong> selection. Flag and return for complex vignettes.</p>
              <div className="grid grid-cols-3 gap-3 mt-4">
                {[
                  { label: 'DX', pct: '~42%', color: 'bg-emerald-950/30 border-emerald-800/25 text-emerald-300' },
                  { label: 'MGMT', pct: '~30%', color: 'bg-blue-950/30 border-blue-800/25 text-blue-300' },
                  { label: 'MECH', pct: '~18%', color: 'bg-violet-950/30 border-violet-800/25 text-violet-300' },
                ].map(d => (
                  <div key={d.label} className={`p-4 ${d.color} border rounded-lg text-center`}>
                    <div className="text-xl font-bold">{d.label}</div>
                    <div className="text-[11px] text-slate-400 mt-1">{d.pct} of exam</div>
                  </div>
                ))}
              </div>
            </div>
          </div>
          {playbook.siteOfCareFraming && (
            <div className="bg-slate-50 border border-slate-300 rounded-xl p-7">
              <h2 className="text-sm font-bold text-slate-300 mb-3 uppercase tracking-wider">Site of Care Distribution</h2>
              <p className="text-sm text-slate-400 leading-relaxed">{typeof playbook.siteOfCareFraming === 'string' ? playbook.siteOfCareFraming : JSON.stringify(playbook.siteOfCareFraming)}</p>
            </div>
          )}
        </div>
      );
    }

    // â”€â”€â”€ SEARCH VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function SearchView({ query, setView }) {
      const data = useData(); if (data.loading) return <LoadingScreen />;
      const q = (query || '').toLowerCase(); const results = [];
      Object.entries(data.vignettes || {}).forEach(([domain, vigs]) => {
        vigs.forEach(v => { if (v.title.toLowerCase().includes(q) || (v.tags || []).some(t => t.toLowerCase().includes(q)) || (v.stem || '').toLowerCase().includes(q)) results.push({ type: 'vignette', item: v, domain }); });
      });
      (data.concepts || []).forEach(c => { if ((c.name || '').toLowerCase().includes(q) || (c.intent || '').toLowerCase().includes(q)) results.push({ type: 'concept', item: c }); });
      (data.mnemonics || []).forEach(m => { if ((m.mnemonic || '').toLowerCase().includes(q) || (m.meaning || '').toLowerCase().includes(q)) results.push({ type: 'mnemonic', item: m }); });
      return (
        <div className="animate-fadeIn p-8 max-w-4xl mx-auto">
          <h1 className="text-xl font-bold text-white mb-2 tracking-tight">Search Results</h1>
          <p className="text-sm text-slate-400 mb-6">{results.length} results for "<strong className="text-slate-700">{query}</strong>"</p>
          <div className="space-y-3">
            {results.map((r, i) => (
              <div key={i} className="p-4 bg-slate-800/30 border border-slate-300 rounded-lg hover:bg-slate-800/50 transition">
                {r.type === 'vignette' && (
                  <button onClick={() => setView({ type: 'vignette', vignetteId: r.item.id, domain: r.domain, fromDomain: r.domain, title: r.item.title })} className="text-left w-full">
                    <div className="flex items-center gap-2.5 mb-2">
                      <span className="text-[10px] px-2 py-0.5 bg-blue-500/20 text-blue-300 rounded font-semibold">Vignette</span>
                      <span className="text-sm font-semibold text-white">{r.item.title}</span>
                      <span className="text-sm text-slate-600">{DOMAIN_META[r.domain]?.icon}</span>
                    </div>
                    <div className="text-xs text-slate-400 leading-relaxed">{r.item.stem?.substring(0, 150)}{r.item.stem?.length > 150 ? '...' : ''}</div>
                  </button>
                )}
                {r.type === 'concept' && (
                  <div className="flex items-center gap-2.5">
                    <span className="text-[10px] px-2 py-0.5 bg-violet-500/20 text-violet-300 rounded font-semibold">Concept</span>
                    <span className="text-sm font-medium text-white">{r.item.name}</span>
                    <span className="text-[10px] px-2 py-0.5 bg-slate-700 text-slate-400 rounded">{r.item.intent}</span>
                  </div>
                )}
                {r.type === 'mnemonic' && (
                  <div>
                    <span className="text-[10px] px-2 py-0.5 bg-amber-500/20 text-amber-300 rounded font-semibold mr-2">Mnemonic</span>
                    <span className="text-sm font-mono font-bold text-violet-300">{r.item.mnemonic}</span>
                    <span className="text-xs text-slate-400 ml-3">{r.item.meaning}</span>
                  </div>
                )}
              </div>
            ))}
            {results.length === 0 && <div className="text-center py-8"><p className="text-slate-400 text-sm">No results found.</p><p className="text-slate-600 text-xs mt-1">Try a different search term.</p></div>}
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â”€â”€â”€ INFECTIOUS DISEASE & ANTIBIOTICS HUB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â”€â”€â”€ ID PROGRESS TRACKER (localStorage persistence) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const IDProgress = {
      _key: 'peds_id_progress',
      getAll() { try { return JSON.parse(localStorage.getItem(this._key) || '{}'); } catch { return {}; } },
      save(moduleId, result) {
        const all = this.getAll();
        if (!all[moduleId]) all[moduleId] = { attempts: [], bestScore: 0, bestStreak: 0 };
        const pct = Math.round(result.correct / Math.max(1, result.total) * 100);
        const attempt = { correct: result.correct, total: result.total, pct, missed: result.missed || [], timestamp: Date.now() };
        all[moduleId].attempts.push(attempt);
        all[moduleId].bestScore = Math.max(all[moduleId].bestScore, pct);
        if (result.bestStreak) all[moduleId].bestStreak = Math.max(all[moduleId].bestStreak || 0, result.bestStreak);
        localStorage.setItem(this._key, JSON.stringify(all));
        return attempt;
      },
      getModule(moduleId) { return this.getAll()[moduleId] || { attempts: [], bestScore: 0, bestStreak: 0 }; },
      getLatest(moduleId) { const m = this.getModule(moduleId); return m.attempts.length > 0 ? m.attempts[m.attempts.length - 1] : null; },
      markVisited(moduleId) {
        const all = this.getAll();
        if (!all[moduleId]) all[moduleId] = { attempts: [], bestScore: 0 };
        all[moduleId].lastVisited = Date.now();
        all[moduleId].visitCount = (all[moduleId].visitCount || 0) + 1;
        localStorage.setItem(this._key, JSON.stringify(all));
      },
      getRecommendations(idData) {
        const all = this.getAll();
        const recs = [];
        const quizModules = [
          { id: 'bug_drug', label: 'Bug-Drug Matcher', tab: 'bug_drug' },
          { id: 'whats_the_bug', label: "What's the Bug?", tab: 'whats_the_bug' },
          { id: 'vaccines_quiz', label: 'Vaccine Quiz', tab: 'vaccines' },
        ];
        quizModules.forEach(mod => {
          const progress = all[mod.id];
          if (!progress || progress.attempts.length === 0) {
            recs.push({ priority: 0, tab: mod.tab, label: mod.label, reason: 'Not attempted yet â€” start here to establish your baseline.', type: 'not_started', action: 'Start Now' });
          } else {
            const latest = progress.attempts[progress.attempts.length - 1];
            const trend = progress.attempts.length >= 2 ? latest.pct - progress.attempts[progress.attempts.length - 2].pct : 0;
            if (latest.pct < 60) {
              recs.push({ priority: 1, tab: mod.tab, label: mod.label, reason: `Scored ${latest.pct}% â€” focus on the ${latest.missed?.length || 0} missed items.`, type: 'weak', score: latest.pct, trend, missed: latest.missed, action: 'Retry Now' });
            } else if (latest.pct < 80) {
              recs.push({ priority: 2, tab: mod.tab, label: mod.label, reason: `Scored ${latest.pct}% â€” review your ${latest.missed?.length || 0} weak spots.`, type: 'improving', score: latest.pct, trend, missed: latest.missed, action: 'Practice Again' });
            } else {
              recs.push({ priority: 3, tab: mod.tab, label: mod.label, reason: `Scored ${latest.pct}% â€” solid! Maintain with periodic review.`, type: 'strong', score: latest.pct, trend, action: 'Quick Review' });
            }
          }
        });
        const refModules = [
          { id: 'rash_gallery', label: 'Rash Gallery', tab: 'rash_gallery' },
          { id: 'empiric', label: 'Empiric Therapy', tab: 'empiric' },
          { id: 'spectrum', label: 'Antibiotic Spectrum', tab: 'spectrum' },
          { id: 'age_bugs', label: 'Age-Based Bugs', tab: 'age_bugs' },
          { id: 'pearls', label: 'Pearls & Associations', tab: 'pearls' },
          { id: 'side_effects', label: 'Side Effects', tab: 'side_effects' },
        ];
        refModules.forEach(mod => {
          const p = all[mod.id];
          if (!p || !p.lastVisited) {
            recs.push({ priority: 1.5, tab: mod.tab, label: mod.label, reason: 'Not yet reviewed â€” browse to build familiarity.', type: 'reference', action: 'Browse' });
          }
        });
        recs.sort((a, b) => a.priority - b.priority);
        return recs;
      },
      clearAll() { localStorage.removeItem(this._key); }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GAME ENGINE â€” XP, Levels, Badges, Streaks, Mastery, Combos
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const GameEngine = {
      _key: 'peds_game_state',
      LEVELS: [
        { name: 'MS3', xp: 0, emoji: 'ğŸ“š' },
        { name: 'Sub-Intern', xp: 100, emoji: 'ğŸ©º' },
        { name: 'Intern', xp: 300, emoji: 'ğŸ’‰' },
        { name: 'PGY-2', xp: 600, emoji: 'ğŸ”¬' },
        { name: 'PGY-3', xp: 1000, emoji: 'ğŸ¥' },
        { name: 'Chief Resident', xp: 1500, emoji: 'â­' },
        { name: 'Attending', xp: 2500, emoji: 'ğŸ‘¨â€âš•ï¸' },
      ],
      BADGES: [
        { id: 'first_quiz', name: 'First Steps', desc: 'Complete your first quiz', icon: 'ğŸ‘¶' },
        { id: 'perfect', name: 'Perfect Score', desc: '100% on any quiz', icon: 'ğŸ’¯' },
        { id: 'streak_3', name: 'On Fire', desc: '3 correct in a row', icon: 'ğŸ”¥' },
        { id: 'streak_5', name: 'Unstoppable', desc: '5 correct in a row', icon: 'âš¡' },
        { id: 'streak_10', name: 'God Mode', desc: '10 correct in a row', icon: 'ğŸŒŸ' },
        { id: 'bug_slayer', name: 'Bug Slayer', desc: 'Complete Bug-Drug Matcher', icon: 'ğŸ¦ ' },
        { id: 'heart_whisperer', name: 'Heart Whisperer', desc: 'Complete Murmur Master', icon: 'â¤ï¸' },
        { id: 'vaccine_hero', name: 'Vaccine Champion', desc: 'Complete Vaccine Trainer', icon: 'ğŸ’ª' },
        { id: 'detective', name: 'Clinical Detective', desc: "Complete What's the Bug", icon: 'ğŸ”' },
        { id: 'scenario_master', name: 'Scenario Master', desc: 'Complete Shelf Scenarios', icon: 'ğŸ“‹' },
        { id: 'daily_3', name: 'Daily Devotion', desc: '3-day study streak', icon: 'ğŸ“…' },
        { id: 'daily_7', name: 'Week Warrior', desc: '7-day study streak', icon: 'ğŸ—“ï¸' },
        { id: 'daily_14', name: 'Fortnight Fighter', desc: '14-day study streak', icon: 'ğŸ†' },
        { id: 'comeback', name: 'Comeback Kid', desc: 'Improve score on a retake', icon: 'ğŸ“ˆ' },
        { id: 'xp_500', name: 'Half a Grand', desc: 'Earn 500 XP', icon: 'ğŸ’' },
        { id: 'xp_1000', name: 'Grand Scholar', desc: 'Earn 1000 XP', icon: 'ğŸ‘‘' },
        { id: 'all_modules', name: 'Renaissance Doc', desc: 'Complete all 5 quiz modules', icon: 'ğŸ“' },
        { id: 'mastery_10', name: 'Mastery Seeker', desc: 'Master 10 questions', icon: 'ğŸ§ ' },
        { id: 'mastery_25', name: 'Knowledge Base', desc: 'Master 25 questions', icon: 'ğŸ›ï¸' },
        { id: 'q_100', name: 'Centurion', desc: 'Answer 100 questions total', icon: 'ğŸ—¡ï¸' },
      ],
      ALL_QUIZ_MODULES: ['bug_drug', 'whats_the_bug', 'vaccines_quiz', 'cardio_murmur_quiz', 'cardio_shelf_scenarios', 'visual_cases'],
      getState() {
        try { return JSON.parse(localStorage.getItem(this._key) || 'null') || this._defaultState(); } catch { return this._defaultState(); }
      },
      _defaultState() {
        return { totalXP: 0, currentCombo: 0, bestCombo: 0, totalAnswered: 0, totalCorrect: 0, totalQuizzes: 0, perfectScores: 0, improvements: 0, completedModules: [], earnedBadges: [], dailyStreak: 0, lastPlayedDate: null, mastery: {}, moduleScores: {} };
      },
      _save(state) { localStorage.setItem(this._key, JSON.stringify(state)); },
      getLevel(xp) {
        let lvl = this.LEVELS[0];
        for (const l of this.LEVELS) { if ((xp || 0) >= l.xp) lvl = l; else break; }
        const idx = this.LEVELS.indexOf(lvl);
        const next = this.LEVELS[idx + 1];
        const progress = next ? (xp - lvl.xp) / (next.xp - lvl.xp) : 1;
        return { ...lvl, index: idx, nextLevel: next, progress: Math.min(1, progress), xpToNext: next ? next.xp - xp : 0 };
      },
      getComboMultiplier(combo) { if (combo >= 10) return 3; if (combo >= 5) return 2; if (combo >= 3) return 1.5; return 1; },
      recordAnswer(moduleId, questionId, correct) {
        const s = this.getState();
        const baseXP = correct ? 10 : 2;
        const mult = correct ? this.getComboMultiplier(s.currentCombo + 1) : 1;
        const xpEarned = Math.round(baseXP * mult);
        s.totalXP += xpEarned; s.totalAnswered += 1;
        if (correct) { s.totalCorrect += 1; s.currentCombo += 1; s.bestCombo = Math.max(s.bestCombo, s.currentCombo); } else { s.currentCombo = 0; }
        if (questionId) {
          if (!s.mastery[questionId]) s.mastery[questionId] = { correct: 0, wrong: 0, stage: 'new' };
          const m = s.mastery[questionId];
          if (correct) m.correct += 1; else m.wrong += 1;
          const net = m.correct - m.wrong;
          m.stage = net >= 3 ? 'mastered' : net >= 1 ? 'reviewing' : m.correct > 0 ? 'learning' : 'new';
        }
        this._save(s);
        return { xpEarned, combo: s.currentCombo, multiplier: mult, totalXP: s.totalXP };
      },
      completeQuiz(moduleId, score) {
        const s = this.getState();
        s.totalQuizzes += 1; s.currentCombo = 0;
        const pct = Math.round(score.correct / Math.max(1, score.total) * 100);
        if (pct === 100) s.perfectScores += 1;
        if (!s.completedModules.includes(moduleId)) s.completedModules.push(moduleId);
        const prev = s.moduleScores[moduleId];
        if (prev && pct > prev) s.improvements += 1;
        s.moduleScores[moduleId] = Math.max(prev || 0, pct);
        const bonusXP = pct === 100 ? 50 : pct >= 80 ? 30 : 15;
        s.totalXP += bonusXP;
        const today = new Date().toDateString();
        if (s.lastPlayedDate !== today) {
          const yesterday = new Date(Date.now() - 86400000).toDateString();
          s.dailyStreak = (s.lastPlayedDate === yesterday) ? s.dailyStreak + 1 : 1;
          s.lastPlayedDate = today;
        }
        this._save(s);
        return { bonusXP, pct, newBadges: this.checkNewBadges(s) };
      },
      checkNewBadges(stateOverride) {
        const s = stateOverride || this.getState();
        const earned = s.earnedBadges || []; const newBadges = [];
        const checks = {
          first_quiz: s.totalQuizzes >= 1, perfect: s.perfectScores >= 1,
          streak_3: s.bestCombo >= 3, streak_5: s.bestCombo >= 5, streak_10: s.bestCombo >= 10,
          bug_slayer: (s.completedModules || []).includes('bug_drug'),
          heart_whisperer: (s.completedModules || []).includes('cardio_murmur_quiz'),
          vaccine_hero: (s.completedModules || []).includes('vaccines_quiz'),
          detective: (s.completedModules || []).includes('whats_the_bug'),
          scenario_master: (s.completedModules || []).includes('cardio_shelf_scenarios'),
          daily_3: s.dailyStreak >= 3, daily_7: s.dailyStreak >= 7, daily_14: s.dailyStreak >= 14,
          comeback: s.improvements >= 1, xp_500: s.totalXP >= 500, xp_1000: s.totalXP >= 1000,
          all_modules: (s.completedModules || []).length >= 5,
          mastery_10: Object.values(s.mastery || {}).filter(m => m.stage === 'mastered').length >= 10,
          mastery_25: Object.values(s.mastery || {}).filter(m => m.stage === 'mastered').length >= 25,
          q_100: s.totalAnswered >= 100,
        };
        for (const [id, met] of Object.entries(checks)) {
          if (met && !earned.includes(id)) { earned.push(id); newBadges.push(this.BADGES.find(b => b.id === id)); }
        }
        if (newBadges.length > 0) { s.earnedBadges = earned; this._save(s); }
        return newBadges;
      },
      getMasteryStats() {
        const s = this.getState(); const m = s.mastery || {};
        const counts = { new: 0, learning: 0, reviewing: 0, mastered: 0 };
        Object.values(m).forEach(v => { counts[v.stage] = (counts[v.stage] || 0) + 1; });
        return counts;
      },
      resetCombo() { const s = this.getState(); s.currentCombo = 0; this._save(s); },
      clearAll() { localStorage.removeItem(this._key); }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GAMIFICATION UI COMPONENTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function XPToast({ xp, combo, show }) {
      if (!show) return null;
      return (<div className="fixed top-20 right-6 z-50 animate-fadeIn">
        <div className="bg-gradient-to-r from-amber-500 to-orange-500 text-white px-4 py-2.5 rounded-xl shadow-lg flex items-center gap-3">
          <span className="text-lg font-black">+{xp} XP</span>
          {combo >= 3 && <span className="text-xs bg-white/20 px-2 py-0.5 rounded-full font-bold">{combo}x COMBO {'ğŸ”¥'.repeat(Math.min(combo - 2, 3))}</span>}
        </div>
      </div>);
    }
    function BadgeToast({ badge, show }) {
      if (!show || !badge) return null;
      return (<div className="fixed top-32 right-6 z-50 animate-fadeIn">
        <div className="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-5 py-3 rounded-xl shadow-lg">
          <div className="text-[10px] uppercase tracking-widest text-purple-200 mb-1">Badge Unlocked!</div>
          <div className="flex items-center gap-3"><span className="text-2xl">{badge.icon}</span><div><div className="font-bold text-sm">{badge.name}</div><div className="text-xs text-purple-200">{badge.desc}</div></div></div>
        </div>
      </div>);
    }
    function LevelUpModal({ level, onClose }) {
      if (!level) return null;
      return (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 animate-fadeIn">
        <div className="bg-white rounded-2xl p-8 text-center max-w-sm mx-4 shadow-2xl">
          <div className="text-6xl mb-4">{level.emoji}</div>
          <div className="text-[10px] uppercase tracking-widest text-amber-600 font-bold mb-2">Level Up!</div>
          <h2 className="text-2xl font-black text-slate-800 mb-2">{level.name}</h2>
          <p className="text-sm text-slate-500 mb-6">Keep studying to reach {level.nextLevel ? level.nextLevel.name : 'the top'}!</p>
          <button onClick={onClose} className="px-6 py-2.5 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl font-bold text-sm shadow-lg hover:shadow-xl transition">Continue</button>
        </div>
      </div>);
    }
    function GameHeader() {
      const state = GameEngine.getState(); const level = GameEngine.getLevel(state.totalXP); const mastery = GameEngine.getMasteryStats();
      return (<div className="mb-6 bg-gradient-to-r from-slate-50 to-slate-100 border border-slate-200 rounded-xl p-4">
        <div className="flex items-center justify-between mb-2">
          <div className="flex items-center gap-2.5"><span className="text-xl">{level.emoji}</span><div><span className="text-sm font-bold text-slate-800">{level.name}</span><span className="text-xs text-slate-400 ml-2">{state.totalXP} XP</span></div></div>
          <div className="flex items-center gap-3">
            {state.dailyStreak > 0 && <div className="flex items-center gap-1 text-xs text-orange-600 font-bold bg-orange-50 px-2.5 py-1 rounded-full">ğŸ”¥ {state.dailyStreak}d</div>}
            <div className="flex items-center gap-1 text-xs text-slate-500"><span className="text-emerald-500 font-bold">{mastery.mastered}</span> mastered</div>
          </div>
        </div>
        <div className="w-full bg-slate-200 rounded-full h-2.5 overflow-hidden"><div className="bg-gradient-to-r from-amber-400 to-orange-500 h-full rounded-full transition-all duration-500" style={{ width: `${Math.round(level.progress * 100)}%` }}></div></div>
        {level.nextLevel && <div className="flex justify-between mt-1"><span className="text-[10px] text-slate-400">{level.name}</span><span className="text-[10px] text-slate-400">{level.xpToNext} XP to {level.nextLevel.name}</span></div>}
      </div>);
    }
    function ComboDisplay({ combo }) {
      if (combo < 2) return null;
      const mult = GameEngine.getComboMultiplier(combo);
      const flames = combo >= 10 ? 'ğŸŒŸğŸŒŸğŸŒŸ' : combo >= 5 ? 'âš¡âš¡' : 'ğŸ”¥';
      return (<div className={`inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold transition-all ${combo >= 10 ? 'bg-gradient-to-r from-yellow-400 to-amber-500 text-white shadow-lg shadow-amber-200' : combo >= 5 ? 'bg-gradient-to-r from-orange-400 to-red-500 text-white shadow-md' : 'bg-orange-100 text-orange-700'}`}>{flames} {combo} combo Â· {mult}x XP</div>);
    }

    // Hook: useGameQuiz â€” manages XP toasts, badge toasts, and level-ups during a quiz
    function useGameQuiz(moduleId) {
      const [xpToast, setXpToast] = useState(null);
      const [badgeToast, setBadgeToast] = useState(null);
      const [levelUp, setLevelUp] = useState(null);
      const [combo, setCombo] = useState(0);
      const [, forceUpdate] = useState(0);
      const onAnswer = useCallback((questionId, correct) => {
        const prevState = GameEngine.getState(); const prevLevel = GameEngine.getLevel(prevState.totalXP);
        const result = GameEngine.recordAnswer(moduleId, questionId, correct);
        setCombo(result.combo);
        setXpToast({ xp: result.xpEarned, combo: result.combo });
        setTimeout(() => setXpToast(null), 1500);
        const newLevel = GameEngine.getLevel(result.totalXP);
        if (newLevel.index > prevLevel.index) { setTimeout(() => setLevelUp(newLevel), 800); }
        const newBadges = GameEngine.checkNewBadges();
        if (newBadges.length > 0) { setTimeout(() => { setBadgeToast(newBadges[0]); setTimeout(() => setBadgeToast(null), 3000); }, 500); }
        forceUpdate(n => n + 1);
        return result;
      }, [moduleId]);
      const onComplete = useCallback((score) => {
        const result = GameEngine.completeQuiz(moduleId, score);
        if (result.newBadges.length > 0) { setTimeout(() => { setBadgeToast(result.newBadges[0]); setTimeout(() => setBadgeToast(null), 3000); }, 500); }
        GameEngine.resetCombo(); setCombo(0); forceUpdate(n => n + 1);
        return result;
      }, [moduleId]);
      const overlays = (<React.Fragment>
        <XPToast xp={xpToast?.xp} combo={xpToast?.combo} show={!!xpToast} />
        <BadgeToast badge={badgeToast} show={!!badgeToast} />
        {levelUp && <LevelUpModal level={levelUp} onClose={() => setLevelUp(null)} />}
      </React.Fragment>);
      return { onAnswer, onComplete, combo, overlays };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ACHIEVEMENTS VIEW
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function AchievementsView() {
      const state = GameEngine.getState(); const level = GameEngine.getLevel(state.totalXP); const mastery = GameEngine.getMasteryStats();
      const earned = state.earnedBadges || []; const totalBadges = GameEngine.BADGES.length;
      const accuracy = state.totalAnswered > 0 ? Math.round(state.totalCorrect / state.totalAnswered * 100) : 0;
      return (
        <div className="max-w-4xl mx-auto">
          <div className="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 rounded-2xl p-8 text-white mb-8 shadow-lg">
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-4"><span className="text-5xl">{level.emoji}</span><div><div className="text-[10px] uppercase tracking-widest text-white/60 mb-1">Current Rank</div><h1 className="text-3xl font-black">{level.name}</h1></div></div>
              <div className="text-right"><div className="text-3xl font-black tabular-nums">{state.totalXP}</div><div className="text-xs text-white/60">Total XP</div></div>
            </div>
            <div className="w-full bg-white/20 rounded-full h-3 mb-2 overflow-hidden"><div className="bg-white h-full rounded-full transition-all duration-700" style={{ width: `${Math.round(level.progress * 100)}%` }}></div></div>
            <div className="flex justify-between text-xs text-white/60"><span>{level.name} â€” Level {level.index + 1}</span><span>{level.nextLevel ? `${level.xpToNext} XP to ${level.nextLevel.name} ${level.nextLevel.emoji}` : 'Max Level!'}</span></div>
          </div>
          <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-8">
            {[{ label: 'Questions', value: state.totalAnswered, icon: 'ğŸ“' }, { label: 'Accuracy', value: `${accuracy}%`, icon: 'ğŸ¯' }, { label: 'Best Combo', value: state.bestCombo, icon: 'ğŸ”¥' }, { label: 'Day Streak', value: state.dailyStreak, icon: 'ğŸ“…' }, { label: 'Quizzes Done', value: state.totalQuizzes, icon: 'âœ…' }, { label: 'Perfect Scores', value: state.perfectScores, icon: 'ğŸ’¯' }, { label: 'Improvements', value: state.improvements, icon: 'ğŸ“ˆ' }, { label: 'Badges', value: `${earned.length}/${totalBadges}`, icon: 'ğŸ…' }].map((s, i) => (
              <div key={i} className="bg-white border border-slate-200 rounded-xl p-4 text-center"><div className="text-xl mb-1">{s.icon}</div><div className="text-xl font-black text-slate-800 tabular-nums">{s.value}</div><div className="text-[10px] text-slate-400 uppercase tracking-wider mt-0.5">{s.label}</div></div>
            ))}
          </div>
          <div className="bg-white border border-slate-200 rounded-xl p-6 mb-8">
            <h3 className="text-sm font-bold text-slate-800 mb-4">Mastery Progress</h3>
            <div className="grid grid-cols-4 gap-3 mb-4">
              {[{ label: 'New', count: mastery.new, text: 'text-slate-500' }, { label: 'Learning', count: mastery.learning, text: 'text-blue-600' }, { label: 'Reviewing', count: mastery.reviewing, text: 'text-amber-600' }, { label: 'Mastered', count: mastery.mastered, text: 'text-emerald-600' }].map((s, i) => (
                <div key={i} className="text-center"><div className={`text-2xl font-black ${s.text} tabular-nums`}>{s.count}</div><div className="text-[10px] text-slate-400 uppercase tracking-wider">{s.label}</div></div>
              ))}
            </div>
            {(mastery.new + mastery.learning + mastery.reviewing + mastery.mastered) > 0 && (
              <div className="flex h-3 rounded-full overflow-hidden bg-slate-100">
                {mastery.mastered > 0 && <div className="bg-emerald-400 transition-all" style={{ width: `${mastery.mastered / (mastery.new + mastery.learning + mastery.reviewing + mastery.mastered) * 100}%` }}></div>}
                {mastery.reviewing > 0 && <div className="bg-amber-400 transition-all" style={{ width: `${mastery.reviewing / (mastery.new + mastery.learning + mastery.reviewing + mastery.mastered) * 100}%` }}></div>}
                {mastery.learning > 0 && <div className="bg-blue-400 transition-all" style={{ width: `${mastery.learning / (mastery.new + mastery.learning + mastery.reviewing + mastery.mastered) * 100}%` }}></div>}
              </div>
            )}
          </div>
          <div className="bg-white border border-slate-200 rounded-xl p-6 mb-8">
            <h3 className="text-sm font-bold text-slate-800 mb-4">Rank Progression</h3>
            <div className="space-y-2">
              {GameEngine.LEVELS.map((l, i) => { const reached = state.totalXP >= l.xp; const current = level.index === i; return (
                <div key={i} className={`flex items-center gap-3 p-2.5 rounded-lg transition ${current ? 'bg-amber-50 border border-amber-200' : reached ? 'bg-emerald-50/50' : 'opacity-40'}`}>
                  <span className="text-xl w-8 text-center">{l.emoji}</span><div className="flex-1"><span className={`text-sm font-bold ${current ? 'text-amber-700' : reached ? 'text-emerald-700' : 'text-slate-400'}`}>{l.name}</span><span className="text-xs text-slate-400 ml-2">{l.xp} XP</span></div>
                  {current && <span className="text-[10px] bg-amber-200 text-amber-700 px-2 py-0.5 rounded-full font-bold">CURRENT</span>}
                  {reached && !current && <span className="text-emerald-500 text-sm">âœ“</span>}
                </div>); })}
            </div>
          </div>
          <div className="bg-white border border-slate-200 rounded-xl p-6">
            <h3 className="text-sm font-bold text-slate-800 mb-4">Badge Collection â€” {earned.length}/{totalBadges}</h3>
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
              {GameEngine.BADGES.map(badge => { const unlocked = earned.includes(badge.id); return (
                <div key={badge.id} className={`p-4 rounded-xl text-center border transition ${unlocked ? 'bg-gradient-to-br from-purple-50 to-indigo-50 border-purple-200 shadow-sm' : 'bg-slate-50 border-slate-200 opacity-40 grayscale'}`}>
                  <div className="text-3xl mb-2">{badge.icon}</div><div className={`text-xs font-bold mb-0.5 ${unlocked ? 'text-purple-700' : 'text-slate-400'}`}>{badge.name}</div><div className="text-[10px] text-slate-400">{badge.desc}</div>
                  {unlocked && <div className="text-[10px] text-purple-500 font-bold mt-1">âœ“ Unlocked</div>}
                </div>); })}
            </div>
          </div>
        </div>
      );
    }

    // SVG Body Diagrams
    function InfantBody({ affectedAreas }) {
      const getAreaStyle = (region) => {
        if (affectedAreas?.some(a => a.region === region)) {
          return { fill: '#fee2e2', stroke: '#dc2626', strokeWidth: 2 };
        }
        return { fill: 'none', stroke: '#94a3b8', strokeWidth: 1.5 };
      };

      return (
        <svg viewBox="0 0 200 300" className="w-full h-auto">
          <defs>
            <filter id="infantGlow">
              <feGaussianBlur stdDeviation="2" result="coloredBlur" />
              <feMerge>
                <feMergeNode in="coloredBlur" />
                <feMergeNode in="SourceGraphic" />
              </feMerge>
            </filter>
          </defs>
          {/* Head */}
          <circle cx="100" cy="50" r="25" {...getAreaStyle('head')} filter="url(#infantGlow)" />
          {/* Eyes */}
          <circle cx="92" cy="45" r="3" fill={affectedAreas?.some(a => a.region === 'eyes') ? '#dc2626' : '#475569'} />
          <circle cx="108" cy="45" r="3" fill={affectedAreas?.some(a => a.region === 'eyes') ? '#dc2626' : '#475569'} />
          {/* Ears */}
          <ellipse cx="75" cy="45" rx="8" ry="12" {...getAreaStyle('ears')} />
          <ellipse cx="125" cy="45" rx="8" ry="12" {...getAreaStyle('ears')} />
          {/* Neck/Throat */}
          <rect x="93" y="73" width="14" height="15" {...getAreaStyle('throat')} />
          {/* Chest/Lungs */}
          <ellipse cx="100" cy="110" rx="20" ry="25" {...getAreaStyle('chest')} />
          {/* Heart */}
          <path d="M 100 115 L 105 110 Q 108 107 107 105 Q 105 103 100 105 Q 95 103 93 105 Q 92 107 95 110 Z" {...getAreaStyle('heart')} />
          {/* Abdomen/GI */}
          <rect x="85" y="140" width="30" height="35" {...getAreaStyle('abdomen')} />
          {/* GU Lower */}
          <circle cx="100" cy="185" r="10" {...getAreaStyle('gu')} />
          {/* Arms */}
          <rect x="60" y="105" width="12" height="40" {...getAreaStyle('skin')} />
          <rect x="128" y="105" width="12" height="40" {...getAreaStyle('skin')} />
          {/* Legs */}
          <rect x="88" y="180" width="10" height="50" {...getAreaStyle('msk')} />
          <rect x="102" y="180" width="10" height="50" {...getAreaStyle('msk')} />
        </svg>
      );
    }

    function ChildBody({ affectedAreas }) {
      const getAreaStyle = (region) => {
        if (affectedAreas?.some(a => a.region === region)) {
          return { fill: '#fee2e2', stroke: '#dc2626', strokeWidth: 2 };
        }
        return { fill: 'none', stroke: '#94a3b8', strokeWidth: 1.5 };
      };

      return (
        <svg viewBox="0 0 200 400" className="w-full h-auto">
          <defs>
            <filter id="childGlow">
              <feGaussianBlur stdDeviation="2" result="coloredBlur" />
              <feMerge>
                <feMergeNode in="coloredBlur" />
                <feMergeNode in="SourceGraphic" />
              </feMerge>
            </filter>
          </defs>
          {/* Head */}
          <circle cx="100" cy="50" r="22" {...getAreaStyle('head')} filter="url(#childGlow)" />
          {/* Eyes */}
          <circle cx="92" cy="45" r="3" fill={affectedAreas?.some(a => a.region === 'eyes') ? '#dc2626' : '#475569'} />
          <circle cx="108" cy="45" r="3" fill={affectedAreas?.some(a => a.region === 'eyes') ? '#dc2626' : '#475569'} />
          {/* Ears */}
          <ellipse cx="76" cy="48" rx="7" ry="10" {...getAreaStyle('ears')} />
          <ellipse cx="124" cy="48" rx="7" ry="10" {...getAreaStyle('ears')} />
          {/* Neck/Throat */}
          <rect x="94" y="70" width="12" height="12" {...getAreaStyle('throat')} />
          {/* Chest/Lungs */}
          <ellipse cx="100" cy="115" rx="22" ry="28" {...getAreaStyle('chest')} />
          {/* Heart */}
          <path d="M 100 120 L 105 115 Q 108 112 107 110 Q 105 108 100 110 Q 95 108 93 110 Q 92 112 95 115 Z" {...getAreaStyle('heart')} />
          {/* Abdomen/GI */}
          <rect x="82" y="150" width="36" height="50" {...getAreaStyle('abdomen')} />
          {/* GU Lower */}
          <circle cx="100" cy="215" r="12" {...getAreaStyle('gu')} />
          {/* Arms */}
          <rect x="55" y="110" width="14" height="60" {...getAreaStyle('skin')} />
          <rect x="131" y="110" width="14" height="60" {...getAreaStyle('skin')} />
          {/* Legs */}
          <rect x="85" y="220" width="12" height="70" {...getAreaStyle('msk')} />
          <rect x="103" y="220" width="12" height="70" {...getAreaStyle('msk')} />
        </svg>
      );
    }

    // Clinical Cases Data
    const VISUAL_CASES = [
      {
        id: 'vc1',
        title: 'Acute Otitis Media',
        age: '18-month-old',
        figure: 'infant',
        presentation: ['Fever 38.5Â°C x2 days', 'Pulling at right ear', 'Irritable, sleep disrupted', 'Rhinorrhea x5 days prior'],
        affectedAreas: [
          { region: 'ears', label: 'Bulging, erythematous TM', side: 'right' },
          { region: 'throat', label: 'Nasopharyngeal congestion' }
        ],
        question: 'What is the best initial management?',
        options: ['High-dose amoxicillin', 'Observation only', 'Azithromycin', 'Amoxicillin-clavulanate'],
        correct: 'High-dose amoxicillin',
        treatment: {
          drug: 'Amoxicillin',
          dose: '80â€“90 mg/kg/day divided BID (max 4g/day)',
          route: 'PO',
          duration: '10 days (<2yo); 5â€“7 days (â‰¥2yo with mild symptoms)'
        },
        additionalMgmt: ['Acetaminophen or ibuprofen for otalgia/fever', 'Follow-up exam if no improvement in 48â€“72h', 'Avoid insertion of ototoxic drops if TM perforated'],
        pitfalls: ['DO NOT observe <2yo with bilateral AOM', 'Do NOT use amoxicillin-clavulanate as first-line (reserve for failures)', 'Tympanostomy tubes only if â‰¥3 episodes/6mo or â‰¥4/12mo'],
        shelfPearl: 'Most shelf Qs expect treatment for <2yo with AOM. Observation is ONLY for unilateral, mild AOM in â‰¥2yo after shared decision-making. Amoxicillin dosing: 80â€“90 mg/kg/day is HIGH-dose.'
      },
      {
        id: 'vc2',
        title: 'Streptococcal Pharyngitis',
        age: '6-year-old',
        figure: 'child',
        presentation: ['Sore throat x3 days', 'Fever 39Â°C, odynophagia', 'Exudative pharyngitis', 'Enlarged cervical lymph nodes'],
        affectedAreas: [
          { region: 'throat', label: 'Erythema, exudate on tonsils' },
          { region: 'ears', label: 'Cervical lymphadenitis' }
        ],
        question: 'What antibiotic would you prescribe?',
        options: ['Penicillin V or amoxicillin', 'Clarithromycin', 'Trimethoprim-sulfamethoxazole', 'Cephalexin only if PCN-allergy'],
        correct: 'Penicillin V or amoxicillin',
        treatment: {
          drug: 'Penicillin V OR Amoxicillin',
          dose: 'PCN V: 250 mg QID or 500 mg BID; Amox: 25â€“45 mg/kg/day divided BIDâ€“TID',
          route: 'PO',
          duration: '10 days'
        },
        additionalMgmt: ['Ibuprofen/acetaminophen for pain & fever', 'Throat lozenges, warm salt water gargles', 'Return precautions: severe dysphagia, drooling, stridor â†’ eval for peritonsillar abscess'],
        pitfalls: ['Azithromycin resistance rising; do NOT use if local prevalence >5%', 'TMP-SMX NOT effective for GAS', 'Early Abx reduces fever by 1â€“1.5d but mainly prevents complications (ARF, PSGN)'],
        shelfPearl: 'Penicillin is first-line for GAS pharyngitis. Goal is to prevent rheumatic fever and post-streptococcal GN, NOT to shorten symptoms. Amoxicillin is acceptable PO alternative with better taste.'
      },
      {
        id: 'vc3',
        title: 'Neonatal Meningitis',
        age: '2-week-old',
        figure: 'infant',
        presentation: ['Fever 38.2Â°C, poor feeding', 'High-pitched cry, irritability', 'Subtle bulge at anterior fontanel', 'GBS sepsis in mother during labor'],
        affectedAreas: [
          { region: 'head', label: 'Bulging fontanel, meningismus' },
          { region: 'chest', label: 'Tachypnea, poor perfusion' }
        ],
        question: 'What is the empiric antibiotic regimen?',
        options: ['Ampicillin + cefotaxime', 'Ceftriaxone + vancomycin', 'Ampicillin + gentamicin + acyclovir', 'Meropenem alone'],
        correct: 'Ampicillin + gentamicin + acyclovir',
        treatment: {
          drug: 'Ampicillin + Gentamicin + Acyclovir',
          dose: 'Amp: 50 mg/kg IV Q6h; Gent: 7.5 mg/kg IV Q12h; Acyclovir: 20 mg/kg IV Q8h',
          route: 'IV',
          duration: '10â€“14 days (or duration per organism & CSF sterilization)'
        },
        additionalMgmt: ['Lumbar puncture with CSF culture, Gram stain, glucose, protein', 'Empiric Abx given BEFORE LP if hemodynamically unstable', 'Consider dexamethasone 0.15 mg/kg IV Q6h x 4d if dexamethasone given WITH first Abx dose', 'Monitor for SIADH, DIC'],
        pitfalls: ['Cephalosporins POOR CNS penetration in neonates; ampicillin + gentamicin required', 'DO NOT omit acyclovir (HSV meningitis in neonates ~5â€“10%)', 'Gentamicin dosing: q12h (immature renal clearance), NOT q8h'],
        shelfPearl: 'Neonatal meningitis (<1mo) ALWAYS requires ampicillin (for Listeria monocytogenes) + gentamicin (for gram-negs) + acyclovir (HSV). Cephalosporins alone are inadequate.'
      },
      {
        id: 'vc4',
        title: 'Bacterial Meningitis (>3 months)',
        age: '4-year-old',
        figure: 'child',
        presentation: ['Fever 39.5Â°C, altered mental status', 'Neck stiffness, photophobia', 'Petechial rash on trunk & extremities', 'Positive Kernig & Brudzinski signs'],
        affectedAreas: [
          { region: 'head', label: 'Meningismus, altered sensorium' },
          { region: 'skin', label: 'Petechial/purpuric exanthem' }
        ],
        question: 'What is empiric therapy in a 4-year-old with meningitis?',
        options: ['Ceftriaxone + vancomycin', 'Ceftriaxone + vancomycin + dexamethasone', 'Ampicillin + gentamicin', 'Chloramphenicol'],
        correct: 'Ceftriaxone + vancomycin + dexamethasone',
        treatment: {
          drug: 'Ceftriaxone + Vancomycin + Dexamethasone',
          dose: 'Ceftrx: 80â€“100 mg/kg/day div Q4â€“6h (max 4g/day); Van: 40â€“60 mg/kg/day div Q6h; Dex: 0.15 mg/kg IV Q6h',
          route: 'IV',
          duration: '10â€“14 days bacterial meningitis; dexamethasone x 4 days'
        },
        additionalMgmt: ['Dexamethasone MUST be given with or before first Abx dose (reduces mortality/morbidity)', 'CSF culture, glucose, protein, Gram stain', 'Respiratory isolation until 24h Abx therapy', 'Prophylaxis for close contacts: rifampin or ciprofloxacin'],
        pitfalls: ['Starting dexamethasone >4h after Abx reduces benefit; must be early', 'Vancomycin needed to cover penicillin-resistant S. pneumoniae (PRSP)', 'If LP delayed >30min, give Abx first; do NOT defer empiric therapy'],
        shelfPearl: 'Empiric meningitis in children >3mo = cephalosporin (ceftriaxone/cefotaxime) + vancomycin + dexamethasone. Dexamethasone EARLY (with 1st Abx) improves outcomes in pneumococcal meningitis.'
      },
      {
        id: 'vc5',
        title: 'Community-Acquired Pneumonia (CAP)',
        age: '5-year-old',
        figure: 'child',
        presentation: ['Fever x4 days, cough productive', 'Tachypnea (RR 50), grunting', 'Focal consolidation on exam', 'No prior antibiotic use'],
        affectedAreas: [
          { region: 'chest', label: 'Lobar consolidation, dullness to percussion' }
        ],
        question: 'What is the initial empiric antibiotic?',
        options: ['Amoxicillin', 'Amoxicillin-clavulanate', 'Azithromycin', 'High-dose amoxicillin'],
        correct: 'High-dose amoxicillin',
        treatment: {
          drug: 'Amoxicillin (high-dose)',
          dose: '80â€“90 mg/kg/day divided BIDâ€“TID (max 4g/day)',
          route: 'PO (if non-toxic appearance, SpOâ‚‚ >90%)',
          duration: '5â€“7 days'
        },
        additionalMgmt: ['Chest X-ray if clinical suspicion, but diagnosis often clinical', 'Supportive care: fluids, acetaminophen/ibuprofen', 'Oxygen if SpOâ‚‚ <90%', 'No routine suctioning or postural drainage'],
        pitfalls: ['Amoxicillin-clavulanate NOT first-line for uncomplicated CAP (no H. influenzae coverage needed)', 'Azithromycin alone inadequate for streptococcus', 'Empiric coverage for gram-negatives (cephalosporin) only if risk factors (aspiration, immunocompromise)'],
        shelfPearl: 'Most community-acquired pneumonia in children is viral or S. pneumoniae. Amoxicillin 80â€“90 mg/kg/day is first-line. Hospitalize if stridor, retractions at rest, SpOâ‚‚ <90%, altered sensorium, or dehydration.'
      },
      {
        id: 'vc6',
        title: 'Bronchiolitis',
        age: '9-month-old',
        figure: 'infant',
        presentation: ['Viral URI x3 days â†’ respiratory distress', 'Fever low-grade, cough, wheezing/crackles', 'Subcostal retractions, nasal flaring', 'RSV PCR positive'],
        affectedAreas: [
          { region: 'chest', label: 'Hyperinflation, small airway obstruction' },
          { region: 'throat', label: 'Rhinitis, nasal congestion' }
        ],
        question: 'What is the cornerstone of management?',
        options: ['Antibiotics + oxygen', 'Supportive care, oxygen, monitor hydration', 'Antiviral ribavirin', 'Systemic corticosteroids'],
        correct: 'Supportive care, oxygen, monitor hydration',
        treatment: {
          drug: 'NO specific antiviral or antibiotic (viral illness)',
          dose: 'Supportive care only',
          route: 'Oxygen if SpOâ‚‚ <90%, IV hydration if unable to feed',
          duration: 'Usually self-limited, 7â€“10 days; hospitalize if SpOâ‚‚ <90%, severe retractions, or <6wks old'
        },
        additionalMgmt: ['Nasal suctioning/saline to clear airway', 'Consider nebulized epinephrine if severe upper airway edema', 'Ribavirin reserved for severely immunocompromised', 'Avoid aggressive fluids (risk pulmonary edema from airway obstruction)'],
        pitfalls: ['DO NOT give antibiotics (viral illness)', 'Corticosteroids have limited evidence; may consider dexamethasone if recurrent wheezing history', 'Albuterol/bronchodilators NOT routinely beneficial in first episode'],
        shelfPearl: 'Bronchiolitis is VIRAL (RSV, parainfluenza, influenza) â†’ supportive care only. Antiviral ribavirin rarely used. Hospitalize infants <6wks or if SpOâ‚‚ <90% or severe respiratory distress.'
      },
      {
        id: 'vc7',
        title: 'Croup (Laryngotracheobronchitis)',
        age: '2-year-old',
        figure: 'child',
        presentation: ['Barky, seal-like cough', 'Inspiratory stridor', 'Mild fever, low-grade URI symptoms', 'Worse at night, self-limited'],
        affectedAreas: [
          { region: 'throat', label: 'Subglottic edema, erythema' }
        ],
        question: 'What is first-line treatment for moderate croup?',
        options: ['Dexamethasone', 'Dexamethasone + nebulized epinephrine', 'Antibiotics + steroids', 'Intubation'],
        correct: 'Dexamethasone + nebulized epinephrine',
        treatment: {
          drug: 'Dexamethasone + Nebulized Epinephrine (if moderateâ€“severe)',
          dose: 'Dex: 0.6 mg/kg single dose (max 10 mg); Epi: 0.5 mL/kg racemic (max 5 mL) or 1:1000 L-epi 0.05 mL/kg (max 1 mL)',
          route: 'Dex: PO or IV; Epi: nebulized',
          duration: 'Single dexamethasone dose; nebulized epi effect 15â€“30min, may repeat Q30min if needed'
        },
        additionalMgmt: ['Most croup mild & self-limiting; reassurance to parents', 'Cool mist/humidified air may provide comfort', 'Intubation only if complete airway obstruction (rare)'],
        pitfalls: ['Antibiotics NOT indicated (viral)', 'Racemic epinephrine preferred over L-epinephrine (less cardiac side effects)', 'Watch for rebound edema 30min after epinephrine wears offâ€”discharge only if safe'],
        shelfPearl: 'Croup is parainfluenza â†’ VIRAL. Dexamethasone reduces edema & shortens symptoms. Nebulized epi for acute airway obstruction. Intubation rare. Self-limiting in 3â€“7 days.'
      },
      {
        id: 'vc8',
        title: 'Pertussis (Whooping Cough)',
        age: '3-month-old',
        figure: 'infant',
        presentation: ['Paroxysmal cough x2 weeks, post-tussive vomiting', 'Inspiratory "whoop" with gasping', 'Fever minimal, apnea spells', 'Leukocytosis 30â€“50k'],
        affectedAreas: [
          { region: 'chest', label: 'Severe paroxysmal cough, hyperinflation' }
        ],
        question: 'What antibiotic eradicates Bordetella pertussis?',
        options: ['Azithromycin', 'Amoxicillin', 'Trimethoprim-sulfamethoxazole', 'Erythromycin'],
        correct: 'Azithromycin',
        treatment: {
          drug: 'Azithromycin',
          dose: '10 mg/kg day 1, then 5 mg/kg/day days 2â€“5 (max 500 mg/day)',
          route: 'PO',
          duration: '5 days'
        },
        additionalMgmt: ['Close contacts (family, classmates) need post-exposure prophylaxis with azithromycin', 'Supportive care: monitor for apnea (ICU admission if <3mo)', 'Pertussis vaccine (DTaP) at 2, 4, 6, 15â€“18mo, 4â€“6yo', 'Reportable disease to public health'],
        pitfalls: ['Antibiotics reduce infectivity but NOT cough duration if given late (cough persists 2â€“8 weeks)', 'Trimethoprim-SMX less reliable; erythromycin less used (GI upset, macrolide-resistant strains rising)', 'Infants <1 year at highest risk for severe disease & apnea; consider ICU'],
        shelfPearl: 'Pertussis = azithromycin (5-day course) for eradication & to reduce infectivity. Vaccination is BEST prevention (DTaP series). High-risk: infants <6mo (apnea, seizures, encephalopathy).'
      },
      {
        id: 'vc9',
        title: 'Febrile Infant UTI',
        age: '4-month-old',
        figure: 'infant',
        presentation: ['Fever 38.5Â°C, no localizing signs', 'Irritability, poor feeding', 'No diarrhea or respiratory symptoms', 'UA: pyuria, bacteriuria'],
        affectedAreas: [
          { region: 'gu', label: 'Positive urine culture, bacteriuria' }
        ],
        question: 'What is the initial antibiotic for urosepsis concern in a 4-month-old?',
        options: ['Oral cephalexin', 'IV ceftriaxone or ceftazidime', 'PO trimethoprim-SMX', 'Ampicillin alone'],
        correct: 'IV ceftriaxone or ceftazidime',
        treatment: {
          drug: 'Ceftriaxone or Ceftazidime',
          dose: 'Ceftrx: 50â€“80 mg/kg/day div Q8h; Ceftazidime: 30 mg/kg Q8h',
          route: 'IV initially (can switch to PO after initial stabilization)',
          duration: '7â€“14 days (IV or PO based on clinical improvement)'
        },
        additionalMgmt: ['Urine culture (suprapubic aspiration or straight catheterization for accuracy)', 'Blood culture', 'Renal ultrasound & voiding cystourethrogram (VCUG) to rule out anatomic anomalies', 'Close follow-up & repeat UA/culture to ensure sterilization'],
        pitfalls: ['Oral Abx alone NOT reliable for febrile infant <2mo (high risk urosepsis)', 'Prophylactic Abx post-VCUG if vesicoureteral reflux (VUR) detected', 'Circumcision may reduce UTI risk in boys'],
        shelfPearl: 'Febrile infant with UTI = empiric IV broad-spectrum cephalosporin (ceftriaxone/ceftazidime). After stabilization, switch to PO cephalexin based on culture sensitivities. Workup with renal ultrasound & VCUG.'
      },
      {
        id: 'vc10',
        title: 'UTI in Older Child',
        age: '6-year-old (female)',
        figure: 'child',
        presentation: ['Dysuria, frequency, urgency x2 days', 'Low fever or afebrile', 'No renal angle tenderness', 'UA: WBCs, nitrites, leukocyte esterase'],
        affectedAreas: [
          { region: 'gu', label: 'Dysuria, pyuria, bacteriuria' }
        ],
        question: 'What is appropriate initial therapy?',
        options: ['Trimethoprim-sulfamethoxazole', 'Cephalexin', 'Amoxicillin', 'Fluoroquinolone'],
        correct: 'Trimethoprim-sulfamethoxazole',
        treatment: {
          drug: 'Trimethoprim-Sulfamethoxazole OR Cephalexin',
          dose: 'TMP-SMX: 6â€“12 mg/kg/day (TMP component) div BID; Cephalexin: 25â€“50 mg/kg/day div QID',
          route: 'PO',
          duration: '3â€“5 days'
        },
        additionalMgmt: ['Urine culture (clean-catch or catheterization)', 'Encourage fluids, frequent voiding, wiping front-to-back', 'Renal ultrasound if recurrent UTI (>2 episodes) or abnormal exam', 'VCUG if ANY imaging abnormality or recurrent pyelonephritis'],
        pitfalls: ['Amoxicillin NOT first-line (lower efficacy for gram-negatives)', 'Fluoroquinolones reserved for resistant organisms or severe infection', 'If pyelonephritis signs (fever, flank pain, CVA tenderness) â†’ may need IV Abx & hospitalization'],
        shelfPearl: 'Uncomplicated cystitis in school-age girls: TMP-SMX or cephalexin x 3â€“5 days PO. Pyelonephritis requires IV therapy initially (ceftriaxone/ceftazidime). Prophylaxis if recurrent or VUR.'
      },
      {
        id: 'vc11',
        title: 'Periorbital Cellulitis',
        age: '3-year-old',
        figure: 'child',
        presentation: ['Eyelid swelling, erythema x1 day', 'Fever 38.8Â°C, moderate edema', 'Vision intact, no proptosis', 'No recent trauma or ocular disease'],
        affectedAreas: [
          { region: 'eyes', label: 'Lid erythema, edema, swelling' }
        ],
        question: 'What is the likely organism & initial treatment?',
        options: ['Staphylococcus aureus; oral amoxicillin-clavulanate', 'H. influenzae; IV ceftriaxone + vancomycin', 'Streptococcus; oral penicillin V', 'Normal flora; observation only'],
        correct: 'H. influenzae; IV ceftriaxone + vancomycin',
        treatment: {
          drug: 'IV Ceftriaxone + Vancomycin',
          dose: 'Ceftrx: 50â€“80 mg/kg/day div Q8h; Van: 40â€“60 mg/kg/day div Q6h',
          route: 'IV',
          duration: '7â€“10 days, then PO cephalexin or amoxicillin-clavulanate to complete course'
        },
        additionalMgmt: ['Blood culture, consider imaging (CT or MRI) to rule out orbital cellulitis', 'Careful eye exam to ensure no proptosis, ophthalmoplegia, or vision change', 'Urgent ophthalmology referral if any signs of orbital involvement'],
        pitfalls: ['H. influenzae was common pre-Hib vaccine; now often MRSA or GAS', 'DO NOT assume safe without imaging; if proptosis/vision loss â†’ likely orbital cellulitis (surgical emergency)', 'Streptococcus aerobacillus or S. aureus from skin flora most common today'],
        shelfPearl: 'Periorbital cellulitis = IV cephalosporin + vancomycin empirically. Must distinguish from orbital cellulitis (proptosis, ophthalmoplegia, severe vision change = emergent surgery). Hib vaccine has reduced H. influenzae.'
      },
      {
        id: 'vc12',
        title: 'Orbital Cellulitis',
        age: '7-year-old',
        figure: 'child',
        presentation: ['Eyelid swelling, complete ophthalmoplegia', 'Vision loss, proptosis', 'Fever 39.2Â°C, severe systemic toxicity', 'History of sinusitis or trauma'],
        affectedAreas: [
          { region: 'eyes', label: 'Proptosis, ophthalmoplegia, chemosis' }
        ],
        question: 'What is the next immediate step?',
        options: ['Start broad-spectrum IV Abx & urgent ophthalmology consult', 'Obtain emergent CT/MRI orbit & immediate surgical evaluation', 'Start oral antibiotics & follow-up imaging', 'Warm compress & observation'],
        correct: 'Obtain emergent CT/MRI orbit & immediate surgical evaluation',
        treatment: {
          drug: 'IV Ceftriaxone + Vancomycin Â± Ampicillin (if <3mo)',
          dose: 'Ceftrx: 50â€“80 mg/kg/day div Q8h; Van: 40â€“60 mg/kg/day div Q6h',
          route: 'IV',
          duration: '2â€“3 weeks; surgical drainage if abscess'
        },
        additionalMgmt: ['Urgent CT/MRI orbits with contrast (define abscess, extent)', 'Sinus imaging if sinusitis source', 'Neurosurgery/ENT/Ophthalmology consultation for possible drainage', 'Blood & orbital fluid cultures if drained'],
        pitfalls: ['Delayed diagnosis â†’ blindness, cavernous sinus thrombosis, meningitis', 'Periorbital vs. orbital cellulitis distinction is CRITICAL; proptosis/ophthalmoplegia indicate orbital', 'Most common source = ethmoid sinusitis'],
        shelfPearl: 'Orbital cellulitis = SURGICAL EMERGENCY. Proptosis, ophthalmoplegia, vision loss = must image & may need drainage. IV Abx empirically (cephalosporin + vancomycin) but imaging/surgery is priority.'
      },
      {
        id: 'vc13',
        title: 'Skin Abscess / MRSA',
        age: '5-year-old',
        figure: 'child',
        presentation: ['Localized skin lesion with fluctuance', 'Erythema, warmth, tenderness', 'Low fever or afebrile', 'No systemic toxicity'],
        affectedAreas: [
          { region: 'skin', label: 'Fluctuant abscess on arm or leg' }
        ],
        question: 'What is the definitive & initial treatment?',
        options: ['Oral TMP-SMX monotherapy', 'Incision & drainage alone', 'Incision & drainage + empiric cover for MRSA', 'Oral amoxicillin'],
        correct: 'Incision & drainage + empiric cover for MRSA',
        treatment: {
          drug: 'Incision & Drainage + Trimethoprim-Sulfamethoxazole OR Clindamycin',
          dose: 'TMP-SMX: 6â€“12 mg/kg/day (TMP component) BID; Clindamycin: 20â€“40 mg/kg/day div TIDâ€“QID',
          route: 'I&D (may be office procedure if small); Abx: PO',
          duration: '7â€“10 days Abx post-drainage'
        },
        additionalMgmt: ['Wound culture for culture-directed therapy if MRSA suspected', 'Pain control, local wound care, saline irrigation', 'Keep wound clean & dry', 'No need for hospitalization unless signs of systemic infection (fever, cellulitis extending >2cm, immunocompromised)'],
        pitfalls: ['I&D is curative for localized abscess; Abx alone inadequate for fluctuant collections', 'MRSA resistance to beta-lactams high; use TMP-SMX or clindamycin empirically', 'If cellulitis spreads or systemic toxicity â†’ escalate to IV Abx & hospitalization'],
        shelfPearl: 'Skin abscess = I&D is KEY. Cover for MRSA with TMP-SMX or clindamycin. Small abscesses often resolve with I&D alone; reserve systemic Abx for surrounding cellulitis or immunocompromised host.'
      },
      {
        id: 'vc14',
        title: 'Impetigo',
        age: '3-year-old',
        figure: 'child',
        presentation: ['Honey-crusted vesicles on exposed skin', 'Non-purulent initially â†’ may progress', 'Minimal fever, well-appearing', 'Spread by direct contact'],
        affectedAreas: [
          { region: 'skin', label: 'Honey-crusted lesions on face, arms' }
        ],
        question: 'What is appropriate treatment?',
        options: ['Observation; self-limited', 'Topical mupirocin', 'Topical mupirocin + oral antibiotic if extensive', 'IV cephalosporin'],
        correct: 'Topical mupirocin + oral antibiotic if extensive',
        treatment: {
          drug: 'Mupirocin (topical) Â± Oral Amoxicillin-clavulanate or Cephalexin',
          dose: 'Mupirocin: apply TID; Amox-clav: 25â€“45 mg/kg/day div TID; Cephalexin: 25â€“50 mg/kg/day div QID',
          route: 'Topical mupirocin; PO Abx if extensive or rapidly progressive',
          duration: 'Mupirocin x 5â€“7 days; oral Abx x 7â€“10 days'
        },
        additionalMgmt: ['Gentle cleaning with soap & water, remove crusts', 'Cover lesions if in daycare (return after 24h topical Abx or 24h systemic Abx)', 'Avoid spread: fingernail trimming, handwashing'],
        pitfalls: ['Topical mupirocin alone may fail if extensive (>5 lesions); add PO Abx', 'MRSA impetigo: use clindamycin or TMP-SMX instead of amoxicillin-clavulanate', 'Complications: cellulitis, lymphangitis, post-streptococcal GN (rare)'],
        shelfPearl: 'Impetigo = typically topical mupirocin TID x 5â€“7 days. If extensive/rapidly progressive or MRSA, add oral antibiotic (clindamycin or TMP-SMX). Post-streptococcal GN risk if GAS impetigo.'
      },
      {
        id: 'vc15',
        title: 'Cellulitis',
        age: '4-year-old',
        figure: 'child',
        presentation: ['Non-purulent erythema, edema, warmth', 'Fever 38.5Â°C, lymphangitis (red streak)', 'Recent varicella or skin breach', 'Spreading borders'],
        affectedAreas: [
          { region: 'skin', label: 'Diffuse erythema, edema, warmth on leg' }
        ],
        question: 'What is the first-line antibiotic for presumed streptococcal cellulitis?',
        options: ['Oral amoxicillin', 'IV cefazolin', 'Oral cephalexin', 'IV ceftriaxone + vancomycin'],
        correct: 'IV cefazolin',
        treatment: {
          drug: 'Cefazolin (if non-toxic) OR IV Cephalosporin (if systemic toxicity/rapid spread)',
          dose: 'Cefazolin: 25â€“33 mg/kg Q8h; Ceftriaxone: 50â€“80 mg/kg/day div Q8h',
          route: 'IV',
          duration: '7â€“10 days; can switch to PO cephalexin after improvement'
        },
        additionalMgmt: ['Limb elevation, cool compress', 'Mark borders with pen to monitor progression', 'No aspiration/blood culture needed for uncomplicated cellulitis', 'If purulent (abscess) or MRSA suspected â†’ add vancomycin'],
        pitfalls: ['GAS cellulitis rapidly progressive; do NOT delay IV Abx for non-toxic appearing children', 'If recent varicella or immunocompromised â†’ higher risk Staph.; cover with vancomycin', 'Oral Abx inadequate for systemic signs or rapid spread'],
        shelfPearl: 'Non-purulent cellulitis = IV cephalosporin (cefazolin or ceftriaxone). GAS is most common cause; assumes streptococcal initially. If MRSA risk (recent doxycycline, varicella) â†’ add vancomycin.'
      },
      {
        id: 'vc16',
        title: 'Kawasaki Disease',
        age: '3-year-old',
        figure: 'child',
        presentation: ['Fever â‰¥5 days, unresponsive to Abx', 'Polymorphous rash, bilateral conjunctivitis', 'Strawberry tongue, lip cracking, peeling', 'Cervical lymphadenitis (unilateral)'],
        affectedAreas: [
          { region: 'throat', label: 'Strawberry tongue, pharyngitis' },
          { region: 'eyes', label: 'Bilateral non-exudative conjunctivitis' },
          { region: 'skin', label: 'Polymorphous rash' },
          { region: 'heart', label: 'Risk of coronary artery aneurysm' }
        ],
        question: 'What is the immediate treatment to prevent coronary complications?',
        options: ['Aspirin + antibiotics', 'IVIG + high-dose aspirin + echocardiography', 'Ibuprofen + observation', 'Penicillin V prophylaxis'],
        correct: 'IVIG + high-dose aspirin + echocardiography',
        treatment: {
          drug: 'IVIG + Aspirin (high-dose initially, then low-dose)',
          dose: 'IVIG: 2 g/kg single infusion; Aspirin: 80â€“100 mg/kg/day div QID (high-dose) x 14d, then 3â€“5 mg/kg/day single dose x 6â€“8 weeks',
          route: 'IV (IVIG); PO (aspirin)',
          duration: 'IVIG single dose; aspirin high-dose x 2 weeks, then low-dose x 6â€“8 weeks'
        },
        additionalMgmt: ['Baseline & repeat echocardiography at 2 weeks & 8 weeks to assess for coronary aneurysm', 'Aspirin for antiplatelet effect (reduces thrombosis risk)', 'Long-term anticoagulation if coronary aneurysm present', 'No antibiotics (viral, not bacterial)'],
        pitfalls: ['DELAYED diagnosis & treatment â†’ coronary aneurysm in 25% untreated', 'Often misdiagnosed as other rashes (scarlet fever, drug reaction); fever unresponsive to Abx is key clue', 'Echocardiography required to guide long-term anticoagulation'],
        shelfPearl: 'Kawasaki = fever â‰¥5d + â‰¥4 of 6 criteria (rash, conjunctivitis, strawberry tongue, extremity edema/peeling, cervical LAD, lip/mouth changes). URGENT IVIG + high-dose aspirin to prevent CAA. Echo required.'
      },
      {
        id: 'vc17',
        title: 'Septic Arthritis',
        age: '4-year-old',
        figure: 'child',
        presentation: ['Acute knee swelling, warmth, severe pain', 'Fever 39Â°C, refusal to walk', 'Toxic appearance, limited range of motion', 'ESR elevated, possible positive blood culture'],
        affectedAreas: [
          { region: 'msk', label: 'Swollen, hot joint (knee)' }
        ],
        question: 'What is the next diagnostic step?',
        options: ['Start antibiotics without delay', 'Arthrocentesis with Gram stain, culture, cell count, glucose', 'MRI to confirm diagnosis', 'Ibuprofen & observe'],
        correct: 'Arthrocentesis with Gram stain, culture, cell count, glucose',
        treatment: {
          drug: 'IV Ceftriaxone + Vancomycin (pending culture)',
          dose: 'Ceftrx: 50â€“80 mg/kg/day div Q8h; Van: 40â€“60 mg/kg/day div Q6h',
          route: 'IV',
          duration: '2â€“4 weeks (longer if specific organism or complications)'
        },
        additionalMgmt: ['Urgent arthrocentesis for synovial analysis & culture', 'Blood culture', 'Imaging (ultrasound or MRI) if diagnosis unclear', 'Orthopedic consult if evidence of joint damage or need for washout', 'Immobilization, analgesia, physical therapy'],
        pitfalls: ['Delayed diagnosis â†’ permanent joint damage, cartilage loss', 'Do NOT wait for imaging; arthrocentesis & empiric Abx immediately', 'S. aureus most common (including MRSA); need vancomycin coverage', 'GAS (streptococcus) can also cause acute arthritis; cephalosporin covers both'],
        shelfPearl: 'Septic arthritis = EMERGENCY. Arthrocentesis (not aspirate is diagnostic) â†’ synovial WBC >50k (often >100k), positive Gram stain/culture. Start IV cephalosporin + vancomycin immediately. Orthopedic washout often needed.'
      },
      {
        id: 'vc18',
        title: 'Osteomyelitis',
        age: '8-year-old',
        figure: 'child',
        presentation: ['Acute bone pain, limp, fever 38.8Â°C', 'Localized swelling, erythema over tibia', 'Elevated ESR & CRP, elevated WBC', 'Possible recent trauma or skin infection'],
        affectedAreas: [
          { region: 'msk', label: 'Focal bone pain, swelling (metaphyseal region)' }
        ],
        question: 'What is the appropriate initial therapy?',
        options: ['Oral cephalexin at home', 'IV ceftriaxone + vancomycin', 'Ibuprofen & observation', 'Penicillin V only'],
        correct: 'IV ceftriaxone + vancomycin',
        treatment: {
          drug: 'IV Ceftriaxone + Vancomycin',
          dose: 'Ceftrx: 50â€“80 mg/kg/day div Q8h; Van: 40â€“60 mg/kg/day div Q6h',
          route: 'IV initial; can transition to PO (cephalexin or clindamycin) after clinical improvement & sensitivities',
          duration: '4â€“6 weeks (IV x 1â€“2 weeks, then PO to complete course)'
        },
        additionalMgmt: ['Blood culture & possible bone culture (aspiration or biopsy)', 'Imaging: X-ray (may be normal early), MRI or CT for confirmation & extent', 'Immobilization, pain control', 'Surgical drainage if large abscess or failed medical therapy'],
        pitfalls: ['Oral Abx alone inadequate for acute osteomyelitis; IV required initially', 'S. aureus (including MRSA) most common; empiric vancomycin coverage essential', 'Prolonged course required (4â€“6 weeks) to prevent relapse & complications (septic arthritis)'],
        shelfPearl: 'Acute osteomyelitis = fever + bone pain + elevated inflammatory markers. IV cephalosporin + vancomycin empirically (cover MRSA). Blood culture first. MRI confirms. 4â€“6 weeks total therapy (IV â†’ PO transition).'
      },
      {
        id: 'vc19',
        title: 'Viral Gastroenteritis',
        age: '14-month-old',
        figure: 'infant',
        presentation: ['Watery diarrhea x3 days, vomiting', 'Fever 38Â°C, mild dehydration', 'No blood in stool, no severe pain', 'Exposure to sick contacts'],
        affectedAreas: [
          { region: 'abdomen', label: 'Gastroenteritis, watery stools' }
        ],
        question: 'What is the cornerstone of management?',
        options: ['Empiric antibiotics', 'Oral rehydration therapy (ORT)', 'NPO status & IV fluids', 'Antidiarrheal agents'],
        correct: 'Oral rehydration therapy (ORT)',
        treatment: {
          drug: 'NO antibiotics (viral)',
          dose: 'ORT: World Health Organization formula (sodium 75 mEq/L, glucose 75 mmol/L, osmolarity 245)',
          route: 'PO small, frequent amounts; IV if moderateâ€“severe dehydration or unable to tolerate PO',
          duration: 'Continue until diarrhea resolves (typically 5â€“7 days)'
        },
        additionalMgmt: ['Continue breastfeeding if applicable', 'Resume age-appropriate diet (BRAT diet, soft foods) once oral intake tolerated', 'Monitor hydration status, urine output', 'Hand hygiene, infection control'],
        pitfalls: ['DO NOT give antibiotics (viral illness)', 'Antidiarrheal agents (loperamide) contraindicated in young children & bloody diarrhea', 'Hypernatremic dehydration risk if high insensible losses; use hypotonic ORT carefully'],
        shelfPearl: 'Viral gastroenteritis = ORT is FIRST-LINE. No antibiotics. Resume feeding early. IV fluids only if moderateâ€“severe dehydration or unable to tolerate PO. Rotavirus vaccine has reduced severity.'
      },
      {
        id: 'vc20',
        title: 'Clostridioides difficile Colitis',
        age: '6-year-old',
        figure: 'child',
        presentation: ['Profuse diarrhea x4 days after amoxicillin course', 'Fever 38.5Â°C, abdominal cramping', 'Positive C. difficile toxin PCR', 'No blood in stool initially'],
        affectedAreas: [
          { region: 'abdomen', label: 'Antibiotic-associated colitis, diarrhea' }
        ],
        question: 'What is the initial treatment?',
        options: ['Continue amoxicillin', 'Metronidazole', 'Fidaxomicin or vancomycin', 'Loperamide'],
        correct: 'Fidaxomicin or vancomycin',
        treatment: {
          drug: 'Fidaxomicin (preferred) OR Oral Vancomycin',
          dose: 'Fidax: 10 mg/kg/day div BID (max 400 mg/day); Vanco: 15â€“25 mg/kg/day div QID (max 125 mg/dose)',
          route: 'PO',
          duration: '10 days'
        },
        additionalMgmt: ['Discontinue offending antibiotic (amoxicillin)', 'Supportive care: fluid repletion, electrolyte correction', 'Avoid antiperistaltic agents (loperamide)', 'Test of cure NOT recommended; repeat testing only if symptoms persist'],
        pitfalls: ['Metronidazole inferior to vancomycin; reserved only for mildâ€“moderate disease (toxin B-negative)', 'AVOID loperamide (toxic megacolon risk)', 'Fulminant colitis (toxic megacolon, perforation) = ICU care, possible colectomy'],
        shelfPearl: 'C. difficile infection = fidaxomicin or vancomycin PO x 10 days. Discontinue causative Abx. Avoid antidiarrheals. Monitor for fulminant disease. Recurrence ~25%; consider probiotics (uncertain benefit).'
      },
      {
        id: 'vc21',
        title: 'Neonatal HSV Infection',
        age: '2-week-old',
        figure: 'infant',
        presentation: ['Vesicular rash on scalp & face', 'Fever, irritability, poor feeding', 'Mother with history of genital herpes', 'HSV PCR positive on fluid/CSF'],
        affectedAreas: [
          { region: 'skin', label: 'Vesicular rash, pustules on face/scalp' },
          { region: 'head', label: 'CNS involvement (meningitis, encephalitis)' }
        ],
        question: 'What is the immediate treatment?',
        options: ['Observe & supportive care', 'IV acyclovir 20 mg/kg Q8h', 'Oral acyclovir', 'Topical antibiotic ointment'],
        correct: 'IV acyclovir 20 mg/kg Q8h',
        treatment: {
          drug: 'IV Acyclovir',
          dose: '20 mg/kg IV Q8h',
          route: 'IV (slow infusion over â‰¥1 hour to prevent nephrotoxicity)',
          duration: '10â€“14 days'
        },
        additionalMgmt: ['Lumbar puncture with CSF analysis (HSV PCR, culture, cell count)', 'Blood culture', 'Skin lesion culture/PCR', 'Monitor renal function & hydration (acyclovir nephrotoxicity risk)', 'Supportive care, temperature regulation'],
        pitfalls: ['DELAYED treatment â†’ high mortality & morbidity (CNS damage, disseminated disease)', 'HSV neonatalitis can present with disseminated disease (liver, lungs, CNS) without skin rash', 'Acyclovir nephrotoxicity; ensure adequate hydration & slow IV infusion'],
        shelfPearl: 'Neonatal HSV = URGENT IV acyclovir (20 mg/kg Q8h). Skin vesicles OR maternal genital HSV history â†’ assume HSV until proven otherwise. High mortality if untreated. CSF analysis & culture essential.'
      },
      {
        id: 'vc22',
        title: 'Congenital Syphilis',
        age: '6 weeks (with manifestations)',
        figure: 'infant',
        presentation: ['Hepatosplenomegaly, jaundice', 'Maculopapular rash on palms/soles', 'Snuffles (nasal congestion), pseudoparalysis of limbs', 'Maternal untreated syphilis during pregnancy'],
        affectedAreas: [
          { region: 'abdomen', label: 'Hepatosplenomegaly' },
          { region: 'skin', label: 'Maculopapular rash on palms, soles' },
          { region: 'throat', label: 'Snuffles (mucopurulent nasal discharge)' },
          { region: 'msk', label: 'Pseudoparalysis from osteochondritis' }
        ],
        question: 'What is the appropriate treatment?',
        options: ['Oral penicillin V', 'IV Penicillin G 50,000 units/kg Q12h', 'Intramuscular benzathine penicillin G', 'Oral cephalexin'],
        correct: 'IV Penicillin G 50,000 units/kg Q12h',
        treatment: {
          drug: 'IV Penicillin G',
          dose: '50,000 units/kg IV Q12h',
          route: 'IV',
          duration: '10 days'
        },
        additionalMgmt: ['Serology: RPR/VDRL (titer comparison), FTA-ABS or TP-PA confirmation', 'Long bone X-rays (periostitis, osteochondritis)', 'CBC, LFTs, CSF analysis if neurosyphilis concern', 'Maternal partner treatment (benzathine PCN G 2.4 million units IM x 1)'],
        pitfalls: ['Passive maternal antibodies complicate interpretation of serology; infant titers higher than mother\'s suggest active infection', 'Untreated â†’ permanent sequelae (Hutchinson triad, blindness, deaf)', 'Penicillin is only proven effective agent'],
        shelfPearl: 'Congenital syphilis = IV penicillin G x 10 days. Diagnose via maternal serology + infant titer comparison. Long-term follow-up: serology, developmental monitoring, audiometry. Prevention: prenatal maternal screening & treatment.'
      },
      {
        id: 'vc23',
        title: 'Infant Botulism',
        age: '4-month-old',
        figure: 'infant',
        presentation: ['Constipation x1 week, then weakness', 'Weak cry, poor feeding, weak suck', 'Ptosis, dilated pupils, loss of facial expression', 'History of honey exposure'],
        affectedAreas: [
          { region: 'head', label: 'Ptosis, dilated pupils, weak facial muscles' },
          { region: 'chest', label: 'Weak respiratory muscles, risk of respiratory failure' }
        ],
        question: 'What is the treatment for infant botulism?',
        options: ['Antibiotics (amoxicillin)', 'Botulism immune globulin (BIG-IV)', 'Supportive care alone', 'Aminoglycosides'],
        correct: 'Botulism immune globulin (BIG-IV)',
        treatment: {
          drug: 'Botulism Immune Globulin (BIG-IV) Â± Supportive Care',
          dose: 'BIG-IV: 50 mg/kg single IV infusion',
          route: 'IV',
          duration: 'Single infusion; supportive care ongoing until recovery (weeks to months)'
        },
        additionalMgmt: ['Monitor respiratory status; mechanical ventilation if needed', 'NO antibiotics (can worsen disease by lyzing spores)', 'Supportive feeding (nasogastric or parenteral nutrition)', 'Stool culture for toxin identification (confirmatory)'],
        pitfalls: ['DO NOT give antibiotics; aminoglycosides contraindicated (worsen paralysis)', 'Gradual onset of weakness can mimic other conditions (SIDS risk; some infants die unexpectedly)', 'BIG-IV modifies toxin-SNARE binding; reduces duration of illness if given early'],
        shelfPearl: 'Infant botulism = descending paralysis (ptosis, weak suck, weak cry) after constipation. NO antibiotics. BIG-IV shortens illness. Avoid honey <1 year (spore source). Monitor respiratory status; may need ICU support.'
      },
      {
        id: 'vc24',
        title: 'Epiglottitis',
        age: '5-year-old',
        figure: 'child',
        presentation: ['Acute stridor, difficulty swallowing', 'Fever 39.2Â°C, tripod positioning', 'Drooling, anxious, toxic appearance', 'Classic "thumbprint" sign on X-ray (large epiglottis)'],
        affectedAreas: [
          { region: 'throat', label: 'Swollen epiglottis, airway compromise' }
        ],
        question: 'What is the immediate management?',
        options: ['Nebulized dexamethasone & observe', 'DO NOT examine throat; secure airway & empiric Abx', 'Flexible laryngoscopy at bedside', 'Oral penicillin V'],
        correct: 'DO NOT examine throat; secure airway & empiric Abx',
        treatment: {
          drug: 'IV Ceftriaxone (+ Vancomycin if MRSA risk)',
          dose: 'Ceftrx: 50â€“80 mg/kg/day div Q8h; Van: 40â€“60 mg/kg/day div Q6h',
          route: 'IV',
          duration: '7â€“10 days'
        },
        additionalMgmt: ['DO NOT examine pharynx (can trigger complete obstruction)', 'Keep child calm; avoid agitation', 'Secure airway (endotracheal intubation) BEFORE giving Abx if stridor at rest', 'Direct visualization (fiberoptic laryngoscopy) only in OR setting if airway control available', 'Do NOT manipulate airway unless ready to intubate'],
        pitfalls: ['WRONG: examining throat or removing foreign object without airway backup â†’ complete airway loss', 'Hib vaccine has dramatically reduced epiglottitis; now rare but EMERGENCY when it occurs', 'Stridor at rest = imminent airway loss; intubate immediately'],
        shelfPearl: 'Epiglottitis = AIRWAY EMERGENCY. Acute stridor + fever + toxic appearance = assume epiglottitis. DO NOT examine throat. Secure airway first (ideally fiberoptic intubation in OR), THEN give IV cephalosporin + vancomycin. Hib vaccine prophylaxis.'
      },
      {
        id: 'vc25',
        title: 'Cervical Lymphadenitis',
        age: '4-year-old',
        figure: 'child',
        presentation: ['Unilateral neck swelling x3 days', 'Fever 38.5Â°C, tender node', 'No fluctuance, surrounding cellulitis', 'Recent upper respiratory infection'],
        affectedAreas: [
          { region: 'ears', label: 'Anterior cervical lymphadenitis, tender node' }
        ],
        question: 'What is the next diagnostic & therapeutic step?',
        options: ['Warm compresses & observation', 'Ultrasound to assess for abscess; culture if fluctuant; empiric Abx if rapid progression', 'IV cephalosporin monotherapy', 'Incision & drainage'],
        correct: 'Ultrasound to assess for abscess; culture if fluctuant; empiric Abx if rapid progression',
        treatment: {
          drug: 'Amoxicillin-clavulanate OR IV Cephalosporin + Vancomycin (if severe/immunocompromised)',
          dose: 'Amox-clav: 25â€“45 mg/kg/day div TID; Ceftrx: 50â€“80 mg/kg/day div Q8h; Van: 40â€“60 mg/kg/day div Q6h',
          route: 'PO (mild) or IV (severe, abscess)',
          duration: '7â€“10 days'
        },
        additionalMgmt: ['Ultrasound to differentiate reactive lymphadenitis from suppurative (abscess)', 'If abscess present & fluctuant: ultrasound-guided aspiration/drainage Â± culture', 'Warm compresses, analgesics', 'Evaluate for source (pharyngitis, skin infection, dental disease)'],
        pitfalls: ['S. aureus (including MRSA) & GAS cause suppurative lymphadenitis; empiric cover needed', 'Non-suppurative lymphadenitis (reactive) may resolve with Abx + supportive care', 'TB lymphadenitis or atypical mycobacterial infection (MAC) can mimic; consider if chronic, minimal systemic symptoms, or immunocompromised'],
        shelfPearl: 'Cervical lymphadenitis = unilateral node swelling + fever. Ultrasound to assess for abscess. Reactive lymphadenitis: oral amoxicillin-clavulanate. Suppurative: IV cephalosporin Â± vancomycin Â± I&D. Culture if purulent.'
      }
    ];

    function VisualClinicalCases() {
      const [caseIdx, setCaseIdx] = useState(0);
      const [answered, setAnswered] = useState(false);
      const [selectedAnswer, setSelectedAnswer] = useState(null);
      const [score, setScore] = useState({ correct: 0, total: 0 });
      const game = useGameQuiz('visual_cases');
      const [, forceUpdate] = useState(0);

      const shuffledCases = useMemo(() => {
        return VISUAL_CASES.slice().sort(() => Math.random() - 0.5);
      }, []);

      const currentCase = shuffledCases[caseIdx];

      const handleAnswer = (option) => {
        if (answered) return;
        const isCorrect = option === currentCase.correct;
        setSelectedAnswer(option);
        setAnswered(true);
        setScore(s => ({ correct: s.correct + (isCorrect ? 1 : 0), total: s.total + 1 }));
        game.onAnswer(currentCase.id, isCorrect);
      };

      const handleNext = () => {
        if (caseIdx < shuffledCases.length - 1) {
          setCaseIdx(caseIdx + 1);
          setAnswered(false);
          setSelectedAnswer(null);
        } else {
          const finalScore = score.correct / score.total;
          game.onComplete(finalScore);
          IDProgress.save('visual_cases', { correct: score.correct, total: score.total, missed: [] });
          setCaseIdx(0);
          setScore({ correct: 0, total: 0 });
          setAnswered(false);
          setSelectedAnswer(null);
        }
      };

      if (!currentCase) return <div className="p-8 text-slate-800">No cases available.</div>;

      const BodyDiagram = currentCase.figure === 'infant' ? InfantBody : ChildBody;

      return (
        <div className="animate-fadeIn p-8 max-w-7xl mx-auto space-y-6">
          <GameHeader />
          <div className="flex items-center justify-between">
            <div className="text-sm font-semibold text-slate-700">
              Case {caseIdx + 1} of {shuffledCases.length}
            </div>
            <ComboDisplay combo={game.combo} />
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
            {/* LEFT: Body Diagram with Callouts */}
            <div className="bg-slate-50 rounded-xl p-8 border border-slate-200">
              <div className="mb-6 text-center">
                <h3 className="text-lg font-bold text-slate-800 mb-1">{currentCase.title}</h3>
                <p className="text-sm text-slate-600">{currentCase.age}</p>
              </div>
              <div className="h-96">
                <BodyDiagram affectedAreas={currentCase.affectedAreas} />
              </div>
              <div className="mt-6 space-y-3">
                {currentCase.affectedAreas.map((area, i) => (
                  <div key={i} className="flex items-start gap-3 p-3 bg-white border border-red-200 rounded-lg">
                    <div className="w-2 h-2 bg-red-500 rounded-full mt-1.5 shrink-0" />
                    <div>
                      <div className="text-xs font-semibold text-slate-800">{area.region.toUpperCase()}</div>
                      <div className="text-xs text-slate-600">{area.label}</div>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* RIGHT: Presentation, Question, MCQ */}
            <div className="space-y-6">
              {/* Presentation */}
              <div className="bg-white border border-slate-200 rounded-xl p-6">
                <h4 className="text-sm font-bold text-slate-700 mb-4">CLINICAL PRESENTATION</h4>
                <div className="space-y-2">
                  {currentCase.presentation.map((item, i) => (
                    <div key={i} className="flex items-start gap-3">
                      <span className="text-slate-400 text-xs font-bold mt-1">â€¢</span>
                      <span className="text-sm text-slate-700">{item}</span>
                    </div>
                  ))}
                </div>
              </div>

              {/* Question */}
              <div className="bg-white border border-slate-200 rounded-xl p-6">
                <h4 className="text-sm font-bold text-slate-800 mb-4">{currentCase.question}</h4>
                <div className="space-y-3">
                  {currentCase.options.map((option, i) => {
                    const isSelected = selectedAnswer === option;
                    const isCorrectOption = option === currentCase.correct;
                    let btnClass = 'bg-white border-2 border-slate-200 text-slate-800 hover:border-blue-300 hover:bg-blue-50';

                    if (answered) {
                      if (isCorrectOption) {
                        btnClass = 'bg-emerald-50 border-2 border-emerald-500 text-emerald-800 font-semibold';
                      } else if (isSelected && !isCorrectOption) {
                        btnClass = 'bg-red-50 border-2 border-red-500 text-red-800 font-semibold';
                      }
                    }

                    return (
                      <button
                        key={i}
                        onClick={() => handleAnswer(option)}
                        disabled={answered}
                        className={`w-full text-left p-4 rounded-lg transition ${btnClass}`}
                      >
                        <div className="flex items-start gap-3">
                          <div className={`w-5 h-5 rounded border-2 mt-0.5 shrink-0 flex items-center justify-center text-xs font-bold ${
                            answered && isSelected ? (isCorrectOption ? 'bg-emerald-500 border-emerald-500 text-white' : 'bg-red-500 border-red-500 text-white') : 'border-slate-300'
                          }`}>
                            {answered && isSelected && (isCorrectOption ? 'âœ“' : 'âœ—')}
                          </div>
                          <span className="font-medium">{option}</span>
                        </div>
                      </button>
                    );
                  })}
                </div>
              </div>

              {/* After Answer: Explanation */}
              {answered && (
                <div className="space-y-4 animate-fadeIn">
                  {selectedAnswer === currentCase.correct && (
                    <div className="bg-emerald-50 border-2 border-emerald-500 rounded-xl p-6">
                      <div className="text-lg font-bold text-emerald-800 mb-2">Correct!</div>
                    </div>
                  )}
                  {selectedAnswer !== currentCase.correct && (
                    <div className="bg-red-50 border-2 border-red-500 rounded-xl p-6">
                      <div className="text-sm font-bold text-red-800 mb-2">Incorrect</div>
                      <div className="text-sm text-red-700">Correct answer: <strong>{currentCase.correct}</strong></div>
                    </div>
                  )}

                  {/* Treatment Details */}
                  <div className="bg-white border border-slate-200 rounded-xl p-6">
                    <h4 className="text-sm font-bold text-slate-800 mb-4">TREATMENT</h4>
                    <div className="space-y-3 text-sm">
                      <div>
                        <div className="font-semibold text-slate-700">Drug:</div>
                        <div className="text-slate-600">{currentCase.treatment.drug}</div>
                      </div>
                      <div>
                        <div className="font-semibold text-slate-700">Dose:</div>
                        <div className="font-mono text-xs bg-slate-50 p-3 rounded border border-slate-200 text-slate-700">{currentCase.treatment.dose}</div>
                      </div>
                      <div>
                        <div className="font-semibold text-slate-700">Route:</div>
                        <div className="text-slate-600">{currentCase.treatment.route}</div>
                      </div>
                      <div>
                        <div className="font-semibold text-slate-700">Duration:</div>
                        <div className="text-slate-600">{currentCase.treatment.duration}</div>
                      </div>
                    </div>
                  </div>

                  {/* Additional Management */}
                  <div className="bg-white border border-slate-200 rounded-xl p-6">
                    <h4 className="text-sm font-bold text-slate-800 mb-4">ADDITIONAL MANAGEMENT</h4>
                    <ul className="space-y-2 text-sm text-slate-700">
                      {currentCase.additionalMgmt.map((item, i) => (
                        <li key={i} className="flex items-start gap-3">
                          <span className="text-slate-400 mt-1">â€¢</span>
                          <span>{item}</span>
                        </li>
                      ))}
                    </ul>
                  </div>

                  {/* Pitfalls */}
                  <div className="bg-red-50 border border-red-300 rounded-xl p-6">
                    <h4 className="text-sm font-bold text-red-800 mb-4">COMMON PITFALLS</h4>
                    <ul className="space-y-2 text-sm text-red-700">
                      {currentCase.pitfalls.map((item, i) => (
                        <li key={i} className="flex items-start gap-3">
                          <span className="font-bold mt-0.5">âš </span>
                          <span>{item}</span>
                        </li>
                      ))}
                    </ul>
                  </div>

                  {/* Shelf Pearl */}
                  <div className="bg-amber-50 border border-amber-300 rounded-xl p-6">
                    <h4 className="text-sm font-bold text-amber-800 mb-2">SHELF PEARL</h4>
                    <p className="text-sm text-amber-700">{currentCase.shelfPearl}</p>
                  </div>

                  {/* Next Button */}
                  <button
                    onClick={handleNext}
                    className="w-full py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold rounded-lg hover:from-blue-700 hover:to-blue-800 transition"
                  >
                    {caseIdx < shuffledCases.length - 1 ? `Next Case (${caseIdx + 1}/${shuffledCases.length})` : 'Finish Quiz'}
                  </button>
                </div>
              )}
            </div>
          </div>

          {game.overlays}
        </div>
      );
    }

    function IDHubView() {
      const [tab, setTab] = useState('overview');
      const [idData, setIdData] = useState(null);
      const [loading, setLoading] = useState(true);
      useEffect(() => {
        fetch('/api/id-antibiotics').then(r => r.json()).then(d => { setIdData(d); setLoading(false); }).catch(() => setLoading(false));
      }, []);
      if (loading) return <LoadingScreen />;
      if (!idData) return <div className="p-8 text-slate-600">Failed to load ID data.</div>;

      const tabs = [
        { id: 'overview', label: 'Overview', icon: 'ğŸ¦ ' },
        { id: 'bug_drug', label: 'Bug-Drug Matcher', icon: 'ğŸ¯' },
        { id: 'whats_the_bug', label: "What's the Bug?", icon: 'ğŸ”¬' },
        { id: 'rash_gallery', label: 'Rash Gallery', icon: 'ğŸ”´' },
        { id: 'empiric', label: 'Empiric Therapy', icon: 'ğŸ’Š' },
        { id: 'spectrum', label: 'Antibiotic Spectrum', icon: 'ğŸ“Š' },
        { id: 'age_bugs', label: 'Age-Based Bugs', icon: 'ğŸ‘¶' },
        { id: 'vaccines', label: 'Vaccine Trainer', icon: 'ğŸ’‰' },
        { id: 'pearls', label: 'Pearls & Associations', icon: 'ğŸ’¡' },
        { id: 'side_effects', label: 'Side Effects', icon: 'âš ï¸' },
        { id: 'visual_cases', label: 'Visual Cases', icon: 'ğŸ§' },
        { id: 'study_guide', label: 'AI Study Guide', icon: 'ğŸ§ ' },
      ];
      return (
        <div className="animate-fadeIn p-8 max-w-6xl mx-auto">
          <div className="mb-8">
            <div className="flex items-center gap-3 mb-2"><span className="text-3xl">ğŸ¦ </span>
              <h1 className="text-2xl font-bold text-slate-900 tracking-tight">Infectious Disease & Antibiotics Hub</h1>
            </div>
            <p className="text-sm text-slate-600 leading-relaxed">Deep-dive into pediatric ID â€” master bugs, drugs, empiric therapy, and shelf-exam patterns through <strong className="text-slate-700">11 interactive modules</strong>.</p>
          </div>
          <div className="flex flex-wrap gap-1.5 mb-8 pb-3 border-b border-slate-700">
            {tabs.map(t => (
              <button key={t.id} onClick={() => setTab(t.id)}
                className={`flex items-center gap-1.5 px-3.5 py-2 text-xs rounded-lg font-medium transition ${tab === t.id ? 'bg-lime-500/20 text-lime-300 border border-lime-500/30' : 'bg-slate-800/40 text-slate-400 border border-slate-700 hover:text-slate-300 hover:bg-slate-800'}`}>
                <span className="text-sm">{t.icon}</span> {t.label}
              </button>
            ))}
          </div>
          {tab === 'overview' && <IDOverview idData={idData} setTab={setTab} />}
          {tab === 'bug_drug' && <BugDrugMatcher pairs={idData.bugDrugPairs || []} />}
          {tab === 'whats_the_bug' && <WhatsTheBugQuiz items={idData.whatsTheBug || []} />}
          {tab === 'rash_gallery' && <RashGallery rashes={idData.rashToDiagnosis || []} />}
          {tab === 'empiric' && <EmpiricTherapyCards syndromes={idData.empiricTherapy || []} />}
          {tab === 'spectrum' && <AntibioticSpectrum drugs={idData.antibioticSpectrum || []} />}
          {tab === 'age_bugs' && <AgeBasedBugs groups={idData.ageBasedBugs || []} />}
          {tab === 'vaccines' && <VaccineTrainer vaccines={idData.vaccineSchedule || []} />}
          {tab === 'pearls' && <PearlsAssociations pearls={idData.clinicalPearls || []} associations={idData.associations || []} />}
          {tab === 'side_effects' && <SideEffectsView items={idData.sideEffectsContraindications || []} />}
          {tab === 'visual_cases' && <VisualClinicalCases />}
          {tab === 'study_guide' && <StudyGuide idData={idData} setTab={setTab} />}
        </div>
      );
    }

    // â”€â”€â”€ ID OVERVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function IDOverview({ idData, setTab }) {
      const modules = [
        { id: 'bug_drug', icon: 'ğŸ¯', title: 'Bug-Drug Matcher', desc: 'Match organisms to first-line antibiotics in a timed game', count: `${(idData.bugDrugPairs||[]).length} pairs`, color: 'bg-lime-500/20 text-lime-300 border-lime-500/30' },
        { id: 'whats_the_bug', icon: 'ğŸ”¬', title: "What's the Bug?", desc: 'Progressive clue reveal â€” identify the organism from clinical findings', count: `${(idData.whatsTheBug||[]).length} cases`, color: 'bg-cyan-500/20 text-cyan-300 border-cyan-500/30' },
        { id: 'rash_gallery', icon: 'ğŸ”´', title: 'Rash Gallery', desc: 'Match classic pediatric rash descriptions to diagnoses', count: `${(idData.rashToDiagnosis||[]).length} rashes`, color: 'bg-rose-950/20 text-rose-300 border-rose-500/30' },
        { id: 'empiric', icon: 'ğŸ’Š', title: 'Empiric Therapy', desc: 'Syndrome-based empiric antibiotic selection with reasoning', count: `${(idData.empiricTherapy||[]).length} syndromes`, color: 'bg-blue-500/20 text-blue-300 border-blue-500/30' },
        { id: 'spectrum', icon: 'ğŸ“Š', title: 'Antibiotic Spectrum', desc: 'Visual coverage profiles for key pediatric antibiotics', count: `${(idData.antibioticSpectrum||[]).length} drugs`, color: 'bg-violet-500/20 text-violet-300 border-violet-500/30' },
        { id: 'age_bugs', icon: 'ğŸ‘¶', title: 'Age-Based Bugs', desc: 'Which organisms to suspect at each pediatric age group', count: `${(idData.ageBasedBugs||[]).length} age groups`, color: 'bg-amber-500/20 text-amber-300 border-amber-500/30' },
        { id: 'vaccines', icon: 'ğŸ’‰', title: 'Vaccine Trainer', desc: 'Interactive quiz on pediatric immunization schedules', count: `${(idData.vaccineSchedule||[]).length} vaccines`, color: 'bg-emerald-500/20 text-emerald-300 border-emerald-500/30' },
        { id: 'pearls', icon: 'ğŸ’¡', title: 'Pearls & Associations', desc: 'High-yield buzzword associations and clinical pearls', count: `${(idData.clinicalPearls||[]).length + (idData.associations||[]).length} items`, color: 'bg-yellow-500/20 text-yellow-300 border-yellow-500/30' },
        { id: 'side_effects', icon: 'âš ï¸', title: 'Side Effects & Contraindications', desc: 'Age-specific drug restrictions and NBME trap exceptions', count: `${(idData.sideEffectsContraindications||[]).length} drugs`, color: 'bg-red-500/20 text-red-300 border-red-500/30' },
        { id: 'visual_cases', icon: 'ğŸ§', title: 'Visual Clinical Cases', desc: 'Body-diagram cases with treatment decisions, dosing, pitfalls & shelf pearls', count: '25 cases', color: 'bg-teal-500/20 text-teal-300 border-teal-500/30' },
      ];
      const getProgressBadge = (moduleId) => {
        const progress = IDProgress.getLatest(moduleId);
        if (!progress) return null;
        const color = progress.pct >= 80 ? 'bg-emerald-500/20 text-emerald-300' : progress.pct >= 60 ? 'bg-amber-500/20 text-amber-300' : 'bg-red-500/20 text-red-300';
        return <span className={`text-[10px] px-2 py-1 rounded-full font-medium ${color}`}>{progress.pct}%</span>;
      };
      return (
        <div className="space-y-8">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <StatCard label="Bug-Drug Pairs" value={(idData.bugDrugPairs||[]).length} sub="organisms + treatments" />
            <StatCard label="Clinical Scenarios" value={(idData.whatsTheBug||[]).length} sub="pattern recognition" />
            <StatCard label="Antibiotics" value={(idData.antibioticSpectrum||[]).length} sub="with full spectra" />
            <StatCard label="Vaccines" value={(idData.vaccineSchedule||[]).length} sub="schedule entries" />
          </div>
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {modules.map(m => (
              <button key={m.id} onClick={() => setTab(m.id)}
                className={`flex items-start gap-3.5 p-5 rounded-xl border text-left hover:brightness-110 transition relative ${m.color}`}>
                <span className="text-2xl mt-0.5">{m.icon}</span>
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2 mb-0.5">
                    <div className="font-semibold text-sm">{m.title}</div>
                    {getProgressBadge(m.id)}
                  </div>
                  <div className="text-xs opacity-70 leading-relaxed">{m.desc}</div>
                  <div className="text-[10px] mt-2 opacity-50">{m.count}</div>
                </div>
              </button>
            ))}
          </div>
        </div>
      );
    }

    // â”€â”€â”€ BUG-DRUG MATCHER GAME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function BugDrugMatcher({ pairs }) {
      const [queue, setQueue] = useState(() => [...pairs].sort(() => Math.random() - 0.5));
      const [idx, setIdx] = useState(0);
      const [score, setScore] = useState({ correct: 0, total: 0 });
      const [selected, setSelected] = useState(null);
      const [showResult, setShowResult] = useState(false);
      const [streak, setStreak] = useState(0);
      const [bestStreak, setBestStreak] = useState(0);
      const [missed, setMissed] = useState([]);
      const savedRef = useRef(false);
      const game = useGameQuiz('bug_drug');

      const current = queue[idx];
      const isComplete = !current && score.total > 0;

      useEffect(() => {
        if (isComplete && !savedRef.current) {
          IDProgress.save('bug_drug', { correct: score.correct, total: score.total, missed, bestStreak });
          game.onComplete({ correct: score.correct, total: score.total });
          savedRef.current = true;
        }
      }, [isComplete]);

      const options = useMemo(() => {
        if (!current || !current.drug) return [];
        const correct = current.drug;
        const others = (pairs || []).filter(d => d.drug !== correct).map(d => d.drug);
        const unique = [...new Set(others)].sort(() => Math.random() - 0.5).slice(0, 3);
        return [...unique, correct].sort(() => Math.random() - 0.5);
      }, [current, pairs]);

      const handleSelect = (opt) => {
        if (showResult) return;
        setSelected(opt);
        setShowResult(true);
        const isCorrect = opt === current.drug;
        game.onAnswer(current.id, isCorrect);
        setScore(prev => ({ correct: prev.correct + (isCorrect ? 1 : 0), total: prev.total + 1 }));
        if (isCorrect) { const ns = streak + 1; setStreak(ns); if (ns > bestStreak) setBestStreak(ns); }
        else { setStreak(0); setMissed(prev => [...prev, { bug: current.bug, correctDrug: current.drug, yourAnswer: opt }]); }
      };

      if (isComplete) {
        const pct = Math.round(score.correct / Math.max(1, score.total) * 100);
        const best = IDProgress.getModule('bug_drug');
        const color = pct >= 80 ? 'text-emerald-400' : pct >= 60 ? 'text-amber-400' : 'text-red-400';
        return (
          <div className="max-w-2xl mx-auto py-8">
            <GameHeader />
            <div className="text-center mb-8">
              <div className="text-5xl mb-4">{pct >= 80 ? 'ğŸ†' : pct >= 60 ? 'ğŸ“ˆ' : 'ğŸ“š'}</div>
              <h2 className="text-xl font-bold text-slate-900 mb-1">Round Complete!</h2>
              <p className={`text-3xl font-bold ${color} mb-1`}>{pct}%</p>
              <p className="text-slate-600 text-sm">{score.correct} / {score.total} correct Â· Best streak: {bestStreak}</p>
              {best.attempts.length > 1 && <p className="text-xs text-slate-400 mt-1">Personal best: {best.bestScore}% Â· Attempt #{best.attempts.length}</p>}
            </div>
            {missed.length > 0 && (
              <div className="mb-8">
                <h3 className="text-xs font-bold text-red-400 uppercase tracking-wider mb-3">Missed Items â€” Review These</h3>
                <div className="space-y-2">
                  {missed.map((m, i) => (
                    <div key={i} className="flex items-center gap-3 p-3 bg-red-950/20 border border-red-800/20 rounded-lg text-sm">
                      <span className="text-red-400">âœ—</span>
                      <span className="text-slate-700 flex-1">{m.bug}</span>
                      <span className="text-slate-600">â†’</span>
                      <span className="text-emerald-400 font-medium">{m.correctDrug}</span>
                      <span className="text-[10px] text-red-300/50">(you: {m.yourAnswer})</span>
                    </div>
                  ))}
                </div>
              </div>
            )}
            {pct < 80 && (
              <div className="p-4 bg-amber-950/15 border border-amber-700/20 rounded-xl mb-6">
                <p className="text-xs text-amber-200/80 leading-relaxed">ğŸ’¡ <strong>Study tip:</strong> Focus on the {missed.length} bug-drug pairs above. Try the Antibiotic Spectrum module to understand WHY these drugs are first-line for each organism.</p>
              </div>
            )}
            <div className="flex gap-3 justify-center">
              <button onClick={() => { setQueue([...pairs].sort(() => Math.random() - 0.5)); setIdx(0); setScore({ correct: 0, total: 0 }); setStreak(0); setBestStreak(0); setMissed([]); savedRef.current = false; }}
                className="px-6 py-2.5 bg-lime-600 hover:bg-lime-500 text-white rounded-lg text-sm font-medium transition">Play Again</button>
            </div>
          </div>
        );
      }

      if (!current) return null;

      return (
        <div className="max-w-2xl mx-auto">
          <GameHeader />
          <div className="flex items-center justify-between mb-6">
            <div className="flex items-center gap-4">
              <span className="text-sm text-slate-600 tabular-nums font-medium">{idx + 1} / {queue.length}</span>
              {streak >= 3 && <span className="text-xs px-2.5 py-1 bg-amber-500/20 text-amber-300 rounded-full font-bold animate-fadeIn">ğŸ”¥ {streak} streak!</span>}
            </div>
            <div className="flex items-center gap-3"><span className="text-sm text-slate-400 tabular-nums">{score.correct} correct</span><ComboDisplay combo={game.combo} /></div>
          </div>

          <div className="bg-white border border-slate-300 rounded-xl p-7 mb-6">
            <div className="text-[10px] font-bold uppercase tracking-widest text-lime-400/70 mb-3">Identify the First-Line Treatment</div>
            <h2 className="text-lg font-bold text-slate-900 mb-2">{current.bug}</h2>
            <p className="text-sm text-slate-600 leading-relaxed">{current.context}</p>
            {current.hint && <p className="text-xs text-slate-400 mt-3 italic">ğŸ’¡ {current.hint}</p>}
            <div className="text-[10px] text-slate-600 mt-3">Age group: <span className="text-slate-400 capitalize">{current.ageGroup}</span></div>
          </div>

          <div className="space-y-2.5">
            {options.map((opt, i) => {
              let cls = 'bg-slate-50 border-slate-300 hover:border-slate-400';
              if (showResult) {
                if (opt === current.drug) cls = 'bg-emerald-950/30 border-emerald-500/60';
                else if (opt === selected) cls = 'bg-red-950/30 border-red-500/60';
                else cls = 'bg-slate-100 border-slate-300 opacity-40';
              }
              return (
                <button key={i} onClick={() => handleSelect(opt)} disabled={showResult}
                  className={`choice-btn w-full text-left p-4 rounded-xl border transition ${cls}`}>
                  <span className="text-sm text-slate-700">{opt}</span>
                </button>
              );
            })}
          </div>

          {showResult && (
            <button onClick={() => { setIdx(prev => prev + 1); setSelected(null); setShowResult(false); }}
              className="w-full mt-5 py-3 bg-lime-600 hover:bg-lime-500 text-white rounded-xl text-sm font-semibold transition">
              Next Bug â†’
            </button>
          )}
        {game.overlays}
        </div>
      );
    }

    // â”€â”€â”€ WHAT'S THE BUG? QUIZ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function WhatsTheBugQuiz({ items }) {
      const [queue, setQueue] = useState(() => [...items].sort(() => Math.random() - 0.5));
      const [idx, setIdx] = useState(0);
      const [revealedClues, setRevealedClues] = useState(1);
      const [guessed, setGuessed] = useState(false);
      const [selected, setSelected] = useState(null);
      const [score, setScore] = useState({ correct: 0, total: 0 });
      const [missed, setMissed] = useState([]);
      const savedRef = useRef(false);
      const game = useGameQuiz('whats_the_bug');

      const current = queue[idx];
      const isComplete = !current && score.total > 0;

      useEffect(() => {
        if (isComplete && !savedRef.current) {
          IDProgress.save('whats_the_bug', { correct: score.correct, total: score.total, missed });
          game.onComplete({ correct: score.correct, total: score.total });
          savedRef.current = true;
        }
      }, [isComplete]);

      const options = useMemo(() => {
        if (!current || !current.answer) return [];
        return [current.answer, ...(current.distractors || [])].sort(() => Math.random() - 0.5);
      }, [idx]);

      const handleGuess = (opt) => {
        if (guessed) return;
        setSelected(opt);
        setGuessed(true);
        const isCorrect = opt === current.answer;
        setScore(prev => ({ correct: prev.correct + (isCorrect ? 1 : 0), total: prev.total + 1 }));
        if (!isCorrect) setMissed(prev => [...prev, { clue: (current.clues||[]).join(' â†’ '), correctAnswer: current.answer, yourAnswer: opt }]);
        game.onAnswer(current.id, isCorrect);
      };

      if (isComplete) {
        const pct = Math.round(score.correct / Math.max(1, score.total) * 100);
        const best = IDProgress.getModule('whats_the_bug');
        const color = pct >= 80 ? 'text-emerald-400' : pct >= 60 ? 'text-amber-400' : 'text-red-400';
        return (
          <div className="max-w-2xl mx-auto py-8">
            <div className="text-center mb-8">
              <div className="text-5xl mb-4">{pct >= 80 ? 'ğŸ¯' : pct >= 60 ? 'ğŸ”' : 'ğŸ“š'}</div>
              <h2 className="text-xl font-bold text-slate-900 mb-1">Quiz Complete!</h2>
              <p className={`text-3xl font-bold ${color} mb-1`}>{pct}%</p>
              <p className="text-slate-600 text-sm">{score.correct} / {score.total} correct</p>
              {best.attempts.length > 1 && <p className="text-xs text-slate-400 mt-1">Personal best: {best.bestScore}% Â· Attempt #{best.attempts.length}</p>}
            </div>
            {missed.length > 0 && (
              <div className="mb-8">
                <h3 className="text-xs font-bold text-red-400 uppercase tracking-wider mb-3">Missed Cases â€” Study These Clue Patterns</h3>
                <div className="space-y-2">
                  {missed.map((m, i) => (
                    <div key={i} className="flex flex-col gap-2 p-3 bg-red-950/20 border border-red-800/20 rounded-lg text-sm">
                      <span className="text-slate-700 text-xs"><strong>Clues:</strong> {m.clue}</span>
                      <div className="flex items-center gap-2">
                        <span className="text-red-400">âœ—</span>
                        <span className="text-red-300/70 text-xs">Your answer:</span>
                        <span className="text-red-300">{m.yourAnswer}</span>
                        <span className="text-slate-600 mx-1">â†’</span>
                        <span className="text-emerald-400 font-medium text-xs">Correct:</span>
                        <span className="text-emerald-400">{m.correctAnswer}</span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
            {pct < 80 && (
              <div className="p-4 bg-amber-950/15 border border-amber-700/20 rounded-xl mb-6">
                <p className="text-xs text-amber-200/80 leading-relaxed">ğŸ’¡ <strong>Study tip:</strong> Review the {missed.length} missed cases above. Note the clinical clues and organism patterns to strengthen pattern recognition for shelf exams.</p>
              </div>
            )}
            <div className="flex gap-3 justify-center">
              <button onClick={() => { setQueue([...items].sort(() => Math.random() - 0.5)); setIdx(0); setRevealedClues(1); setGuessed(false); setSelected(null); setScore({ correct: 0, total: 0 }); setMissed([]); savedRef.current = false; }}
                className="px-6 py-2.5 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg text-sm font-medium transition">Play Again</button>
            </div>
          </div>
        );
      }

      if (!current) return null;

      return (
        <div className="max-w-2xl mx-auto">
          <GameHeader />
          <div className="flex items-center justify-between mb-6">
            <span className="text-sm text-slate-600 tabular-nums">{idx + 1} / {queue.length}</span>
            <span className={`text-[10px] px-2.5 py-1 rounded-full font-medium ${current?.difficulty === 'advanced' ? 'bg-red-500/20 text-red-300' : 'bg-blue-500/20 text-blue-300'}`}>{current?.difficulty || 'normal'}</span>
            <ComboDisplay combo={game.combo} />
          </div>

          <div className="bg-white border border-slate-300 rounded-xl p-7 mb-6">
            <div className="text-[10px] font-bold uppercase tracking-widest text-cyan-400/70 mb-4">Clinical Clues</div>
            <div className="space-y-2.5">
              {(current?.clues || []).map((clue, ci) => (
                <div key={ci} className={`flex items-start gap-3 transition-all duration-300 ${ci < revealedClues ? 'opacity-100' : 'opacity-0 h-0 overflow-hidden'}`}>
                  <span className="text-xs text-cyan-600 font-mono mt-0.5 shrink-0 w-4">{ci + 1}.</span>
                  <span className="text-sm text-slate-700 leading-relaxed">{clue}</span>
                </div>
              ))}
            </div>
            {!guessed && revealedClues < (current?.clues || []).length && (
              <button onClick={() => setRevealedClues(prev => prev + 1)}
                className="mt-4 text-xs text-cyan-400 hover:text-cyan-300 font-medium transition">
                + Reveal next clue ({revealedClues}/{(current?.clues || []).length})
              </button>
            )}
          </div>

          <div className="text-xs text-slate-400 uppercase tracking-widest mb-3 font-bold">What's the organism?</div>
          <div className="grid grid-cols-2 gap-2.5">
            {options.map((opt, i) => {
              let cls = 'bg-slate-50 border-slate-300 hover:border-slate-400';
              if (guessed) {
                if (opt === current.answer) cls = 'bg-emerald-950/30 border-emerald-500/60';
                else if (opt === selected) cls = 'bg-red-950/30 border-red-500/60';
                else cls = 'bg-slate-100 border-slate-300 opacity-40';
              }
              return (
                <button key={i} onClick={() => handleGuess(opt)} disabled={guessed}
                  className={`choice-btn text-left p-3.5 rounded-xl border transition text-sm text-slate-200 ${cls}`}>{opt}</button>
              );
            })}
          </div>

          {guessed && (
            <div className="mt-5">
              <div className={`p-5 rounded-xl border ${selected === current.answer ? 'bg-emerald-950/20 border-emerald-700/30' : 'bg-slate-50 border-slate-300'}`}>
                <FormattedText text={current.explanation} className="feedback-text" />
              </div>
              <button onClick={() => { setIdx(prev => prev + 1); setRevealedClues(1); setGuessed(false); setSelected(null); }}
                className="w-full mt-4 py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded-xl text-sm font-semibold transition">Next Case â†’</button>
            </div>
          )}
          {game.overlays}
        </div>
      );
    }

    // â”€â”€â”€ RASH GALLERY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function RashGallery({ rashes }) {
      const [flipped, setFlipped] = useState({});
      const toggle = (id) => setFlipped(prev => ({ ...prev, [id]: !prev[id] }));
      return (
        <div>
          <p className="text-sm text-slate-600 mb-6 leading-relaxed">Click any card to reveal the diagnosis. Master the classic <strong className="text-slate-700">pediatric rash patterns</strong> that appear on the shelf exam.</p>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {rashes.map(r => (
              <div key={r.id} onClick={() => toggle(r.id)} className="cursor-pointer">
                {!flipped[r.id] ? (
                  <div className="p-6 bg-rose-950/20 border border-rose-800/25 rounded-xl min-h-[200px] hover:bg-rose-950/30 transition">
                    <div className="text-[10px] font-bold uppercase tracking-widest text-rose-400/60 mb-3">Rash Description</div>
                    <p className="text-sm text-slate-700 leading-relaxed">{r.rashDescription}</p>
                    <div className="flex flex-wrap gap-1.5 mt-4">
                      {(r.buzzwords || []).map((bw, i) => <span key={i} className="text-[10px] px-2 py-0.5 bg-rose-500/15 text-rose-300 rounded-full">{bw}</span>)}
                    </div>
                    <div className="text-[10px] text-slate-600 mt-4 italic">tap to reveal â†’</div>
                  </div>
                ) : (
                  <div className="p-6 bg-emerald-950/20 border border-emerald-800/25 rounded-xl min-h-[200px] animate-fadeIn">
                    <div className="text-[10px] font-bold uppercase tracking-widest text-emerald-400/60 mb-2">Diagnosis</div>
                    <h3 className="text-lg font-bold text-emerald-300 mb-1">{r.diagnosis}</h3>
                    <div className="text-xs text-slate-600 mb-3">Pathogen: <strong className="text-slate-700">{r.pathogen}</strong></div>
                    <div className="text-xs text-amber-300/80 mb-2 font-medium">ğŸ”‘ {r.keyFeature}</div>
                    <div className="text-xs text-slate-600">Tx: <span className="text-slate-700">{r.treatment}</span></div>
                    {r.complications && <div className="mt-3 text-xs text-slate-600">Complications: {r.complications.join(', ')}</div>}
                    <div className="text-[10px] text-slate-600 mt-3 italic">tap to flip back â†’</div>
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      );
    }

    // â”€â”€â”€ EMPIRIC THERAPY CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function EmpiricTherapyCards({ syndromes }) {
      const [expanded, setExpanded] = useState(null);
      return (
        <div>
          <p className="text-sm text-slate-600 mb-6 leading-relaxed">Syndrome-based empiric antibiotic selection â€” click any syndrome for the full regimen, target organisms, and clinical reasoning.</p>
          <div className="space-y-3">
            {syndromes.map(et => (
              <div key={et.id} className="bg-slate-50 border border-slate-300 rounded-xl overflow-hidden">
                <button onClick={() => setExpanded(expanded === et.id ? null : et.id)}
                  className="w-full text-left p-5 flex items-center justify-between hover:bg-slate-100 transition">
                  <div className="pr-4">
                    <span className="text-sm font-semibold text-slate-900">{et.syndrome}</span>
                    <span className="text-xs text-blue-300/80 ml-3 hidden sm:inline">{et.empiricRegimen}</span>
                  </div>
                  <span className={`text-slate-400 transition-transform shrink-0 ${expanded === et.id ? 'rotate-90' : ''}`}><Icons.ChevronRight /></span>
                </button>
                {expanded === et.id && (
                  <div className="px-5 pb-5 border-t border-slate-300 pt-4 animate-fadeIn space-y-4">
                    <div>
                      <div className="text-[10px] font-bold text-slate-600 uppercase tracking-wider mb-1">Empiric Regimen</div>
                      <div className="text-sm text-blue-300 font-semibold">{et.empiricRegimen}</div>
                    </div>
                    <div>
                      <div className="text-[10px] font-bold text-slate-600 uppercase tracking-wider mb-1.5">Target Organisms</div>
                      <div className="flex flex-wrap gap-1.5">{(et.targetOrganisms || []).map((o, i) => <span key={i} className="text-[11px] px-2 py-0.5 bg-lime-500/15 text-lime-300 rounded">{o}</span>)}</div>
                    </div>
                    <div>
                      <div className="text-[10px] font-bold text-slate-600 uppercase tracking-wider mb-1">Key Considerations</div>
                      <FormattedText text={et.keyConsiderations} className="feedback-text" />
                    </div>
                    {et.whenToNarrow && <div><div className="text-[10px] font-bold text-slate-600 uppercase tracking-wider mb-1">When to Narrow</div><p className="text-xs text-slate-600 leading-relaxed">{et.whenToNarrow}</p></div>}
                    {et.duration && <div><div className="text-[10px] font-bold text-slate-600 uppercase tracking-wider mb-1">Duration</div><p className="text-xs text-slate-600 leading-relaxed">{et.duration}</p></div>}
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      );
    }

    // â”€â”€â”€ ANTIBIOTIC SPECTRUM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function AntibioticSpectrum({ drugs }) {
      const [selected, setSelected] = useState(drugs[0]?.id);
      const current = drugs.find(d => d.id === selected) || drugs[0];
      return (
        <div>
          <p className="text-sm text-slate-600 mb-6 leading-relaxed">Visual coverage profiles for key pediatric antibiotics. Select a drug to see its full spectrum.</p>
          <div className="flex flex-wrap gap-2 mb-6">
            {drugs.map(d => (
              <button key={d.id} onClick={() => setSelected(d.id)}
                className={`px-3.5 py-2 text-xs rounded-lg font-medium transition ${(selected || drugs[0]?.id) === d.id ? 'bg-violet-500/20 text-violet-300 border border-violet-500/30' : 'bg-slate-800/40 text-slate-400 border border-slate-300 hover:text-slate-200'}`}>
                {d.drug}
              </button>
            ))}
          </div>
          {current && (
            <div className="bg-slate-50 border border-slate-300 rounded-xl p-6 animate-fadeIn">
              <div className="flex items-baseline gap-3 mb-1">
                <h3 className="text-lg font-bold text-violet-300">{current.drug}</h3>
                <span className="text-xs text-slate-400">{current.class}</span>
              </div>
              <p className="text-xs text-slate-400 mb-5 italic">{current.mechanism}</p>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
                <div className="p-4 bg-emerald-950/20 border border-emerald-800/20 rounded-lg">
                  <div className="text-[10px] font-bold text-emerald-400 uppercase tracking-wider mb-2">Gram-Positive</div>
                  <div className="flex flex-wrap gap-1.5">{(current.gramPositive || []).map((g, i) => <span key={i} className="text-[11px] px-2 py-0.5 bg-emerald-500/15 text-emerald-300 rounded">{g}</span>)}</div>
                  {(current.gramPositive || []).length === 0 && <span className="text-xs text-slate-600 italic">None</span>}
                </div>
                <div className="p-4 bg-blue-950/20 border border-blue-800/20 rounded-lg">
                  <div className="text-[10px] font-bold text-blue-400 uppercase tracking-wider mb-2">Gram-Negative</div>
                  <div className="flex flex-wrap gap-1.5">{(current.gramNegative || []).map((g, i) => <span key={i} className="text-[11px] px-2 py-0.5 bg-blue-500/15 text-blue-300 rounded">{g}</span>)}</div>
                  {(current.gramNegative || []).length === 0 && <span className="text-xs text-slate-600 italic">None</span>}
                </div>
                {(current.atypicals || []).length > 0 && (
                  <div className="p-4 bg-amber-950/20 border border-amber-800/20 rounded-lg">
                    <div className="text-[10px] font-bold text-amber-400 uppercase tracking-wider mb-2">Atypicals</div>
                    <div className="flex flex-wrap gap-1.5">{current.atypicals.map((g, i) => <span key={i} className="text-[11px] px-2 py-0.5 bg-amber-500/15 text-amber-300 rounded">{g}</span>)}</div>
                  </div>
                )}
                <div className="p-4 bg-red-950/20 border border-red-800/20 rounded-lg">
                  <div className="text-[10px] font-bold text-red-400 uppercase tracking-wider mb-2">NOT Covered</div>
                  <div className="flex flex-wrap gap-1.5">{(current.notCovered || []).map((g, i) => <span key={i} className="text-[11px] px-2 py-0.5 bg-red-500/15 text-red-300 rounded">{g}</span>)}</div>
                </div>
              </div>
              <div className="space-y-3">
                <div>
                  <div className="text-[10px] font-bold text-slate-600 uppercase tracking-wider mb-1.5">Pediatric Uses</div>
                  <div className="flex flex-wrap gap-1.5">{(current.pedsUses || []).map((u, i) => <span key={i} className="text-[11px] px-2 py-0.5 bg-slate-300 text-slate-700 rounded">{u}</span>)}</div>
                </div>
                {current.pedsNotes && <div className="p-3 bg-amber-950/15 border-l-[3px] border-amber-500/40 rounded-r-lg"><p className="text-xs text-amber-200/80 leading-relaxed">ğŸ“ {current.pedsNotes}</p></div>}
                {(current.sideEffects || []).length > 0 && (
                  <div><div className="text-[10px] font-bold text-slate-600 uppercase tracking-wider mb-1.5">Side Effects</div><p className="text-xs text-slate-400">{current.sideEffects.join(' Â· ')}</p></div>
                )}
                {current.contraindications && (
                  <div><div className="text-[10px] font-bold text-red-400/80 uppercase tracking-wider mb-1.5">Contraindications</div><p className="text-xs text-red-300/70">{current.contraindications}</p></div>
                )}
              </div>
            </div>
          )}
        </div>
      );
    }

    // â”€â”€â”€ AGE-BASED BUGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function AgeBasedBugs({ groups }) {
      const [active, setActive] = useState(groups[0]?.id);
      const current = groups.find(g => g.id === active) || groups[0];
      const ageIcons = { 'abb-1': 'ğŸ‘¶', 'abb-2': 'ğŸ¼', 'abb-3': 'ğŸ§’', 'abb-4': 'ğŸ«', 'abb-5': 'ğŸ§‘' };
      return (
        <div>
          <p className="text-sm text-slate-400 mb-6 leading-relaxed">Organisms shift dramatically by age in pediatrics. Select an age group to see the <strong className="text-slate-700">bugs you must know</strong>.</p>
          <div className="flex flex-wrap gap-2 mb-6">
            {groups.map(ag => (
              <button key={ag.id} onClick={() => setActive(ag.id)}
                className={`px-4 py-2.5 text-xs rounded-lg font-medium transition ${active === ag.id ? 'bg-amber-500/20 text-amber-300 border border-amber-500/30' : 'bg-slate-800/40 text-slate-400 border border-slate-300 hover:text-slate-200'}`}>
                <span className="mr-1.5">{ageIcons[ag.id] || 'ğŸ¦ '}</span>{ag.ageGroup}
              </button>
            ))}
          </div>
          {current && (
            <div className="space-y-3 animate-fadeIn">
              {(current.commonBugs || []).map((bug, i) => (
                <div key={i} className="p-5 bg-slate-800/30 border border-slate-300 rounded-xl">
                  <div className="flex items-baseline gap-2.5 mb-2">
                    <span className="text-sm font-bold text-amber-300">{bug.organism}</span>
                  </div>
                  <div className="flex flex-wrap gap-1.5 mb-3">
                    {(bug.presentations || []).map((p, pi) => <span key={pi} className="text-[11px] px-2 py-0.5 bg-amber-500/10 text-amber-200/80 rounded">{p}</span>)}
                  </div>
                  {bug.notes && <p className="text-xs text-slate-400 leading-relaxed">{bug.notes}</p>}
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    // â”€â”€â”€ VACCINE TRAINER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function VaccineTrainer({ vaccines }) {
      const [mode, setMode] = useState('study');
      const [qIdx, setQIdx] = useState(0);
      const [qAnswer, setQAnswer] = useState(null);
      const [qScore, setQScore] = useState({ correct: 0, total: 0 });
      const [qMissed, setQMissed] = useState([]);
      const quizQueue = useMemo(() => [...vaccines].sort(() => Math.random() - 0.5), [vaccines]);
      const savedRef = useRef(false);
      const game = useGameQuiz('vaccines_quiz');

      const q = quizQueue[qIdx];
      const correctSchedule = q ? (q.schedule || []).join(', ') : '';
      const quizComplete = mode === 'quiz' && !q && qScore.total > 0;

      useEffect(() => {
        if (quizComplete && !savedRef.current) {
          IDProgress.save('vaccines_quiz', { correct: qScore.correct, total: qScore.total, missed: qMissed });
          game.onComplete({ correct: qScore.correct, total: qScore.total });
          savedRef.current = true;
        }
      }, [quizComplete]);

      const scheduleOptions = useMemo(() => {
        if (!q) return [];
        const others = (vaccines || []).filter(d => d && d.id !== q.id).sort(() => Math.random() - 0.5).slice(0, 3).map(d => (d.schedule || []).join(', '));
        return [...new Set([correctSchedule, ...others])].sort(() => Math.random() - 0.5);
      }, [qIdx, q, correctSchedule]);
      if (mode === 'study') {
        return (
          <div>
            <div className="flex items-center justify-between mb-6">
              <p className="text-sm text-slate-400">Pediatric immunization reference â€” <strong className="text-slate-700">{vaccines.length} vaccines</strong>.</p>
              <button onClick={() => { setMode('quiz'); setQIdx(0); setQAnswer(null); setQScore({ correct: 0, total: 0 }); }}
                className="px-4 py-2 bg-emerald-600/80 hover:bg-emerald-600 text-white rounded-lg text-xs font-medium transition">ğŸ® Quiz Mode</button>
            </div>
            <div className="space-y-3">
              {vaccines.map(v => (
                <div key={v.id} className="p-5 bg-slate-800/30 border border-slate-300 rounded-xl">
                  <div className="flex items-baseline gap-2.5 mb-2">
                    <span className="text-sm font-bold text-emerald-300">{v.vaccine}</span>
                    <span className="text-[10px] text-slate-400">{v.fullName}</span>
                  </div>
                  <div className="flex flex-wrap gap-1.5 mb-2">
                    {(v.schedule || []).map((s, si) => <span key={si} className="text-[11px] px-2 py-0.5 bg-emerald-500/10 text-emerald-200/80 rounded tabular-nums">{s}</span>)}
                  </div>
                  {v.booster && <p className="text-xs text-slate-400 mb-1"><strong className="text-slate-400">Booster:</strong> {v.booster}</p>}
                  <p className="text-xs text-slate-400"><strong className="text-slate-400">Type:</strong> {v.type}</p>
                  {v.contraindications && v.contraindications.length > 0 && <p className="text-xs text-red-300/60 mt-1"><strong>CI:</strong> {v.contraindications.join('; ')}</p>}
                  {v.highYield && <div className="mt-3 p-2.5 bg-amber-950/15 border-l-[3px] border-amber-500/30 rounded-r-lg"><p className="text-[11px] text-amber-200/80 leading-relaxed">â­ {v.highYield}</p></div>}
                </div>
              ))}
            </div>
          </div>
        );
      }

      // Quiz mode
      if (quizComplete) {
        const pct = Math.round(qScore.correct / Math.max(1, qScore.total) * 100);
        const best = IDProgress.getModule('vaccines_quiz');
        const color = pct >= 80 ? 'text-emerald-400' : pct >= 60 ? 'text-amber-400' : 'text-red-400';
        return (
          <div className="max-w-2xl mx-auto py-8">
            <div className="text-center mb-8">
              <div className="text-5xl mb-4">{pct >= 80 ? 'ğŸ–ï¸' : pct >= 60 ? 'ğŸ“…' : 'ğŸ“š'}</div>
              <h2 className="text-xl font-bold text-slate-900 mb-1">Quiz Complete!</h2>
              <p className={`text-3xl font-bold ${color} mb-1`}>{pct}%</p>
              <p className="text-slate-600 text-sm">{qScore.correct} / {qScore.total} correct</p>
              {best.attempts.length > 1 && <p className="text-xs text-slate-400 mt-1">Personal best: {best.bestScore}% Â· Attempt #{best.attempts.length}</p>}
            </div>
            {qMissed.length > 0 && (
              <div className="mb-8">
                <h3 className="text-xs font-bold text-red-400 uppercase tracking-wider mb-3">Missed Schedules â€” Review These</h3>
                <div className="space-y-2">
                  {qMissed.map((m, i) => (
                    <div key={i} className="flex flex-col gap-2 p-3 bg-red-950/20 border border-red-800/20 rounded-lg text-sm">
                      <span className="text-slate-700 font-medium">{m.vaccine}</span>
                      <div className="flex items-center gap-2 text-xs">
                        <span className="text-red-400">âœ—</span>
                        <span className="text-red-300/70">Your answer:</span>
                        <span className="text-red-300">{m.yourAnswer}</span>
                        <span className="text-slate-600 mx-1">â†’</span>
                        <span className="text-emerald-400">Correct:</span>
                        <span className="text-emerald-400">{m.correctSchedule}</span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
            {pct < 80 && (
              <div className="p-4 bg-amber-950/15 border border-amber-700/20 rounded-xl mb-6">
                <p className="text-xs text-amber-200/80 leading-relaxed">ğŸ’¡ <strong>Study tip:</strong> Review the {qMissed.length} missed vaccine schedules. Pay close attention to age windows and booster patterns â€” these are high-yield for shelf exams.</p>
              </div>
            )}
            <div className="flex gap-3 justify-center">
              <button onClick={() => setMode('study')} className="px-5 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm font-medium transition">Back to Study</button>
              <button onClick={() => { setQIdx(0); setQAnswer(null); setQScore({ correct: 0, total: 0 }); setQMissed([]); savedRef.current = false; }} className="px-5 py-2.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-sm font-medium transition">Play Again</button>
            </div>
          </div>
        );
      }

      if (!q) return null;

      return (
        <div className="max-w-2xl mx-auto">
          <GameHeader />
          <div className="flex items-center justify-between mb-6">
            <div className="flex items-center gap-3"><span className="text-sm text-slate-600 tabular-nums">{qIdx + 1} / {quizQueue.length}</span><ComboDisplay combo={game.combo} /></div>
            <button onClick={() => setMode('study')} className="text-xs text-slate-400 hover:text-slate-300 transition">â† Back to Study</button>
          </div>
          <div className="bg-white border border-slate-300 rounded-xl p-7 mb-6">
            <div className="text-[10px] font-bold uppercase tracking-widest text-emerald-400/70 mb-3">When is this vaccine given?</div>
            <h2 className="text-lg font-bold text-slate-900 mb-1">{q.vaccine}</h2>
            <p className="text-xs text-slate-400">{q.fullName} Â· {q.type}</p>
          </div>
          <div className="space-y-2.5">
            {scheduleOptions.map((opt, i) => {
              let cls = 'bg-slate-50 border-slate-300 hover:border-slate-400';
              if (qAnswer !== null) {
                if (opt === correctSchedule) cls = 'bg-emerald-950/30 border-emerald-500/60';
                else if (opt === qAnswer) cls = 'bg-red-950/30 border-red-500/60';
                else cls = 'bg-slate-100 border-slate-300 opacity-40';
              }
              return (
                <button key={i} onClick={() => { if (qAnswer !== null) return; setQAnswer(opt); const isCorrect = opt === correctSchedule; game.onAnswer(q?.id, isCorrect); setQScore(prev => ({ correct: prev.correct + (isCorrect ? 1 : 0), total: prev.total + 1 })); if (!isCorrect) setQMissed(prev => [...prev, { vaccine: q.vaccine, correctSchedule, yourAnswer: opt }]); }} disabled={qAnswer !== null}
                  className={`choice-btn w-full text-left p-4 rounded-xl border transition text-sm text-slate-200 ${cls}`}>{opt}</button>
              );
            })}
          </div>
          {qAnswer !== null && (
            <div>
              {q.highYield && <div className="mt-4 p-4 bg-amber-950/15 border border-amber-700/20 rounded-xl"><p className="text-xs text-amber-200/80 leading-relaxed">â­ {q.highYield}</p></div>}
              <button onClick={() => { setQIdx(prev => prev + 1); setQAnswer(null); }}
                className="w-full mt-4 py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl text-sm font-semibold transition">Next Vaccine â†’</button>
            </div>
          )}
          {game.overlays}
        </div>
      );
    }

    // â”€â”€â”€ PEARLS & ASSOCIATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function PearlsAssociations({ pearls, associations }) {
      const [sub, setSub] = useState('associations');
      const [hideAnswers, setHideAnswers] = useState(true);
      return (
        <div>
          <div className="flex gap-2 mb-6">
            <button onClick={() => setSub('associations')} className={`px-4 py-2 text-xs rounded-lg font-medium transition ${sub === 'associations' ? 'bg-yellow-500/20 text-yellow-300 border border-yellow-500/30' : 'bg-slate-800/40 text-slate-400 border border-slate-300'}`}>
              Buzzword Associations ({associations.length})
            </button>
            <button onClick={() => setSub('pearls')} className={`px-4 py-2 text-xs rounded-lg font-medium transition ${sub === 'pearls' ? 'bg-amber-500/20 text-amber-300 border border-amber-500/30' : 'bg-slate-800/40 text-slate-400 border border-slate-300'}`}>
              Clinical Pearls ({pearls.length})
            </button>
          </div>

          {sub === 'associations' && (
            <div>
              <div className="flex items-center justify-between mb-4">
                <p className="text-xs text-slate-400">Classic "if you see â†’ think" shelf-exam patterns</p>
                <button onClick={() => setHideAnswers(!hideAnswers)} className="text-xs text-slate-400 hover:text-slate-300 transition font-medium">
                  {hideAnswers ? 'ğŸ‘ Show Answers' : 'ğŸ™ˆ Hide Answers'}
                </button>
              </div>
              <div className="bg-slate-50 border border-slate-300 rounded-xl overflow-hidden divide-y divide-slate-700/20">
                {associations.map((a, i) => (
                  <div key={a.id || i} className="flex items-center px-5 py-3.5 text-sm hover:bg-slate-100 transition">
                    <span className="w-8 text-xs text-slate-600 tabular-nums shrink-0">{i + 1}</span>
                    <span className="text-amber-300 flex-1 leading-relaxed">{a.clue}</span>
                    <span className="text-slate-600 mx-3 text-lg">â†’</span>
                    <span className={`font-semibold flex-1 transition-colors ${hideAnswers ? 'text-slate-700 bg-slate-700/50 rounded px-2 select-none cursor-pointer' : 'text-white'}`}
                      onClick={(e) => { if (hideAnswers) { e.stopPropagation(); const el = e.currentTarget; el.style.color = '#e2e8f0'; el.style.background = 'transparent'; } }}>{a.answer}</span>
                  </div>
                ))}
              </div>
            </div>
          )}

          {sub === 'pearls' && (
            <div className="space-y-2.5">
              {pearls.map((p, i) => (
                <div key={p.id || i} className={`flex items-start gap-3.5 p-4 rounded-lg border ${p.highYield ? 'bg-amber-950/20 border-amber-700/20' : 'bg-slate-800/25 border-slate-700/20'}`}>
                  <span className="text-amber-400 mt-0.5 shrink-0">{p.highYield ? 'â­' : 'ğŸ’¡'}</span>
                  <div className="flex-1">
                    <FormattedText text={p.pearl} className="rich-text text-sm" />
                    <span className="text-[10px] text-slate-600 uppercase tracking-wider mt-2 inline-block">{p.category}</span>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    // â”€â”€â”€ SIDE EFFECTS & CONTRAINDICATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function SideEffectsView({ items }) {
      return (
        <div>
          <p className="text-sm text-slate-400 mb-6 leading-relaxed">Age-specific drug restrictions and the <strong className="text-red-300">critical exceptions</strong> the NBME loves to test.</p>
          <div className="space-y-3">
            {items.map(d => (
              <div key={d.id} className="p-5 bg-slate-800/30 border border-slate-300 rounded-xl">
                <div className="flex items-baseline justify-between mb-2">
                  <span className="text-sm font-bold text-white">{d.drug}</span>
                  {d.ageRestriction && <span className="text-[10px] px-2.5 py-0.5 bg-red-500/15 text-red-300 rounded-full font-medium">{d.ageRestriction}</span>}
                </div>
                <p className="text-sm text-slate-400 mb-3 leading-relaxed">{d.sideEffect}</p>
                {d.exception && (
                  <div className="p-3.5 bg-amber-950/20 border-l-[3px] border-amber-500/40 rounded-r-lg mb-2.5">
                    <div className="text-[10px] font-bold text-amber-400 uppercase tracking-wider mb-1">âš¡ Exception</div>
                    <p className="text-xs text-amber-200/80 leading-relaxed">{d.exception}</p>
                  </div>
                )}
                {d.shelfTrap && (
                  <div className="p-3.5 bg-red-950/15 border-l-[3px] border-red-500/30 rounded-r-lg">
                    <div className="text-[10px] font-bold text-red-400 uppercase tracking-wider mb-1">ğŸ¯ Shelf Trap</div>
                    <p className="text-xs text-red-200/80 leading-relaxed">{d.shelfTrap}</p>
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      );
    }

    // â”€â”€â”€ STUDY GUIDE (AI-driven recommendations) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function StudyGuide({ idData, setTab }) {
      const recs = IDProgress.getRecommendations(idData);
      const all = IDProgress.getAll();
      const totalAttempts = Object.values(all).reduce((sum, m) => sum + (m.attempts?.length || 0), 0);
      const avgScore = totalAttempts > 0 ? Math.round(Object.values(all).reduce((sum, m) => sum + (m.bestScore || 0), 0) / Object.keys(all).length) : 0;

      return (
        <div className="max-w-4xl mx-auto animate-fadeIn">
          <div className="mb-8">
            <h2 className="text-xl font-bold text-white mb-2">ğŸ“Š Your Study Progress</h2>
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <div className="p-4 bg-slate-800/50 border border-slate-300 rounded-xl">
                <div className="text-xs text-slate-400 uppercase tracking-wider mb-1">Attempts</div>
                <div className="text-2xl font-bold text-white">{totalAttempts}</div>
                <div className="text-[10px] text-slate-400 mt-1">quiz rounds completed</div>
              </div>
              <div className="p-4 bg-slate-800/50 border border-slate-300 rounded-xl">
                <div className="text-xs text-slate-400 uppercase tracking-wider mb-1">Average Score</div>
                <div className="text-2xl font-bold text-cyan-400">{avgScore}%</div>
                <div className="text-[10px] text-slate-400 mt-1">across all modules</div>
              </div>
              <div className="p-4 bg-slate-800/50 border border-slate-300 rounded-xl">
                <div className="text-xs text-slate-400 uppercase tracking-wider mb-1">Modules Started</div>
                <div className="text-2xl font-bold text-emerald-400">{Object.keys(all).length}</div>
                <div className="text-[10px] text-slate-400 mt-1">of 10 available</div>
              </div>
            </div>
          </div>

          <div className="mb-8">
            <h2 className="text-xl font-bold text-white mb-4">ğŸ¯ Personalized Recommendations</h2>
            {recs.length === 0 ? (
              <div className="p-6 bg-slate-800/30 border border-slate-300 rounded-xl text-center">
                <p className="text-slate-600 text-sm">No modules attempted yet. Start with a quiz to generate recommendations!</p>
              </div>
            ) : (
              <div className="space-y-3">
                {recs.map((rec, i) => {
                  let priorityBg = 'bg-red-950/20 border-red-800/30';
                  let priorityBadge = 'bg-red-500/20 text-red-300';
                  if (rec.priority >= 2) { priorityBg = 'bg-amber-950/20 border-amber-800/30'; priorityBadge = 'bg-amber-500/20 text-amber-300'; }
                  if (rec.priority >= 3) { priorityBg = 'bg-emerald-950/20 border-emerald-800/30'; priorityBadge = 'bg-emerald-500/20 text-emerald-300'; }

                  return (
                    <button key={i} onClick={() => setTab(rec.tab)}
                      className={`w-full text-left p-5 rounded-xl border transition hover:brightness-110 ${priorityBg}`}>
                      <div className="flex items-start gap-4 justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-3 mb-1">
                            <span className="font-semibold text-white">{rec.label}</span>
                            <span className={`text-[10px] px-2 py-1 rounded-full font-medium ${priorityBadge}`}>
                              {rec.type === 'not_started' ? 'â­ Start Here' : rec.type === 'weak' ? 'âš ï¸ Focus Area' : rec.type === 'improving' ? 'ğŸ“ˆ Keep Going' : rec.type === 'strong' ? 'âœ“ Solid' : 'ğŸ”– Reference'}
                            </span>
                          </div>
                          <p className="text-sm text-slate-300 mb-2">{rec.reason}</p>
                          {rec.missed && rec.missed.length > 0 && (
                            <div className="text-[11px] text-slate-400 mb-2">
                              <strong>{rec.missed.length}</strong> items to review
                            </div>
                          )}
                          {rec.trend !== undefined && rec.trend !== 0 && (
                            <div className={`text-[10px] ${rec.trend > 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                              {rec.trend > 0 ? 'â†‘' : 'â†“'} {Math.abs(rec.trend)}% since last attempt
                            </div>
                          )}
                        </div>
                        <button onClick={(e) => { e.stopPropagation(); setTab(rec.tab); }}
                          className="px-3 py-1.5 bg-white/10 hover:bg-white/20 text-white rounded text-xs font-medium transition shrink-0">
                          {rec.action}
                        </button>
                      </div>
                    </button>
                  );
                })}
              </div>
            )}
          </div>

          {totalAttempts > 0 && (
            <div className="mb-8">
              <h2 className="text-xl font-bold text-white mb-4">ğŸ“… Spaced Repetition Hints</h2>
              <div className="space-y-2">
                {Object.entries(all).map(([moduleId, data]) => {
                  if (!data.lastVisited) return null;
                  const daysSince = Math.floor((Date.now() - data.lastVisited) / (1000 * 60 * 60 * 24));
                  const isOverdue = daysSince > 3;
                  const tab = ['bug_drug', 'whats_the_bug', 'vaccines_quiz'].includes(moduleId) ? moduleId.replace('_quiz', '') : moduleId;
                  return (
                    <button key={moduleId} onClick={() => setTab(tab)}
                      className={`w-full text-left p-3 rounded-lg border transition ${isOverdue ? 'bg-red-950/15 border-red-800/30 hover:bg-red-950/25' : 'bg-slate-50 border-slate-300 hover:bg-slate-800/50'}`}>
                      <div className="flex items-center justify-between">
                        <span className="text-sm text-slate-300">{moduleId.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}</span>
                        <span className={`text-xs ${isOverdue ? 'text-red-300 font-medium' : 'text-slate-400'}`}>
                          {daysSince === 0 ? 'Today' : daysSince === 1 ? 'Yesterday' : `${daysSince} days ago`}
                          {isOverdue && <span className="ml-2">ğŸ”” Time to review</span>}
                        </span>
                      </div>
                    </button>
                  );
                })}
              </div>
            </div>
          )}

          <div className="p-6 bg-slate-800/20 border border-slate-300 rounded-xl">
            <p className="text-xs text-slate-400 leading-relaxed">
              <strong>ğŸ’¡ Study Strategy:</strong> Aim for 80%+ on each quiz before moving on. Use the Antibiotic Spectrum and Clinical Pearls modules to deepen understanding of why certain organisms respond to specific drugs. Return to weak areas every 3 days for spaced repetition.
            </p>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â”€â”€â”€ PEDIATRIC CARDIOLOGY HUB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function CardioHubView() {
      const [tab, setTab] = useState('overview');
      const [cardioData, setCardioData] = useState(null);
      const [loading, setLoading] = useState(true);
      useEffect(() => {
        fetch('/api/cardiology').then(r => r.json()).then(d => { setCardioData(d); setLoading(false); }).catch(() => setLoading(false));
      }, []);
      if (loading) return <LoadingScreen />;
      if (!cardioData) return <div className="p-8 text-slate-400">Failed to load cardiology data.</div>;

      const tabs = [
        { id: 'overview', label: 'Overview', icon: 'â¤ï¸' },
        { id: 'chd_cards', label: 'CHD Cards', icon: 'ğŸ«€' },
        { id: 'murmur_master', label: 'Murmur Master', icon: 'ğŸ«€' },
        { id: 'acquired', label: 'Acquired Disease', icon: 'ğŸ”¥' },
        { id: 'ecg', label: 'ECG Patterns', icon: 'ğŸ“ˆ' },
        { id: 'pharm', label: 'Cardiac Pharm', icon: 'ğŸ’Š' },
        { id: 'scenarios', label: 'Shelf Scenarios', icon: 'ğŸ“' },
        { id: 'fetal', label: 'Fetal Circulation', icon: 'ğŸ¤°' },
        { id: 'sports', label: 'Sports Cardiology', icon: 'ğŸƒ' },
        { id: 'pearls', label: 'Pearls & Associations', icon: 'ğŸ’¡' },
        { id: 'study_guide', label: 'AI Study Guide', icon: 'ğŸ§ ' },
      ];
      return (
        <div className="animate-fadeIn p-8 max-w-6xl mx-auto">
          <div className="mb-8">
            <div className="flex items-center gap-3 mb-2"><span className="text-3xl">â¤ï¸</span>
              <h1 className="text-2xl font-bold text-white tracking-tight">Pediatric Cardiology Hub</h1>
            </div>
            <p className="text-sm text-slate-400 leading-relaxed">Master pediatric heart disease â€” from <strong className="text-slate-300">congenital defects</strong> to <strong className="text-slate-300">murmurs, ECGs, and shelf scenarios</strong> through <strong className="text-slate-300">11 interactive modules</strong>.</p>
          </div>
          <div className="flex flex-wrap gap-1.5 mb-8 pb-3 border-b border-slate-700">
            {tabs.map(t => (
              <button key={t.id} onClick={() => setTab(t.id)}
                className={`flex items-center gap-1.5 px-3.5 py-2 text-xs rounded-lg font-medium transition ${tab === t.id ? 'bg-rose-950/30 text-rose-300 border border-rose-800/30' : 'bg-slate-800/50 text-slate-400 border border-slate-700 hover:text-slate-300 hover:bg-slate-800/30'}`}>
                <span className="text-sm">{t.icon}</span> {t.label}
              </button>
            ))}
          </div>
          {tab === 'overview' && <CardioOverview data={cardioData} setTab={setTab} />}
          {tab === 'chd_cards' && <CHDCards lesions={cardioData.chdLesions || []} />}
          {tab === 'murmur_master' && <MurmurMaster items={cardioData.murmurQuiz || []} chdLesions={cardioData.chdLesions || []} />}
          {tab === 'acquired' && <AcquiredHeartDisease conditions={cardioData.acquiredHeartDisease || []} />}
          {tab === 'ecg' && <ECGPatterns patterns={cardioData.ecgPatterns || []} />}
          {tab === 'pharm' && <CardiacPharm drugs={cardioData.pharmacology || []} />}
          {tab === 'scenarios' && <ShelfScenarios items={cardioData.shelfScenarios || []} />}
          {tab === 'fetal' && <FetalCirculation structures={cardioData.fetalCirculation || []} />}
          {tab === 'sports' && <SportsCardiology items={cardioData.sportsCardiology || []} />}
          {tab === 'pearls' && <CardioPearlsAssociations pearls={cardioData.clinicalPearls || []} associations={cardioData.associations || []} />}
          {tab === 'study_guide' && <CardioStudyGuide data={cardioData} setTab={setTab} />}
        </div>
      );
    }

    // â”€â”€â”€ CARDIO OVERVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function CardioOverview({ data, setTab }) {
      const modules = [
        { id: 'chd_cards', icon: 'ğŸ«€', title: 'CHD Cards', desc: 'Cyanotic & acyanotic congenital lesions with hemodynamics', count: `${(data.chdLesions||[]).length} lesions`, color: 'bg-rose-950/30 text-rose-300 border-rose-800/30' },
        { id: 'murmur_master', icon: 'ğŸ«€', title: 'Murmur Master', desc: 'Interactive heart diagram, waveforms, buzzwords & gamified murmur quiz', count: `${(data.murmurQuiz||[]).length} cases`, color: 'bg-pink-50 text-pink-600 border-pink-300' },
        { id: 'acquired', icon: 'ğŸ”¥', title: 'Acquired Heart Disease', desc: 'Myocarditis, pericarditis, rheumatic fever & more', count: `${(data.acquiredHeartDisease||[]).length} conditions`, color: 'bg-red-50 text-red-600 border-red-300' },
        { id: 'ecg', icon: 'ğŸ“ˆ', title: 'ECG Patterns', desc: 'Age-appropriate ECG findings and arrhythmias', count: `${(data.ecgPatterns||[]).length} patterns`, color: 'bg-purple-50 text-purple-600 border-purple-300' },
        { id: 'pharm', icon: 'ğŸ’Š', title: 'Cardiac Pharmacology', desc: 'Inotropes, vasodilators, and antiarrhythmics', count: `${(data.pharmacology||[]).length} drugs`, color: 'bg-cyan-50 text-cyan-600 border-cyan-300' },
        { id: 'scenarios', icon: 'ğŸ“', title: 'Shelf Scenarios', desc: 'Shelf-exam style vignettes with branching decisions', count: `${(data.shelfScenarios||[]).length} cases`, color: 'bg-amber-50 text-amber-600 border-amber-300' },
        { id: 'fetal', icon: 'ğŸ¤°', title: 'Fetal Circulation', desc: 'Fetal shunts, closure mechanisms, and pathology', count: `${(data.fetalCirculation||[]).length} structures`, color: 'bg-indigo-50 text-indigo-600 border-indigo-300' },
        { id: 'sports', icon: 'ğŸƒ', title: 'Sports Cardiology', desc: 'Screening, management, and return-to-play guidelines', count: `${(data.sportsCardiology||[]).length} conditions`, color: 'bg-emerald-50 text-emerald-600 border-emerald-300' },
        { id: 'pearls', icon: 'ğŸ’¡', title: 'Pearls & Associations', desc: 'High-yield buzzword associations and clinical pearls', count: `${(data.clinicalPearls||[]).length + (data.associations||[]).length} items`, color: 'bg-yellow-50 text-yellow-600 border-yellow-300' },
      ];
      const getProgressBadge = (moduleId) => {
        // Only murmur_master and scenarios have quiz progress tracking
        const quizModuleMap = {
          'murmur_master': 'cardio_murmur_quiz',
          'scenarios': 'cardio_shelf_scenarios'
        };
        const key = quizModuleMap[moduleId];
        if (!key) return null; // No progress tracked for reference modules
        const progress = IDProgress.getLatest(key);
        if (!progress) return null;
        const color = progress.pct >= 80 ? 'bg-emerald-50 text-emerald-600' : progress.pct >= 60 ? 'bg-amber-50 text-amber-600' : 'bg-red-50 text-red-600';
        return <span className={`text-[10px] px-2 py-1 rounded-full font-medium ${color}`}>{progress.pct}%</span>;
      };
      return (
        <div className="space-y-8">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <StatCard label="CHD Lesions" value={(data.chdLesions||[]).length} sub="cyanotic & acyanotic" />
            <StatCard label="Murmur Master" value={(data.murmurQuiz||[]).length} sub="quiz cases + explore atlas" />
            <StatCard label="ECG Patterns" value={(data.ecgPatterns||[]).length} sub="peds-specific" />
            <StatCard label="Scenarios" value={(data.shelfScenarios||[]).length} sub="shelf exam style" />
          </div>
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {modules.map(m => (
              <button key={m.id} onClick={() => setTab(m.id)}
                className={`flex items-start gap-3.5 p-5 rounded-xl border text-left hover:brightness-110 transition relative ${m.color}`}>
                <span className="text-2xl mt-0.5">{m.icon}</span>
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2 mb-0.5">
                    <div className="font-semibold text-sm">{m.title}</div>
                    {getProgressBadge(m.id)}
                  </div>
                  <div className="text-xs opacity-70 leading-relaxed">{m.desc}</div>
                  <div className="text-[10px] mt-2 opacity-50">{m.count}</div>
                </div>
              </button>
            ))}
          </div>
        </div>
      );
    }

    // â”€â”€â”€ CHD CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function CHDCards({ lesions }) {
      const [tab, setTab] = useState('cyanotic');
      const [expanded, setExpanded] = useState({});
      const toggle = (id) => setExpanded(prev => ({ ...prev, [id]: !prev[id] }));
      const filtered = (lesions || []).filter(l => (tab === 'cyanotic' ? l.category === 'cyanotic' : l.category === 'acyanotic'));
      return (
        <div>
          <div className="flex gap-2 mb-6">
            <button onClick={() => setTab('cyanotic')}
              className={`px-4 py-2 text-sm rounded-lg font-medium transition ${tab === 'cyanotic' ? 'bg-red-600 text-white' : 'bg-slate-800/30 text-slate-400 hover:text-slate-300'}`}>
              ğŸ”´ Cyanotic
            </button>
            <button onClick={() => setTab('acyanotic')}
              className={`px-4 py-2 text-sm rounded-lg font-medium transition ${tab === 'acyanotic' ? 'bg-blue-600 text-white' : 'bg-slate-800/30 text-slate-400 hover:text-slate-300'}`}>
              ğŸ”µ Acyanotic
            </button>
          </div>
          <div className="space-y-4">
            {filtered.map(l => (
              <div key={l.id} onClick={() => toggle(l.id)} className="cursor-pointer">
                <div className={`p-4 rounded-xl border transition ${expanded[l.id] ? (l.category === 'cyanotic' ? 'bg-red-50 border-red-300' : 'bg-blue-50 border-blue-300') : 'bg-slate-800/50 border-slate-700 hover:border-slate-400'}`}>
                  <div className="flex items-center justify-between">
                    <div>
                      <h3 className="font-semibold text-white">{l.lesion}</h3>
                      <p className="text-xs text-slate-400 mt-1">{l.category}</p>
                    </div>
                    <span className={`text-lg transition ${expanded[l.id] ? 'rotate-90' : ''}`}>â–¶</span>
                  </div>
                  {expanded[l.id] && (
                    <div className="mt-4 pt-4 border-t border-slate-700 space-y-3">
                      <div className="text-sm"><span className="text-slate-400">Hemodynamics:</span> <span className="text-slate-300">{l.hemodynamics}</span></div>
                      <div className="text-sm"><span className="text-slate-400">Presentation:</span> <span className="text-slate-300">{l.presentation}</span></div>
                      <div className="text-sm"><span className="text-slate-400">Murmur:</span> <span className="text-slate-300">{l.murmur}</span></div>
                      <div className="text-sm"><span className="text-slate-400">Management:</span> <span className="text-slate-300">{l.management}</span></div>
                      {l.ageGroup && <div className="text-sm"><span className="text-slate-400">Age Group:</span> <span className="text-slate-300">{l.ageGroup}</span></div>}
                      {l.associations && (
                        <div className="text-sm"><span className="text-slate-400">Associations:</span> <span className="text-slate-300">{l.associations}</span></div>
                      )}
                      {l.buzzwords && (
                        <div className="flex flex-wrap gap-1.5 mt-3">
                          {(l.buzzwords || []).map((bw, i) => (
                            <span key={i} className={`text-[10px] px-2.5 py-1 rounded-full font-medium ${l.category === 'cyanotic' ? 'bg-red-50 text-red-600' : 'bg-blue-50 text-blue-600'}`}>{bw}</span>
                          ))}
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // â”€â”€â”€ MURMUR WAVEFORM SVG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function MurmurWaveform({ type, small }) {
      const h = small ? 30 : 50;
      const w = small ? 120 : 200;
      const paths = {
        'crescendo-decrescendo': `M0,${h} L${w*0.1},${h} L${w*0.3},${h*0.2} L${w*0.5},${h} L${w*0.55},${h} L${w*0.6},${h} L${w*0.95},${h} L${w},${h}`,
        'holosystolic': `M0,${h} L${w*0.1},${h} L${w*0.12},${h*0.35} L${w*0.48},${h*0.35} L${w*0.5},${h} L${w*0.55},${h} L${w*0.95},${h} L${w},${h}`,
        'continuous': `M0,${h} L${w*0.05},${h} Q${w*0.15},${h*0.3} ${w*0.25},${h*0.4} Q${w*0.35},${h*0.5} ${w*0.45},${h*0.3} Q${w*0.55},${h*0.15} ${w*0.65},${h*0.35} Q${w*0.75},${h*0.5} ${w*0.85},${h*0.45} L${w*0.95},${h} L${w},${h}`,
        'ejection': `M0,${h} L${w*0.1},${h} L${w*0.2},${h*0.55} L${w*0.35},${h*0.2} L${w*0.48},${h*0.65} L${w*0.5},${h} L${w*0.55},${h} L${w*0.95},${h} L${w},${h}`,
        'diastolic': `M0,${h} L${w*0.1},${h} L${w*0.15},${h*0.75} L${w*0.45},${h*0.75} L${w*0.5},${h} L${w*0.55},${h} L${w*0.58},${h*0.35} L${w*0.65},${h*0.5} L${w*0.85},${h*0.85} L${w*0.95},${h} L${w},${h}`,
        'late-systolic': `M0,${h} L${w*0.1},${h} L${w*0.3},${h} L${w*0.32},${h*0.7} L${w*0.35},${h*0.4} L${w*0.48},${h*0.55} L${w*0.5},${h} L${w*0.55},${h} L${w*0.95},${h} L${w},${h}`,
        'innocent': `M0,${h} L${w*0.1},${h} L${w*0.2},${h*0.7} Q${w*0.3},${h*0.5} ${w*0.35},${h*0.65} L${w*0.45},${h*0.85} L${w*0.5},${h} L${w*0.55},${h} L${w*0.95},${h} L${w},${h}`,
        'none': `M0,${h} L${w},${h}`,
        'variable': `M0,${h} L${w*0.1},${h} Q${w*0.2},${h*0.6} ${w*0.25},${h*0.7} Q${w*0.3},${h*0.8} ${w*0.35},${h*0.6} L${w*0.5},${h} L${w*0.55},${h} L${w*0.7},${h*0.75} L${w*0.8},${h*0.65} L${w*0.95},${h} L${w},${h}`,
        'systolic': `M0,${h} L${w*0.1},${h} L${w*0.15},${h*0.5} L${w*0.3},${h*0.25} L${w*0.45},${h*0.6} L${w*0.5},${h} L${w*0.55},${h} L${w*0.95},${h} L${w},${h}`
      };
      const d = paths[type] || paths['systolic'];
      const labels = { 'crescendo-decrescendo': 'Crescendo-Decrescendo', 'holosystolic': 'Holosystolic (Pansystolic)', 'continuous': 'Continuous (Machinery)', 'ejection': 'Systolic Ejection', 'diastolic': 'Diastolic', 'late-systolic': 'Late Systolic + Click', 'innocent': 'Innocent / Vibratory', 'none': 'No Murmur / Silent', 'variable': 'Variable', 'systolic': 'Systolic' };
      return (
        <div className="flex flex-col items-center">
          <svg viewBox={`0 0 ${w} ${h+8}`} className={small ? 'w-28 h-8' : 'w-48 h-14'}>
            <line x1={w*0.5} y1="0" x2={w*0.5} y2={h} stroke="#94a3b8" strokeWidth="1" strokeDasharray="2,2" />
            <line x1={w*0.1} y1={h} x2={w*0.95} y2={h} stroke="#64748b" strokeWidth="1" />
            <text x={w*0.08} y={h+7} fontSize="6" fill="#94a3b8">S1</text>
            <text x={w*0.48} y={h+7} fontSize="6" fill="#94a3b8">S2</text>
            <text x={w*0.08} y={h*0.15} fontSize="5" fill="#cbd5e1">sys</text>
            <text x={w*0.56} y={h*0.15} fontSize="5" fill="#cbd5e1">dia</text>
            <path d={d} fill="none" stroke="#f43f5e" strokeWidth={small ? 1.5 : 2} strokeLinecap="round" strokeLinejoin="round" />
          </svg>
          {!small && <div className="text-[10px] text-rose-400 font-medium mt-1 text-center">{labels[type] || type}</div>}
        </div>
      );
    }

    // â”€â”€â”€ INTERACTIVE HEART DIAGRAM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function HeartDiagram({ activeLocation, onLocationClick, highlightLocations }) {
      const locations = [
        { id: 'aortic', label: 'Aortic', abbr: 'A', cx: 138, cy: 72, desc: 'RUSB (2nd ICS, right)', color: '#ef4444' },
        { id: 'pulmonic', label: 'Pulmonic', abbr: 'P', cx: 92, cy: 72, desc: 'LUSB (2nd ICS, left)', color: '#8b5cf6' },
        { id: 'erbs', label: "Erb's Point", abbr: 'E', cx: 108, cy: 108, desc: '3rd ICS, left sternal border', color: '#f59e0b' },
        { id: 'tricuspid', label: 'Tricuspid', abbr: 'T', cx: 118, cy: 145, desc: 'LLSB (4th ICS, left)', color: '#06b6d4' },
        { id: 'mitral', label: 'Mitral (Apex)', abbr: 'M', cx: 85, cy: 175, desc: '5th ICS, midclavicular', color: '#10b981' },
      ];
      const active = highlightLocations || [];
      return (
        <div className="relative mx-auto" style={{ width: 220, height: 240 }}>
          <svg viewBox="0 0 220 240" className="w-full h-full">
            <defs>
              <radialGradient id="heartGrad" cx="50%" cy="40%">
                <stop offset="0%" stopColor="#fda4af" />
                <stop offset="100%" stopColor="#be123c" />
              </radialGradient>
              <filter id="heartShadow">
                <feDropShadow dx="0" dy="2" stdDeviation="4" floodColor="#881337" floodOpacity="0.3" />
              </filter>
            </defs>
            {/* Chest outline */}
            <ellipse cx="115" cy="130" rx="90" ry="105" fill="none" stroke="#334155" strokeWidth="1.5" strokeDasharray="4,3" opacity="0.4" />
            <text x="115" y="22" textAnchor="middle" fontSize="9" fill="#64748b" fontWeight="600">ANTERIOR CHEST</text>
            {/* Rib hints */}
            {[55,80,105,130,155].map((y,i) => <line key={i} x1="40" y1={y} x2="190" y2={y} stroke="#334155" strokeWidth="0.5" opacity="0.15" />)}
            {/* Heart shape */}
            <path d="M 110 85 C 110 55, 155 45, 155 80 C 155 110, 125 145, 110 175 C 95 145, 65 110, 65 80 C 65 45, 110 55, 110 85 Z"
              fill="url(#heartGrad)" stroke="#9f1239" strokeWidth="2" filter="url(#heartShadow)" opacity="0.85" />
            {/* Auscultation points */}
            {locations.map(loc => {
              const isActive = activeLocation === loc.id || active.includes(loc.id);
              return (
                <g key={loc.id} onClick={() => onLocationClick && onLocationClick(loc.id)} className="cursor-pointer">
                  <circle cx={loc.cx} cy={loc.cy} r={isActive ? 14 : 10} fill={isActive ? loc.color : '#1e293b'} stroke={loc.color} strokeWidth={isActive ? 3 : 2}
                    opacity={isActive ? 1 : 0.7} className="transition-all duration-300" />
                  <text x={loc.cx} y={loc.cy + 4} textAnchor="middle" fontSize="10" fill="white" fontWeight="bold">{loc.abbr}</text>
                  {isActive && <circle cx={loc.cx} cy={loc.cy} r="18" fill="none" stroke={loc.color} strokeWidth="1.5" opacity="0.4">
                    <animate attributeName="r" from="14" to="22" dur="1.2s" repeatCount="indefinite" />
                    <animate attributeName="opacity" from="0.6" to="0" dur="1.2s" repeatCount="indefinite" />
                  </circle>}
                </g>
              );
            })}
          </svg>
          {/* Callout labels */}
          {locations.map(loc => {
            const isActive = activeLocation === loc.id || active.includes(loc.id);
            const isLeft = loc.cx < 110;
            return (
              <div key={loc.id + '-label'} onClick={() => onLocationClick && onLocationClick(loc.id)}
                className={`absolute cursor-pointer transition-all duration-200 ${isActive ? 'opacity-100 scale-105' : 'opacity-60 hover:opacity-90'}`}
                style={{ top: loc.cy - 8, left: isLeft ? -4 : undefined, right: isLeft ? undefined : -4, transform: isLeft ? 'translateX(-100%)' : 'translateX(100%)' }}>
                <div className={`flex items-center gap-1.5 px-2.5 py-1 rounded-lg text-[10px] font-bold border whitespace-nowrap ${isActive ? 'text-white border-opacity-60' : 'text-slate-400 border-slate-700'}`}
                  style={isActive ? { backgroundColor: loc.color + '30', borderColor: loc.color } : {}}>
                  {!isLeft && <div className="w-4 h-px" style={{ backgroundColor: isActive ? loc.color : '#475569' }} />}
                  <span>{loc.label}</span>
                  {isLeft && <div className="w-4 h-px" style={{ backgroundColor: isActive ? loc.color : '#475569' }} />}
                </div>
              </div>
            );
          })}
        </div>
      );
    }

    // â”€â”€â”€ MURMUR MASTER â€” GAMIFIED MODULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function MurmurMaster({ items, chdLesions }) {
      const [mode, setMode] = useState('explore'); // 'explore' | 'quiz'
      const [exploredLocation, setExploredLocation] = useState(null);

      // â”€â”€ Explore mode data: murmurs organized by auscultation location â”€â”€
      const MURMUR_ATLAS = [
        { location: 'aortic', murmurs: [
          { name: 'Aortic Stenosis', type: 'crescendo-decrescendo', timing: 'Systolic', buzzwords: ['systolic ejection murmur at RUSB', 'ejection click', 'narrow pulse pressure', 'crescendo-decrescendo', 'radiates to carotids'], shelfPearl: 'Bicuspid aortic valve is the most common cause in children. Supravalvular AS â†’ think Williams syndrome (elfin facies, hypercalcemia).', associated: 'Bicuspid aortic valve, Williams syndrome' },
          { name: 'Aortic Regurgitation', type: 'diastolic', timing: 'Early diastolic', buzzwords: ['early diastolic decrescendo murmur', 'wide pulse pressure', 'bounding pulses', 'Austin Flint murmur', 'water-hammer pulse'], shelfPearl: 'In peds, think acute rheumatic fever or endocarditis causing aortic valve damage. Austin Flint murmur = low-pitched diastolic rumble at apex.', associated: 'Rheumatic fever, Marfan, endocarditis' },
        ]},
        { location: 'pulmonic', murmurs: [
          { name: 'Pulmonary Stenosis', type: 'crescendo-decrescendo', timing: 'Systolic', buzzwords: ['systolic ejection murmur at LUSB', 'ejection click', 'Carvallo sign', 'increases with inspiration', 'right axis deviation'], shelfPearl: 'Carvallo sign: murmur increases with inspiration (more RV filling). Associated with Noonan syndrome. Mild PS = observation; moderate-severe = balloon valvuloplasty.', associated: 'Noonan syndrome, congenital rubella' },
          { name: 'Innocent Pulmonary Flow Murmur', type: 'innocent', timing: 'Systolic', buzzwords: ['soft systolic murmur', 'newborn', 'resolves by 6 months', 'peripheral pulmonic stenosis', 'benign'], shelfPearl: 'Very common in newborns due to branch PA angle. Disappears by 3-6 months. No workup needed if asymptomatic with normal exam.', associated: 'Normal variant in newborns' },
          { name: 'ASD (relative PS)', type: 'ejection', timing: 'Systolic', buzzwords: ['fixed split S2', 'soft systolic ejection murmur at LUSB', 'increased pulmonary vascular markings', 'wide fixed split S2'], shelfPearl: 'The murmur in ASD is NOT from the septal defect itself â€” it is from increased flow across the pulmonic valve. The hallmark is FIXED split S2.', associated: 'Ostium secundum (70%), Holt-Oram' },
        ]},
        { location: 'erbs', murmurs: [
          { name: 'Aortic Regurgitation (heard at Erb\'s)', type: 'diastolic', timing: 'Early diastolic', buzzwords: ['high-pitched blowing diastolic', 'best heard sitting up leaning forward', 'end-expiration'], shelfPearl: 'Erb\'s point is where AR is often best heard. Have the patient sit up, lean forward, and exhale.', associated: 'Rheumatic heart disease, bicuspid AV' },
          { name: 'HOCM', type: 'systolic', timing: 'Systolic', buzzwords: ['increases with Valsalva', 'decreases with squatting', 'sudden cardiac death in athletes', 'asymmetric septal hypertrophy', 'SAM of mitral valve'], shelfPearl: 'HOCM = #1 cause of sudden cardiac death in young athletes. Murmur INCREASES with Valsalva (less preload â†’ more obstruction). OPPOSITE of fixed AS. Disqualify from competitive sports.', associated: 'Autosomal dominant, sarcomeric mutations' },
        ]},
        { location: 'tricuspid', murmurs: [
          { name: 'VSD', type: 'holosystolic', timing: 'Holosystolic', buzzwords: ['harsh holosystolic murmur at LLSB', 'pansystolic thrill', 'louder with smaller VSD', 'increased pulmonary vascular markings'], shelfPearl: 'Small restrictive VSDs = LOUDER murmur (higher gradient). Large VSDs = softer murmur but worse hemodynamics (FTT, CHF). Many small VSDs close spontaneously.', associated: 'Down syndrome, FAS, DiGeorge' },
          { name: 'Tricuspid Regurgitation', type: 'holosystolic', timing: 'Holosystolic', buzzwords: ['holosystolic at LLSB', 'increases with inspiration', 'Carvallo sign positive', 'prominent v wave in JVP', 'pulsatile liver'], shelfPearl: 'Carvallo sign also applies to TR (louder with inspiration). Think Ebstein anomaly if associated with WPW on ECG.', associated: 'Ebstein anomaly, pulmonary HTN' },
        ]},
        { location: 'mitral', murmurs: [
          { name: 'Mitral Regurgitation', type: 'holosystolic', timing: 'Holosystolic', buzzwords: ['holosystolic murmur at apex', 'radiates to axilla', 'S3 gallop', 'acute rheumatic fever'], shelfPearl: 'In peds, MR is most commonly from acute rheumatic fever (pancarditis). Carey-Coombs murmur = mid-diastolic murmur in acute RF from inflamed mitral valve.', associated: 'Rheumatic fever, AV canal defect' },
          { name: 'Mitral Valve Prolapse', type: 'late-systolic', timing: 'Mid-to-late systolic', buzzwords: ['mid-systolic click', 'late systolic murmur', 'click moves earlier with Valsalva', 'click moves later with squatting', 'Marfan'], shelfPearl: 'Click + late SEM. Valsalva (less preload) â†’ prolapse earlier â†’ click/murmur earlier. Squatting (more preload) â†’ prolapse later â†’ click/murmur later. Common in teenage girls, Marfan, Ehlers-Danlos.', associated: 'Marfan, Ehlers-Danlos, adolescent girls' },
          { name: 'Still\'s Murmur (Innocent)', type: 'innocent', timing: 'Systolic', buzzwords: ['musical vibratory', 'grade 1-2', 'louder when supine', 'disappears with Valsalva', 'most common innocent murmur'], shelfPearl: 'Most common innocent murmur in children (2-7 years). Musical/vibratory quality. Louder supine, softer standing. Disappears with Valsalva. NO diastolic component, NO associated symptoms.', associated: 'Normal variant, ages 2-7' },
        ]},
      ];

      // â”€â”€ EXPLORE MODE â”€â”€
      const activeAtlas = MURMUR_ATLAS.find(a => a.location === exploredLocation);

      // â”€â”€ QUIZ MODE â”€â”€
      const [queue, setQueue] = useState(() => [...items].sort(() => Math.random() - 0.5));
      const [idx, setIdx] = useState(0);
      const [revealedClues, setRevealedClues] = useState(1);
      const [guessed, setGuessed] = useState(false);
      const [selected, setSelected] = useState(null);
      const [score, setScore] = useState({ correct: 0, total: 0 });
      const [missed, setMissed] = useState([]);
      const [streak, setStreak] = useState(0);
      const [bestStreak, setBestStreak] = useState(0);
      const savedRef = useRef(false);
      const game = useGameQuiz('cardio_murmur_quiz');

      const current = queue[idx];
      const isComplete = mode === 'quiz' && !current && score.total > 0;

      useEffect(() => {
        if (isComplete && !savedRef.current) {
          IDProgress.save('cardio_murmur_quiz', { correct: score.correct, total: score.total, missed, bestStreak });
          game.onComplete({ correct: score.correct, total: score.total });
          savedRef.current = true;
        }
      }, [isComplete]);

      const options = useMemo(() => {
        if (!current || !current.answer) return [];
        return [current.answer, ...(current.distractors || [])].sort(() => Math.random() - 0.5);
      }, [idx, mode]);

      const handleGuess = (opt) => {
        if (guessed || !current) return;
        setSelected(opt);
        setGuessed(true);
        const isCorrect = opt === current.answer;
        setScore(prev => ({ correct: prev.correct + (isCorrect ? 1 : 0), total: prev.total + 1 }));
        game.onAnswer(current?.id, isCorrect);
        if (isCorrect) { const ns = streak + 1; setStreak(ns); if (ns > bestStreak) setBestStreak(ns); }
        else { setStreak(0); setMissed(prev => [...prev, { clue: (current.clues||[]).join(' â†’ '), correctAnswer: current.answer, yourAnswer: opt }]); }
      };

      const resetQuiz = () => {
        setQueue([...items].sort(() => Math.random() - 0.5)); setIdx(0); setRevealedClues(1); setGuessed(false);
        setSelected(null); setScore({ correct: 0, total: 0 }); setMissed([]); setStreak(0); setBestStreak(0); savedRef.current = false;
      };

      // â”€â”€ Map murmurType to auscultation location for the heart highlight â”€â”€
      const getQuizLocations = (item) => {
        if (!item) return [];
        const clueText = (item.clues || []).join(' ').toLowerCase();
        const locs = [];
        if (clueText.includes('rusb') || clueText.includes('right upper') || clueText.includes('aortic area')) locs.push('aortic');
        if (clueText.includes('lusb') || clueText.includes('left upper') || clueText.includes('pulm')) locs.push('pulmonic');
        if (clueText.includes('llsb') || clueText.includes('left lower') || clueText.includes('tricuspid')) locs.push('tricuspid');
        if (clueText.includes('apex') || clueText.includes('mitral') || clueText.includes('apical')) locs.push('mitral');
        if (clueText.includes('erb') || clueText.includes('left sternal border') || clueText.includes('valsalva')) locs.push('erbs');
        if (locs.length === 0) locs.push('tricuspid'); // default
        return locs;
      };

      return (
        <div className="space-y-6">
          {/* Mode Selector */}
          <div className="flex items-center gap-3 mb-2">
            <button onClick={() => setMode('explore')}
              className={`flex items-center gap-2 px-5 py-2.5 rounded-xl text-sm font-semibold transition border ${mode === 'explore' ? 'bg-rose-950/30 text-rose-300 border-rose-800/40' : 'bg-slate-800/40 text-slate-400 border-slate-700 hover:text-slate-300'}`}>
              <span>ğŸ«€</span> Explore Murmurs
            </button>
            <button onClick={() => { setMode('quiz'); if (score.total === 0 && idx === 0) resetQuiz(); }}
              className={`flex items-center gap-2 px-5 py-2.5 rounded-xl text-sm font-semibold transition border ${mode === 'quiz' ? 'bg-rose-950/30 text-rose-300 border-rose-800/40' : 'bg-slate-800/40 text-slate-400 border-slate-700 hover:text-slate-300'}`}>
              <span>ğŸ®</span> Quiz Mode
            </button>
          </div>

          {/* â•â•â• EXPLORE MODE â•â•â• */}
          {mode === 'explore' && (
            <div className="animate-fadeIn">
              <p className="text-sm text-slate-400 mb-6 leading-relaxed">Click any <strong className="text-slate-300">auscultation site</strong> on the heart to explore murmurs heard at that location â€” with <strong className="text-slate-300">waveform patterns</strong>, <strong className="text-slate-300">shelf buzzwords</strong>, and clinical pearls.</p>
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                {/* LEFT: Heart Diagram */}
                <div className="bg-slate-800/50 rounded-2xl p-6 border border-slate-700">
                  <div className="text-[10px] font-bold uppercase tracking-widest text-rose-400/60 mb-4 text-center">Auscultation Sites</div>
                  <HeartDiagram activeLocation={exploredLocation} onLocationClick={(id) => setExploredLocation(exploredLocation === id ? null : id)} highlightLocations={[]} />
                  <div className="mt-4 grid grid-cols-5 gap-1.5">
                    {['aortic','pulmonic','erbs','tricuspid','mitral'].map(loc => {
                      const atlas = MURMUR_ATLAS.find(a => a.location === loc);
                      return (
                        <button key={loc} onClick={() => setExploredLocation(exploredLocation === loc ? null : loc)}
                          className={`text-[10px] py-1.5 px-1 rounded-lg font-medium transition border text-center ${exploredLocation === loc ? 'bg-rose-950/40 text-rose-300 border-rose-800/40' : 'bg-slate-800/30 text-slate-500 border-slate-700 hover:text-slate-300'}`}>
                          {loc === 'erbs' ? "Erb's" : loc.charAt(0).toUpperCase() + loc.slice(1)}
                          <div className="text-[8px] opacity-50 mt-0.5">{atlas?.murmurs.length || 0} murmurs</div>
                        </button>
                      );
                    })}
                  </div>
                </div>

                {/* RIGHT: Murmur Details for selected location */}
                <div className="space-y-4">
                  {!activeAtlas && (
                    <div className="bg-slate-800/30 border border-slate-700 rounded-2xl p-8 text-center">
                      <div className="text-4xl mb-3">ğŸ©º</div>
                      <h3 className="text-lg font-bold text-slate-300 mb-2">Select an Auscultation Site</h3>
                      <p className="text-sm text-slate-500 leading-relaxed">Click on the heart diagram or a button below it to explore murmurs at each location.</p>
                    </div>
                  )}
                  {activeAtlas && activeAtlas.murmurs.map((m, mi) => (
                    <div key={mi} className="bg-slate-800/50 border border-slate-700 rounded-xl p-5 animate-fadeIn">
                      <div className="flex items-start justify-between mb-3">
                        <div>
                          <h4 className="font-bold text-white text-sm mb-0.5">{m.name}</h4>
                          <div className="text-[10px] text-slate-500">{m.timing} Â· {m.associated}</div>
                        </div>
                        <MurmurWaveform type={m.type} small={true} />
                      </div>
                      {/* Waveform large */}
                      <div className="bg-slate-900/60 rounded-lg p-3 mb-3 flex justify-center">
                        <MurmurWaveform type={m.type} />
                      </div>
                      {/* Buzzwords */}
                      <div className="mb-3">
                        <div className="text-[10px] font-bold uppercase tracking-widest text-amber-400/60 mb-2">Shelf Buzzwords</div>
                        <div className="flex flex-wrap gap-1.5">
                          {m.buzzwords.map((bw, bi) => (
                            <span key={bi} className="text-[10px] px-2 py-0.5 bg-amber-500/15 text-amber-300 rounded-full font-medium border border-amber-700/20">{bw}</span>
                          ))}
                        </div>
                      </div>
                      {/* Shelf Pearl */}
                      <div className="bg-amber-950/15 border border-amber-800/20 rounded-lg p-3">
                        <div className="text-[10px] font-bold text-amber-400 mb-1">SHELF PEARL</div>
                        <p className="text-xs text-amber-200/80 leading-relaxed">{m.shelfPearl}</p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* â•â•â• QUIZ MODE â•â•â• */}
          {mode === 'quiz' && (
            <div className="animate-fadeIn">
              <GameHeader />

              {/* Quiz Complete */}
              {isComplete && (() => {
                const pct = Math.round(score.correct / Math.max(1, score.total) * 100);
                const best = IDProgress.getModule('cardio_murmur_quiz');
                const color = pct >= 80 ? 'text-emerald-400' : pct >= 60 ? 'text-amber-400' : 'text-red-400';
                return (
                  <div className="max-w-3xl mx-auto py-8">
                    <div className="text-center mb-8">
                      <div className="text-5xl mb-4">{pct >= 80 ? 'ğŸ†' : pct >= 60 ? 'ğŸ”' : 'ğŸ“š'}</div>
                      <h2 className="text-xl font-bold text-white mb-1">Murmur Quiz Complete!</h2>
                      <p className={`text-3xl font-bold ${color} mb-1`}>{pct}%</p>
                      <p className="text-slate-400 text-sm">{score.correct} / {score.total} correct Â· Best streak: {bestStreak}</p>
                      {best.attempts.length > 1 && <p className="text-xs text-slate-400 mt-1">Personal best: {best.bestScore}% Â· Attempt #{best.attempts.length}</p>}
                    </div>
                    {missed.length > 0 && (
                      <div className="mb-8">
                        <h3 className="text-xs font-bold text-red-400 uppercase tracking-wider mb-3">Missed Cases â€” Review These</h3>
                        <div className="space-y-2">
                          {missed.map((m, i) => (
                            <div key={i} className="flex flex-col gap-2 p-3 bg-red-950/20 border border-red-800/20 rounded-lg text-sm">
                              <span className="text-slate-400 text-xs"><strong className="text-slate-300">Clues:</strong> {m.clue}</span>
                              <div className="flex items-center gap-2 flex-wrap">
                                <span className="text-red-400">âœ—</span>
                                <span className="text-red-300/70 text-xs">You:</span>
                                <span className="text-red-300 text-xs">{m.yourAnswer}</span>
                                <span className="text-slate-600 mx-1">â†’</span>
                                <span className="text-emerald-400 font-medium text-xs">{m.correctAnswer}</span>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                    {pct < 80 && (
                      <div className="p-4 bg-amber-950/15 border border-amber-700/20 rounded-xl mb-6">
                        <p className="text-xs text-amber-200/80 leading-relaxed">ğŸ’¡ <strong>Study tip:</strong> Switch to <strong>Explore mode</strong> and review the auscultation sites for the murmurs you missed. Focus on the waveform patterns and shelf buzzwords.</p>
                      </div>
                    )}
                    <div className="flex gap-3 justify-center">
                      <button onClick={() => setMode('explore')} className="px-5 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm font-medium transition">Explore Murmurs</button>
                      <button onClick={resetQuiz} className="px-6 py-2.5 bg-rose-600 hover:bg-rose-500 text-white rounded-lg text-sm font-medium transition">Play Again</button>
                    </div>
                  </div>
                );
              })()}

              {/* Active Quiz */}
              {!isComplete && current && (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {/* LEFT: Heart + Waveform */}
                  <div className="space-y-4">
                    <div className="bg-slate-800/50 border border-slate-700 rounded-2xl p-5">
                      <div className="text-[10px] font-bold uppercase tracking-widest text-rose-400/60 mb-3 text-center">Where would you auscultate?</div>
                      <HeartDiagram activeLocation={null} highlightLocations={guessed ? getQuizLocations(current) : []} />
                    </div>
                    {/* Waveform hint (shown after answer) */}
                    {guessed && current.murmurType && (
                      <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-4 animate-fadeIn">
                        <div className="text-[10px] font-bold uppercase tracking-widest text-rose-400/60 mb-2 text-center">Murmur Pattern</div>
                        <div className="flex justify-center">
                          <MurmurWaveform type={current.murmurType} />
                        </div>
                      </div>
                    )}
                  </div>

                  {/* RIGHT: Clues + MCQ */}
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <span className="text-sm text-slate-400 tabular-nums font-medium">{idx + 1} / {queue.length}</span>
                        {streak >= 3 && <span className="text-xs px-2.5 py-1 bg-amber-500/20 text-amber-300 rounded-full font-bold animate-fadeIn">ğŸ”¥ {streak} streak!</span>}
                      </div>
                      <div className="flex items-center gap-3">
                        <ComboDisplay combo={game.combo} />
                        <span className={`text-[10px] px-2.5 py-1 rounded-full font-medium ${current.difficulty === 'advanced' ? 'bg-red-950/30 text-red-300' : 'bg-blue-950/30 text-blue-300'}`}>{current.difficulty || 'core'}</span>
                      </div>
                    </div>

                    {/* Clue Card */}
                    <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-6">
                      <div className="text-[10px] font-bold uppercase tracking-widest text-rose-400/60 mb-4">Clinical Clues</div>
                      <div className="space-y-2.5">
                        {(current.clues || []).map((clue, ci) => (
                          <div key={ci} className={`flex items-start gap-3 transition-all duration-300 ${ci < revealedClues ? 'opacity-100' : 'opacity-0 h-0 overflow-hidden'}`}>
                            <span className="text-xs text-rose-400 font-mono mt-0.5 shrink-0 w-4">{ci + 1}.</span>
                            <span className="text-sm text-slate-300 leading-relaxed">{clue}</span>
                          </div>
                        ))}
                      </div>
                      {!guessed && revealedClues < (current.clues || []).length && (
                        <button onClick={() => setRevealedClues(prev => prev + 1)}
                          className="mt-4 text-xs text-rose-400 hover:text-rose-300 font-medium transition flex items-center gap-1">
                          <span>+</span> Reveal next clue ({revealedClues}/{current.clues?.length || 0})
                        </button>
                      )}
                    </div>

                    {/* MCQ */}
                    <div>
                      <div className="text-xs text-slate-500 uppercase tracking-widest mb-3 font-bold">What murmur is this?</div>
                      <div className="grid grid-cols-1 gap-2">
                        {options.map((opt, i) => {
                          let cls = 'bg-slate-800/30 border-slate-700 hover:border-rose-500/40 hover:bg-slate-800/50';
                          if (guessed) {
                            if (opt === current.answer) cls = 'bg-emerald-950/30 border-emerald-500/60';
                            else if (opt === selected) cls = 'bg-red-950/30 border-red-500/60';
                            else cls = 'bg-slate-800/20 border-slate-700 opacity-30';
                          }
                          return (
                            <button key={i} onClick={() => handleGuess(opt)} disabled={guessed}
                              className={`choice-btn text-left p-3.5 rounded-xl border-2 transition text-sm font-medium ${cls}`}>
                              <div className="flex items-center gap-3">
                                <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center text-xs font-bold shrink-0 ${guessed && opt === current.answer ? 'bg-emerald-500 border-emerald-500 text-white' : guessed && opt === selected ? 'bg-red-500 border-red-500 text-white' : 'border-slate-600 text-slate-500'}`}>
                                  {guessed ? (opt === current.answer ? 'âœ“' : opt === selected ? 'âœ—' : String.fromCharCode(65+i)) : String.fromCharCode(65+i)}
                                </div>
                                <span className="text-slate-300">{opt}</span>
                              </div>
                            </button>
                          );
                        })}
                      </div>
                    </div>

                    {/* Feedback */}
                    {guessed && (
                      <div className="space-y-3 animate-fadeIn">
                        <div className={`p-5 rounded-xl border ${selected === current.answer ? 'bg-emerald-950/20 border-emerald-700/30' : 'bg-red-950/15 border-red-800/20'}`}>
                          <div className="text-xs font-bold mb-2 uppercase tracking-wider" style={{ color: selected === current.answer ? '#6ee7b7' : '#fca5a5' }}>
                            {selected === current.answer ? 'Correct!' : `Incorrect â€” Answer: ${current.answer}`}
                          </div>
                          <FormattedText text={current.explanation} className="feedback-text" />
                        </div>
                        <button onClick={() => { setIdx(prev => prev + 1); setRevealedClues(1); setGuessed(false); setSelected(null); }}
                          className="w-full py-3 bg-rose-600 hover:bg-rose-500 text-white rounded-xl text-sm font-semibold transition">Next Case â†’</button>
                      </div>
                    )}
                  </div>
                </div>
              )}
              {game.overlays}
            </div>
          )}
        </div>
      );
    }

    // â”€â”€â”€ ACQUIRED HEART DISEASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function AcquiredHeartDisease({ conditions }) {
      const [expanded, setExpanded] = useState({});
      const toggle = (id) => setExpanded(prev => ({ ...prev, [id]: !prev[id] }));
      return (
        <div className="space-y-3">
          {conditions.map(c => (
            <div key={c.id} onClick={() => toggle(c.id)} className="cursor-pointer">
              <div className={`p-4 rounded-xl border transition ${expanded[c.id] ? 'bg-red-50 border-red-300' : 'bg-slate-800/50 border-slate-700 hover:border-slate-400'}`}>
                <div className="flex items-center justify-between">
                  <h3 className="font-semibold text-white">{c.condition}</h3>
                  <span className={`text-lg transition ${expanded[c.id] ? 'rotate-90' : ''}`}>â–¶</span>
                </div>
                {expanded[c.id] && (
                  <div className="mt-4 pt-4 border-t border-slate-700 space-y-2">
                    <div className="text-sm"><span className="text-slate-400">Presentation:</span> <span className="text-slate-300">{c.presentation}</span></div>
                    <div className="text-sm"><span className="text-slate-400">Diagnostics:</span> <span className="text-slate-300">{c.diagnostics}</span></div>
                    <div className="text-sm"><span className="text-slate-400">Treatment:</span> <span className="text-slate-300">{c.treatment}</span></div>
                    <div className="text-sm"><span className="text-slate-400">Complications:</span> <span className="text-slate-300">{c.complications}</span></div>
                    {c.ageGroup && <div className="text-sm"><span className="text-slate-400">Age Group:</span> <span className="text-slate-300">{c.ageGroup}</span></div>}
                    {c.pearlsForShelf && <div className="text-sm mt-2"><span className="text-amber-600">ğŸ’¡</span> <span className="text-amber-700">{c.pearlsForShelf}</span></div>}
                  </div>
                )}
              </div>
            </div>
          ))}
        </div>
      );
    }

    // â”€â”€â”€ ECG PATTERNS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function ECGPatterns({ patterns }) {
      const [selected, setSelected] = useState(null);
      const current = (patterns || []).find(p => p.id === selected);
      return (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="flex flex-col gap-2 h-fit">
            {(patterns || []).map(p => {
              const isNormal = p.normalVariant === true;
              const colorClass = isNormal ? 'bg-emerald-100 border-emerald-400 hover:border-emerald-500' : 'bg-red-50 border-red-300 hover:border-red-400';
              return (
                <button key={p.id} onClick={() => setSelected(p.id)}
                  className={`text-left p-3.5 rounded-lg border transition ${selected === p.id ? colorClass : 'bg-slate-800/50 border-slate-700 hover:border-slate-400'}`}>
                  <div className="font-medium text-sm text-white">{p.pattern}</div>
                  <div className="text-xs text-slate-400 mt-0.5">{isNormal ? 'âœ… Normal variant' : 'âš ï¸ Pathologic'}</div>
                </button>
              );
            })}
          </div>
          {current && (
            <div className="lg:col-span-2 bg-slate-800/50 border border-slate-700 rounded-xl p-6 shadow-sm">
              <h3 className="text-lg font-bold text-white mb-4">{current.pattern}</h3>
              <div className="space-y-4">
                <div><span className="text-slate-400 text-sm font-medium">Description:</span> <span className="text-slate-300 text-sm block mt-1">{current.description || 'N/A'}</span></div>
                <div><span className="text-slate-400 text-sm font-medium">Associations:</span> <span className="text-slate-300 text-sm block mt-1">{Array.isArray(current.associations) ? current.associations.join(', ') : current.associations || 'N/A'}</span></div>
                <div><span className="text-slate-300 text-sm font-medium">Peds Notes:</span> <span className="text-slate-300 text-sm block mt-1">{current.pedsNote || 'N/A'}</span></div>
                {current.shelfTrap && <div><span className="text-amber-600 text-sm font-medium">ğŸš¨ Shelf Trap:</span> <span className="text-amber-700 text-sm block mt-1">{current.shelfTrap}</span></div>}
              </div>
            </div>
          )}
        </div>
      );
    }

    // â”€â”€â”€ CARDIAC PHARMACOLOGY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function CardiacPharm({ drugs }) {
      const [selected, setSelected] = useState(null);
      const current = (drugs || []).find(d => d.id === selected);
      return (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="flex flex-col gap-2 h-fit">
            {drugs.map(d => (
              <button key={d.id} onClick={() => setSelected(d.id)}
                className={`text-left p-3.5 rounded-lg border transition ${selected === d.id ? 'bg-rose-50 border-rose-300 text-rose-600 font-medium' : 'bg-white border-slate-200 hover:border-slate-400 text-slate-700'}`}>
                <div className="font-medium text-sm">{d.drug}</div>
              </button>
            ))}
          </div>
          {current && (
            <div className="lg:col-span-2 bg-white border border-slate-200 rounded-xl p-6">
              <h3 className="text-lg font-bold text-slate-800 mb-4">{current.drug}</h3>
              <div className="space-y-4">
                <div><span className="text-slate-700 text-sm font-medium">Mechanism:</span> <span className="text-slate-700 text-sm block mt-1">{current.mechanism}</span></div>
                <div><span className="text-slate-700 text-sm font-medium">Indication:</span> <span className="text-slate-700 text-sm block mt-1">{current.indication}</span></div>
                <div><span className="text-slate-700 text-sm font-medium">Side Effects:</span> <span className="text-slate-700 text-sm block mt-1">{Array.isArray(current.sideEffects) ? current.sideEffects.join(', ') : current.sideEffects}</span></div>
                <div><span className="text-slate-700 text-sm font-medium">Peds Notes:</span> <span className="text-slate-700 text-sm block mt-1">{current.pedsSpecific}</span></div>
                {current.shelfPearl && <div><span className="text-amber-600 text-sm font-medium">ğŸ’¡ Pearl:</span> <span className="text-amber-700 text-sm block mt-1">{current.shelfPearl}</span></div>}
              </div>
            </div>
          )}
        </div>
      );
    }

    // â”€â”€â”€ SHELF SCENARIOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function ShelfScenarios({ items }) {
      const prepareShelfItems = (itemList) => itemList.map(item => {
        const choices = [item.answer, ...item.wrongAnswers].sort(() => Math.random() - 0.5);
        return { ...item, choices, correctAnswer: item.answer };
      });
      
      const [queue, setQueue] = useState(() => [...prepareShelfItems(items)].sort(() => Math.random() - 0.5));
      const [idx, setIdx] = useState(0);
      const [selected, setSelected] = useState(null);
      const [answered, setAnswered] = useState(false);
      const [score, setScore] = useState({ correct: 0, total: 0 });
      const [missed, setMissed] = useState([]);
      const savedRef = useRef(false);
      const game = useGameQuiz('cardio_shelf_scenarios');

      const current = queue[idx];
      const isComplete = !current && score.total > 0;

      useEffect(() => {
        if (isComplete && !savedRef.current) {
          IDProgress.save('cardio_shelf_scenarios', { correct: score.correct, total: score.total, missed });
          game.onComplete({ correct: score.correct, total: score.total });
          savedRef.current = true;
        }
      }, [isComplete]);

      if (isComplete) {
        const pct = Math.round(score.correct / Math.max(1, score.total) * 100);
        const best = IDProgress.getModule('cardio_shelf_scenarios');
        const color = pct >= 80 ? 'text-emerald-600' : pct >= 60 ? 'text-amber-600' : 'text-red-600';
        return (
          <div className="max-w-2xl mx-auto py-8">
            <div className="text-center mb-8">
              <div className="text-5xl mb-4">{pct >= 80 ? 'ğŸ–ï¸' : pct >= 60 ? 'ğŸ“‹' : 'ğŸ“š'}</div>
              <h2 className="text-xl font-bold text-slate-800 mb-1">Quiz Complete!</h2>
              <p className={`text-3xl font-bold ${color} mb-1`}>{pct}%</p>
              <p className="text-slate-600 text-sm">{score.correct} / {score.total} correct</p>
              {best.attempts.length > 1 && <p className="text-xs text-slate-500 mt-1">Personal best: {best.bestScore}% Â· Attempt #{best.attempts.length}</p>}
            </div>
            {missed.length > 0 && (
              <div className="mb-8">
                <h3 className="text-xs font-bold text-red-600 uppercase tracking-wider mb-3">Missed Cases â€” Review These</h3>
                <div className="space-y-2">
                  {missed.map((m, i) => (
                    <div key={i} className="flex items-center gap-3 p-3 bg-red-50 border border-red-200 rounded-lg text-sm">
                      <span className="text-red-600">âœ—</span>
                      <span className="text-slate-700 flex-1">{m.stem}</span>
                      <span className="text-[10px] text-red-500">(you: {m.yourAnswer} â†’ {m.correctAnswer})</span>
                    </div>
                  ))}
                </div>
              </div>
            )}
            <div className="flex gap-3 justify-center">
              <button onClick={() => { setQueue([...prepareShelfItems(items)].sort(() => Math.random() - 0.5)); setIdx(0); setSelected(null); setAnswered(false); setScore({ correct: 0, total: 0 }); setMissed([]); savedRef.current = false; }}
                className="px-6 py-2.5 bg-rose-600 hover:bg-rose-500 text-white rounded-lg text-sm font-medium transition">Play Again</button>
            </div>
          </div>
        );
      }

      const handleAnswer = (choice) => {
        if (!current) return;
        setSelected(choice);
        setAnswered(true);
        const correct = choice === current.answer;
        game.onAnswer(current?.id, correct);
        setScore(prev => ({ correct: prev.correct + (correct ? 1 : 0), total: prev.total + 1 }));
        if (!correct) setMissed(prev => [...prev, { stem: current.stem, correctAnswer: current.answer, yourAnswer: choice }]);
      };

      if (!current) return null;

      return (
        <div className="max-w-3xl mx-auto">
          <GameHeader />
          <div className="flex items-center justify-between mb-6">
            <div className="flex items-center gap-3"><span className="text-sm text-slate-500 tabular-nums">{idx + 1} / {queue.length}</span><ComboDisplay combo={game.combo} /></div>
            <span className="text-sm text-slate-600 tabular-nums">{score.correct} correct</span>
          </div>

          <div className="bg-white border border-slate-200 rounded-xl p-6 mb-6">
            <div className="text-[10px] font-bold uppercase tracking-widest text-rose-600 mb-3">Clinical Vignette</div>
            <p className="text-sm text-slate-700 leading-relaxed mb-4">{current.stem}</p>
            <div className="text-[10px] font-bold uppercase tracking-widest text-rose-600 mb-3">Question</div>
            <p className="text-sm text-slate-700">{current.question}</p>
          </div>

          <div className="space-y-3 mb-6">
            {current.choices.map((choice, i) => {
              let cls = 'bg-slate-50 border-slate-200 hover:border-slate-400';
              if (answered) {
                if (choice === current.answer) cls = 'bg-emerald-50 border-emerald-400';
                else if (choice === selected) cls = 'bg-red-50 border-red-400';
                else cls = 'bg-slate-50 border-slate-200 opacity-40';
              }
              return (
                <button key={i} onClick={() => !answered && handleAnswer(choice)} disabled={answered}
                  className={`choice-btn w-full text-left p-4 rounded-xl border transition ${cls}`}>
                  <span className="text-sm text-slate-700">{choice}</span>
                </button>
              );
            })}
          </div>

          {answered && (
            <div className="space-y-4">
              <div className={`p-5 rounded-xl border ${selected === current.answer ? 'bg-emerald-50 border-emerald-200' : 'bg-slate-50 border-slate-200'}`}>
                <FormattedText text={current.explanation} className="feedback-text" />
              </div>
              <button onClick={() => { setIdx(prev => prev + 1); setSelected(null); setAnswered(false); }}
                className="w-full py-3 bg-rose-600 hover:bg-rose-500 text-white rounded-xl text-sm font-semibold transition">Next Case â†’</button>
            </div>
          )}
          {game.overlays}
        </div>
      );
    }


    // â”€â”€â”€ FETAL CIRCULATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function FetalCirculation({ structures }) {
      const [selected, setSelected] = useState(null);
      const current = (structures || []).find(s => s.id === selected);
      return (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="flex flex-col gap-2 h-fit">
            {structures.map(s => (
              <button key={s.id} onClick={() => setSelected(s.id)}
                className={`text-left p-3.5 rounded-lg border transition ${selected === s.id ? 'bg-indigo-50 border-indigo-300 text-indigo-600 font-medium' : 'bg-slate-800/50 border-slate-700 hover:border-slate-400 text-slate-400'}`}>
                <div className="font-medium text-sm">{s.structure}</div>
              </button>
            ))}
          </div>
          {current && (
            <div className="lg:col-span-2 bg-slate-800/50 border border-slate-700 rounded-xl p-6">
              <h3 className="text-lg font-bold text-white mb-4">{current.structure}</h3>
              <div className="space-y-4">
                <div><span className="text-slate-400 text-sm font-medium">Fetal Function:</span> <span className="text-slate-300 text-sm block mt-1">{current.fetalFunction}</span></div>
                <div><span className="text-slate-400 text-sm font-medium">Postnatal Fate:</span> <span className="text-slate-300 text-sm block mt-1">{current.postnatalFate}</span></div>
                <div><span className="text-slate-400 text-sm font-medium">Closure Stimulus:</span> <span className="text-slate-300 text-sm block mt-1">{current.closureStimulus}</span></div>
                {current.pathology && <div><span className="text-slate-400 text-sm font-medium">Pathology if Fails:</span> <span className="text-slate-300 text-sm block mt-1">{current.pathology}</span></div>}
                {current.pharmacology && <div><span className="text-slate-400 text-sm font-medium">Pharmacology:</span> <span className="text-slate-300 text-sm block mt-1">{current.pharmacology}</span></div>}
              </div>
            </div>
          )}
        </div>
      );
    }

    // â”€â”€â”€ SPORTS CARDIOLOGY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function SportsCardiology({ items }) {
      const [expanded, setExpanded] = useState({});
      const toggle = (id) => setExpanded(prev => ({ ...prev, [id]: !prev[id] }));
      return (
        <div className="space-y-3">
          {items.map(item => (
            <div key={item.id} onClick={() => toggle(item.id)} className="cursor-pointer">
              <div className={`p-4 rounded-xl border transition ${expanded[item.id] ? 'bg-emerald-50 border-emerald-300' : 'bg-slate-800/50 border-slate-700 hover:border-slate-400'}`}>
                <div className="flex items-center justify-between">
                  <div className="flex-1">
                    <h3 className="font-semibold text-white">{item.condition}</h3>
                    <p className="text-xs text-slate-400 mt-1">{item.risk}</p>
                  </div>
                  <span className={`text-lg transition ${expanded[item.id] ? 'rotate-90' : ''}`}>â–¶</span>
                </div>
                {expanded[item.id] && (
                  <div className="mt-4 pt-4 border-t border-slate-700 space-y-2">
                    <div className="text-sm"><span className="text-slate-400">Screening:</span> <span className="text-slate-300">{item.screening}</span></div>
                    <div className="text-sm"><span className="text-slate-400">Management:</span> <span className="text-slate-300">{item.management}</span></div>
                    {item.shelfPearl && <div className="text-sm mt-2"><span className="text-amber-600">ğŸ’¡</span> <span className="text-amber-700">{item.shelfPearl}</span></div>}
                  </div>
                )}
              </div>
            </div>
          ))}
        </div>
      );
    }

    // â”€â”€â”€ CARDIO PEARLS & ASSOCIATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function CardioPearlsAssociations({ pearls, associations }) {
      const [subTab, setSubTab] = useState('pearls');
      const [flipped, setFlipped] = useState({});
      const toggle = (id) => setFlipped(prev => ({ ...prev, [id]: !prev[id] }));
      return (
        <div>
          <div className="flex gap-2 mb-6">
            <button onClick={() => setSubTab('pearls')}
              className={`px-4 py-2 text-sm rounded-lg font-medium transition ${subTab === 'pearls' ? 'bg-rose-600 text-white' : 'bg-slate-800/50 text-slate-400 hover:text-slate-300'}`}>
              ğŸ’¡ Clinical Pearls
            </button>
            <button onClick={() => setSubTab('associations')}
              className={`px-4 py-2 text-sm rounded-lg font-medium transition ${subTab === 'associations' ? 'bg-rose-600 text-white' : 'bg-slate-800/50 text-slate-400 hover:text-slate-300'}`}>
              ğŸ”— Buzzword Associations
            </button>
          </div>
          {subTab === 'pearls' && (
            <div className="space-y-3">
              {pearls.map(p => (
                <div key={p.id} className="p-4 bg-slate-800/50 border border-slate-700 rounded-xl">
                  <div className="text-sm text-slate-400">{p.pearl}</div>
                </div>
              ))}
            </div>
          )}
          {subTab === 'associations' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              {associations.map(a => (
                <div key={a.id} onClick={() => toggle(a.id)} className="cursor-pointer">
                  <div className={`p-4 rounded-xl border transition ${flipped[a.id] ? 'bg-rose-950/30 border-rose-800/30' : 'bg-slate-800/50 border-slate-700 hover:border-slate-400'}`}>
                    <div className="flex items-center justify-between">
                      <h4 className="font-semibold text-white text-sm">{a.clue}</h4>
                      <span className={`text-lg transition ${flipped[a.id] ? 'rotate-90' : ''}`}>â–¶</span>
                    </div>
                    {flipped[a.id] && (
                      <div className="mt-3 pt-3 border-t border-slate-700">
                        <div className="text-sm text-slate-300">{a.answer}</div>
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    // â”€â”€â”€ CARDIO STUDY GUIDE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function CardioStudyGuide({ data, setTab }) {
      const allScores = [
        { moduleId: 'cardio_murmur_quiz', name: 'Murmur Master' },
        { moduleId: 'cardio_shelf_scenarios', name: 'Shelf Scenarios' },
      ];
      const scores = allScores.map(m => {
        const prog = IDProgress.getModule(m.moduleId);
        return { ...m, pct: prog?.bestScore || 0, attempts: prog?.attempts?.length || 0 };
      });
      const avgScore = Math.round(scores.reduce((s, m) => s + m.pct, 0) / Math.max(1, scores.length));
      const recs = scores.filter(m => m.pct < 75 && m.attempts > 0).map(m => m.name);
      return (
        <div className="max-w-2xl mx-auto space-y-6">
          <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-6">
            <h3 className="text-lg font-bold text-white mb-4">Your Progress</h3>
            <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
              {scores.map(m => (
                <div key={m.moduleId} className="p-3 bg-slate-800/30 rounded-lg border border-slate-700">
                  <div className="text-xs text-slate-400 mb-1">{m.name}</div>
                  <div className={`text-lg font-bold ${m.pct >= 80 ? 'text-emerald-600' : m.pct >= 60 ? 'text-amber-600' : m.pct > 0 ? 'text-red-600' : 'text-slate-400'}`}>{m.pct || 'â€”'}%</div>
                  {m.attempts > 0 && <div className="text-[10px] text-slate-400">{m.attempts} attempt{m.attempts !== 1 ? 's' : ''}</div>}
                </div>
              ))}
            </div>
            <div className="mt-4 pt-4 border-t border-slate-700">
              <div className="text-sm"><span className="text-slate-400">Overall Mastery:</span> <span className={`text-lg font-bold ml-2 ${avgScore >= 80 ? 'text-emerald-600' : avgScore >= 60 ? 'text-amber-600' : 'text-red-600'}`}>{avgScore}%</span></div>
            </div>
          </div>
          {recs.length > 0 && (
            <div className="p-4 bg-amber-50 border border-amber-200 rounded-xl">
              <p className="text-xs text-amber-800 leading-relaxed">
                <strong>ğŸ“š Study Focus:</strong> Review <strong>{recs.join(', ')}</strong> â€” aim for 75%+ on each quiz. Use flashcards and spaced repetition for weak areas.
              </p>
            </div>
          )}
          {avgScore >= 80 && (
            <div className="p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
              <p className="text-xs text-emerald-800 leading-relaxed">
                <strong>ğŸ‰ Great job!</strong> You're mastering cardiology. Now deepen your understanding by exploring the other modules â€” CHD Cards, ECG Patterns, and Fetal Circulation are especially high-yield for shelf exams.
              </p>
            </div>
          )}
        </div>
      );
    }

    // â”€â”€â”€ LOADING SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function LoadingScreen() {
      return (
        <div className="flex items-center justify-center h-64">
          <div className="text-center">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-400 mx-auto mb-4"></div>
            <p className="text-sm text-slate-400">Loading study data...</p>
          </div>
        </div>
      );
    }

    // â”€â”€â”€ PERFORMANCE SUMMARY VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function PerformanceSummaryView({ setView }) {
      const allProgress = IDProgress.getAll();

      // Collect all module scores
      const allModules = [
        { key: 'bug_drug', label: 'Bug-Drug Matcher', category: 'ID' },
        { key: 'whats_the_bug', label: "What's the Bug?", category: 'ID' },
        { key: 'vaccines_quiz', label: 'Vaccine Trainer', category: 'ID' },
        { key: 'cardio_murmur_quiz', label: 'Murmur Master', category: 'Cardio' },
        { key: 'cardio_shelf_scenarios', label: 'Shelf Scenarios', category: 'Cardio' },
      ];

      const moduleScores = allModules.map(m => {
        const data = IDProgress.getModule(m.key);
        const attempts = (data?.attempts || []);
        const latest = attempts.length > 0 ? attempts[attempts.length - 1] : null;
        return {
          ...m,
          correct: latest?.correct || 0,
          total: latest?.total || 0,
          pct: latest?.pct || 0,
          attempts: attempts.length,
          missed: latest?.missed || [],
          bestScore: data?.bestScore || 0,
        };
      }).filter(m => m.attempts > 0);

      // Calculate overall stats
      const totalCorrect = moduleScores.reduce((s, m) => s + m.correct, 0);
      const totalQuestions = moduleScores.reduce((s, m) => s + m.total, 0);
      const overallPct = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
      const avgScore = moduleScores.length > 0 ? Math.round(moduleScores.reduce((s, m) => s + m.pct, 0) / moduleScores.length) : 0;

      // Identify weak areas (< 70%)
      const weakAreas = moduleScores.filter(m => m.pct < 70).sort((a, b) => a.pct - b.pct);

      // Group by category
      const byCategory = {};
      moduleScores.forEach(m => {
        if (!byCategory[m.category]) byCategory[m.category] = [];
        byCategory[m.category].push(m);
      });

      // Completion status
      const notAttempted = allModules.filter(m => !moduleScores.find(ms => ms.key === m.key));
      const percentCompleted = Math.round((moduleScores.length / allModules.length) * 100);

      const getStatusColor = (pct) => {
        if (pct >= 80) return 'bg-emerald-50 border-emerald-200';
        if (pct >= 60) return 'bg-amber-50 border-amber-200';
        return 'bg-red-50 border-red-200';
      };

      const getStatusBg = (pct) => {
        if (pct >= 80) return 'bg-emerald-100 text-emerald-900';
        if (pct >= 60) return 'bg-amber-100 text-amber-900';
        return 'bg-red-100 text-red-900';
      };

      return (
        <div className="animate-fadeIn p-8 max-w-5xl mx-auto space-y-8">
          <div>
            <h1 className="text-2xl font-bold text-slate-800 tracking-tight">Performance Summary</h1>
            <p className="text-slate-500 mt-2 text-sm leading-relaxed">Review your quiz performance across all modules and identify areas for focus.</p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div className="bg-white border border-slate-200 rounded-lg p-5 shadow-sm">
              <div className="text-3xl font-bold text-slate-800 tabular-nums">{overallPct}%</div>
              <div className="text-sm text-slate-700 mt-1 font-medium">Overall Score</div>
              <div className="text-xs text-slate-500 mt-0.5">{totalCorrect}/{totalQuestions} questions</div>
            </div>
            <div className="bg-white border border-slate-200 rounded-lg p-5 shadow-sm">
              <div className="text-3xl font-bold text-slate-800 tabular-nums">{avgScore}%</div>
              <div className="text-sm text-slate-700 mt-1 font-medium">Average Module Score</div>
              <div className="text-xs text-slate-500 mt-0.5">{moduleScores.length} modules attempted</div>
            </div>
            <div className="bg-white border border-slate-200 rounded-lg p-5 shadow-sm">
              <div className="text-3xl font-bold text-slate-800 tabular-nums">{percentCompleted}%</div>
              <div className="text-sm text-slate-700 mt-1 font-medium">Completion</div>
              <div className="text-xs text-slate-500 mt-0.5">{moduleScores.length}/{allModules.length} modules</div>
            </div>
            <div className="bg-white border border-slate-200 rounded-lg p-5 shadow-sm">
              <div className="text-3xl font-bold text-slate-800 tabular-nums">{weakAreas.length}</div>
              <div className="text-sm text-slate-700 mt-1 font-medium">Weak Areas</div>
              <div className="text-xs text-slate-500 mt-0.5">below 70%</div>
            </div>
          </div>

          <div className="space-y-6">
            <div>
              <h2 className="text-lg font-bold text-slate-800 mb-4">Module-by-Module Breakdown</h2>
              <div className="space-y-3">
                {Object.entries(byCategory).map(([cat, mods]) => (
                  <div key={cat}>
                    <h3 className="text-sm font-semibold text-slate-700 mb-2 uppercase tracking-wide">{cat}</h3>
                    <div className="space-y-2">
                      {mods.map(m => (
                        <div key={m.key} className={`p-4 border rounded-lg ${getStatusColor(m.pct)}`}>
                          <div className="flex items-start justify-between">
                            <div className="flex-1">
                              <h4 className="font-semibold text-slate-800">{m.label}</h4>
                              <div className="text-sm text-slate-600 mt-1">{m.correct}/{m.total} correct</div>
                            </div>
                            <div className="text-right">
                              <div className={`inline-block px-3 py-1 rounded-full font-bold text-sm ${getStatusBg(m.pct)}`}>{m.pct}%</div>
                              <div className="text-xs text-slate-500 mt-1">{m.attempts} attempt{m.attempts !== 1 ? 's' : ''}</div>
                            </div>
                          </div>
                          {m.missed.length > 0 && (
                            <div className="mt-2 pt-2 border-t border-current border-opacity-20 text-xs text-slate-600">
                              Missed {m.missed.length} item{m.missed.length !== 1 ? 's' : ''}
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {weakAreas.length > 0 && (
              <div>
                <h2 className="text-lg font-bold text-slate-800 mb-4">Weak Areas (Below 70%)</h2>
                <div className="space-y-3">
                  {weakAreas.map(m => (
                    <div key={m.key} className="p-4 bg-red-50 border border-red-200 rounded-lg">
                      <div className="flex items-start justify-between mb-2">
                        <div>
                          <h4 className="font-semibold text-slate-800">{m.label}</h4>
                          <p className="text-sm text-slate-600 mt-1">Current score: {m.pct}% ({m.correct}/{m.total})</p>
                        </div>
                        <span className="text-2xl font-bold text-red-600">{m.pct}%</span>
                      </div>
                      {(m.missed || []).length > 0 && (
                        <div className="mt-3 p-2 bg-white rounded border border-red-200 text-xs">
                          <div className="font-medium text-slate-700 mb-1">Missed topics ({(m.missed || []).length}):</div>
                          <ul className="space-y-1 text-slate-600">
                            {(m.missed || []).slice(0, 5).map((item, i) => (
                              <li key={i}>â€¢ {item}</li>
                            ))}
                            {(m.missed || []).length > 5 && <li>â€¢ ... and {(m.missed || []).length - 5} more</li>}
                          </ul>
                        </div>
                      )}
                      <button onClick={() => setView({ type: m.category === 'ID' ? 'id_hub' : 'cardio_hub' })}
                        className="mt-3 px-3 py-1 text-xs font-medium bg-red-600 text-white rounded hover:bg-red-700 transition">
                        Practice Again
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {notAttempted.length > 0 && (
              <div>
                <h2 className="text-lg font-bold text-slate-800 mb-4">Not Yet Attempted</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  {notAttempted.map(m => (
                    <div key={m.key} className="p-4 bg-slate-50 border border-slate-200 rounded-lg">
                      <h4 className="font-semibold text-slate-800">{m.label}</h4>
                      <p className="text-xs text-slate-500 mt-1 mb-3">{m.category} Hub</p>
                      <button onClick={() => setView({ type: m.category === 'ID' ? 'id_hub' : 'cardio_hub' })}
                        className="px-3 py-1 text-xs font-medium bg-slate-200 text-slate-800 rounded hover:bg-slate-300 transition">
                        Start Now
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>

          <div className="p-6 bg-blue-50 border border-blue-200 rounded-lg">
            <h3 className="font-semibold text-slate-800 mb-2">Recommendations</h3>
            <ul className="space-y-2 text-sm text-slate-700">
              {weakAreas.length > 0 && (
                <li>â€¢ Focus on <strong>{weakAreas[0].label}</strong> â€” scored {weakAreas[0].pct}%. Review the {weakAreas[0].missed.length} missed items and practice again.</li>
              )}
              {notAttempted.length > 0 && (
                <li>â€¢ Complete {notAttempted.length} remaining module{notAttempted.length !== 1 ? 's' : ''} to get a full picture of your strengths and gaps.</li>
              )}
              {avgScore >= 80 && (
                <li>â€¢ Excellent performance! Focus on maintaining consistency across all modules and deepening your understanding.</li>
              )}
              {avgScore < 60 && (
                <li>â€¢ Aim to reach 70%+ on weak modules before moving to new material. Use spaced repetition for topics you've missed.</li>
              )}
            </ul>
          </div>
        </div>
      );
    }

    // â”€â”€â”€ SMART STUDY VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function SmartStudyView({ setView }) {
      const [activeQuestion, setActiveQuestion] = useState(0);
      const [answers, setAnswers] = useState({});
      const [showResults, setShowResults] = useState(false);
      const allProgress = IDProgress.getAll();

      // Master question bank â€” 40 unique high-yield shelf questions across all modules
      const QUESTION_BANK = [
        // BUG-DRUG (8)
        { id: 'sq1', type: 'bug_drug', question: 'First-line treatment for neonatal GBS meningitis?', options: ['Ampicillin + Gentamicin', 'Ceftriaxone', 'Vancomycin', 'Azithromycin'], correct: 'Ampicillin + Gentamicin', explanation: 'Ampicillin covers GBS and Listeria; gentamicin provides synergy. Ceftriaxone is avoided in neonates due to bilirubin displacement.' },
        { id: 'sq2', type: 'bug_drug', question: 'A 7-year-old with periorbital cellulitis and sinus opacification. Empiric therapy?', options: ['Ampicillin-sulbactam', 'Clindamycin', 'Metronidazole', 'Fluconazole'], correct: 'Ampicillin-sulbactam', explanation: 'Periorbital cellulitis from sinusitis requires coverage of S. pneumoniae, H. influenzae, and M. catarrhalis.' },
        { id: 'sq3', type: 'bug_drug', question: 'Empiric antibiotic for a febrile 3-week-old with UTI?', options: ['Ampicillin + Cefotaxime', 'Amoxicillin PO', 'TMP-SMX', 'Nitrofurantoin'], correct: 'Ampicillin + Cefotaxime', explanation: 'Neonates with UTI require IV antibiotics covering E. coli, GBS, and Enterococcus. Cefotaxime preferred over ceftriaxone in neonates.' },
        { id: 'sq4', type: 'bug_drug', question: 'Treatment of choice for Mycoplasma pneumoniae in a 10-year-old?', options: ['Azithromycin', 'Amoxicillin', 'Ceftriaxone', 'Vancomycin'], correct: 'Azithromycin', explanation: 'Mycoplasma lacks a cell wall, making beta-lactams ineffective. Macrolides are first-line for atypical pneumonia.' },
        { id: 'sq5', type: 'bug_drug', question: 'A child with cat scratch lymphadenopathy. Causative organism?', options: ['Bartonella henselae', 'Toxoplasma gondii', 'Staphylococcus aureus', 'Francisella tularensis'], correct: 'Bartonella henselae', explanation: 'Cat scratch disease from Bartonella henselae causes regional lymphadenopathy 1-3 weeks after inoculation.' },
        { id: 'sq6', type: 'bug_drug', question: 'Antibiotic for MRSA skin abscess in a 5-year-old after I&D?', options: ['TMP-SMX', 'Amoxicillin', 'Cephalexin', 'Azithromycin'], correct: 'TMP-SMX', explanation: 'TMP-SMX or clindamycin are first-line for outpatient MRSA skin/soft tissue infections after incision and drainage.' },
        { id: 'sq7', type: 'bug_drug', question: 'A 4-year-old with epiglottitis. Most likely pathogen?', options: ['H. influenzae type b', 'S. pyogenes', 'S. aureus', 'Moraxella catarrhalis'], correct: 'H. influenzae type b', explanation: 'Although rare post-Hib vaccine, H. influenzae type b remains the classic cause. Unvaccinated children are at highest risk.' },
        { id: 'sq8', type: 'bug_drug', question: 'Treatment of congenital syphilis in a neonate?', options: ['IV penicillin G', 'IM ceftriaxone', 'Oral azithromycin', 'IV vancomycin'], correct: 'IV penicillin G', explanation: 'Aqueous crystalline penicillin G IV for 10 days is the standard treatment for congenital syphilis.' },
        // VACCINES (8)
        { id: 'sq9', type: 'vaccine', question: 'A 12-month-old is due for vaccines. Which is given at this visit?', options: ['MMR + Varicella + Hep A', 'DTaP + IPV + Hib', 'Meningococcal ACWY', 'HPV'], correct: 'MMR + Varicella + Hep A', explanation: 'At 12 months: MMR #1, Varicella #1, Hep A #1. DTaP/IPV/Hib are given earlier (2, 4, 6 months).' },
        { id: 'sq10', type: 'vaccine', question: 'Which vaccine is a live attenuated vaccine?', options: ['MMR', 'DTaP', 'Hepatitis B', 'Pneumococcal conjugate'], correct: 'MMR', explanation: 'MMR and Varicella are live vaccines. DTaP is a toxoid/subunit vaccine. Hep B and PCV13 are inactivated/conjugate.' },
        { id: 'sq11', type: 'vaccine', question: 'A premature infant born at 28 weeks is now 2 months old. Vaccination approach?', options: ['Vaccinate per chronological age', 'Delay until 6 months', 'Vaccinate per corrected age', 'Only give Hep B'], correct: 'Vaccinate per chronological age', explanation: 'Premature infants are vaccinated based on chronological age, not corrected gestational age, with the exception of Hep B in infants <2 kg.' },
        { id: 'sq12', type: 'vaccine', question: 'Contraindication to receiving the MMR vaccine?', options: ['Severe immunodeficiency', 'Mild URI', 'Egg allergy', 'Family history of seizures'], correct: 'Severe immunodeficiency', explanation: 'Live vaccines (MMR, varicella) are contraindicated in severe immunodeficiency. Egg allergy is NOT a contraindication to MMR.' },
        { id: 'sq13', type: 'vaccine', question: 'Post-exposure prophylaxis for an unvaccinated child exposed to measles?', options: ['MMR within 72 hours', 'Acyclovir', 'Oseltamivir', 'Ribavirin'], correct: 'MMR within 72 hours', explanation: 'MMR vaccine given within 72 hours of measles exposure can prevent disease. IG is used for immunocompromised or infants <6 months.' },
        { id: 'sq14', type: 'vaccine', question: 'At what age is the first HPV vaccine dose recommended?', options: ['11-12 years', '6 months', '2 years', '16 years'], correct: '11-12 years', explanation: 'HPV vaccine is recommended starting at age 11-12, can be given as early as 9. Two doses if started before 15; three if 15 or older.' },
        { id: 'sq15', type: 'vaccine', question: 'Rotavirus vaccine is contraindicated in which condition?', options: ['History of intussusception', 'Mild diarrhea', 'Breastfeeding', 'Prematurity'], correct: 'History of intussusception', explanation: 'Rotavirus vaccine carries a small risk of intussusception and is contraindicated in infants with prior intussusception or SCID.' },
        { id: 'sq16', type: 'vaccine', question: 'An HIV-positive child with CD4 >15%. Which vaccine should be AVOIDED?', options: ['BCG', 'IPV', 'DTaP', 'Pneumococcal'], correct: 'BCG', explanation: 'BCG (live bacterial vaccine) is contraindicated in HIV. MMR and varicella CAN be given if CD4 >15%.' },
        // MURMURS (8)
        { id: 'sq17', type: 'murmur', question: 'A newborn with a harsh holosystolic murmur at the LLSB. Most likely?', options: ['VSD', 'ASD', 'PDA', 'Aortic stenosis'], correct: 'VSD', explanation: 'VSD produces a holosystolic murmur at the left lower sternal border, loudest with small restrictive defects.' },
        { id: 'sq18', type: 'murmur', question: 'Fixed split S2 on auscultation. Diagnosis?', options: ['ASD', 'VSD', 'PDA', 'Tetralogy of Fallot'], correct: 'ASD', explanation: 'Fixed splitting of S2 is pathognomonic for ASD due to equalized atrial pressures preventing normal respiratory variation.' },
        { id: 'sq19', type: 'murmur', question: 'Cyanotic infant with "boot-shaped" heart on CXR. Diagnosis?', options: ['Tetralogy of Fallot', 'Transposition of great arteries', 'Truncus arteriosus', 'Total anomalous pulmonary venous return'], correct: 'Tetralogy of Fallot', explanation: 'ToF shows boot-shaped heart (coeur en sabot) from RVH. It is the most common cyanotic CHD beyond infancy.' },
        { id: 'sq20', type: 'murmur', question: 'A neonate with cyanosis unresponsive to O2 and an "egg on a string" CXR. Diagnosis?', options: ['Transposition of great arteries', 'Tetralogy of Fallot', 'Coarctation of aorta', 'Ebstein anomaly'], correct: 'Transposition of great arteries', explanation: 'TGA shows "egg on a string" CXR. Cyanosis is PGE1-responsive. Survival depends on mixing (ASD, VSD, or PDA).' },
        { id: 'sq21', type: 'murmur', question: 'Still murmur in a 4-year-old. Characteristics?', options: ['Musical vibratory systolic, benign', 'Harsh holosystolic, pathologic', 'Continuous machinery murmur', 'Diastolic rumble'], correct: 'Musical vibratory systolic, benign', explanation: 'Still murmur is the most common innocent murmur in children â€” musical, vibratory, grade 1-2, loudest supine, disappears with Valsalva.' },
        { id: 'sq22', type: 'murmur', question: 'Infant with differential cyanosis (pink upper, blue lower extremities). Diagnosis?', options: ['Coarctation with PDA', 'TGA', 'ToF', 'ASD'], correct: 'Coarctation with PDA', explanation: 'Differential cyanosis (upper body pink, lower blue) occurs with coarctation + PDA where deoxygenated blood flows through the PDA to the lower body.' },
        { id: 'sq23', type: 'murmur', question: 'A systolic ejection murmur with a systolic click at the RUSB in a teenager. Diagnosis?', options: ['Bicuspid aortic valve', 'Mitral valve prolapse', 'Pulmonary stenosis', 'HCM'], correct: 'Bicuspid aortic valve', explanation: 'Bicuspid aortic valve presents with a systolic ejection click and crescendo-decrescendo murmur at the right upper sternal border.' },
        { id: 'sq24', type: 'murmur', question: 'An infant fails to gain weight, sweats during feeding, and has hepatomegaly. Most likely CHD?', options: ['Large VSD with heart failure', 'Small ASD', 'Mild pulmonary stenosis', 'Innocent murmur'], correct: 'Large VSD with heart failure', explanation: 'Large left-to-right shunts (VSD) cause volume overload, CHF with poor feeding, diaphoresis, FTT, and hepatomegaly.' },
        // SCENARIOS (8)
        { id: 'sq25', type: 'scenario', question: 'A 6-year-old with migratory polyarthritis, fever, and new murmur 3 weeks after pharyngitis. Diagnosis?', options: ['Acute rheumatic fever', 'Kawasaki disease', 'JIA', 'Endocarditis'], correct: 'Acute rheumatic fever', explanation: 'Jones criteria: migratory polyarthritis + carditis + preceding strep pharyngitis = ARF. Treat with penicillin and aspirin.' },
        { id: 'sq26', type: 'scenario', question: 'Kawasaki disease: which finding is MOST concerning for long-term complications?', options: ['Coronary artery aneurysm', 'Strawberry tongue', 'Conjunctivitis', 'Desquamation'], correct: 'Coronary artery aneurysm', explanation: 'Coronary artery aneurysms are the most serious complication. IVIG within 10 days of fever onset reduces risk from 25% to <5%.' },
        { id: 'sq27', type: 'scenario', question: 'A 14-year-old athlete collapses during a basketball game. Most likely cause?', options: ['Hypertrophic cardiomyopathy', 'Acute MI', 'Pulmonary embolism', 'Vasovagal syncope'], correct: 'Hypertrophic cardiomyopathy', explanation: 'HCM is the #1 cause of sudden cardiac death in young athletes. It causes LVOT obstruction worsened by dehydration and exercise.' },
        { id: 'sq28', type: 'scenario', question: 'A neonate presents with weak femoral pulses and upper extremity hypertension. Diagnosis?', options: ['Coarctation of the aorta', 'PDA', 'ASD', 'Aortic stenosis'], correct: 'Coarctation of the aorta', explanation: 'Coarctation classically presents with upper > lower extremity BP, weak femoral pulses, and rib notching on CXR in older children.' },
        { id: 'sq29', type: 'scenario', question: 'A child with erythema marginatum, chorea, and subcutaneous nodules. Which criterion is MOST specific for ARF?', options: ['Chorea', 'Polyarthritis', 'Fever', 'Elevated ESR'], correct: 'Chorea', explanation: 'Sydenham chorea is highly specific for ARF and can appear months after the initial strep infection. It alone is sufficient for diagnosis.' },
        { id: 'sq30', type: 'scenario', question: 'A 2-month-old with diaphoresis during feeds, tachycardia, and gallop rhythm. CXR shows cardiomegaly. Next step?', options: ['Echocardiogram', 'CT angiography', 'Cardiac catheterization', 'Observation'], correct: 'Echocardiogram', explanation: 'Echocardiogram is the first-line diagnostic study for suspected CHF or structural heart disease in infants.' },
        { id: 'sq31', type: 'scenario', question: 'A child with prolonged fever >5 days, bilateral conjunctival injection, cervical lymphadenopathy, and rash. Treatment?', options: ['IVIG + high-dose aspirin', 'Antibiotics', 'Corticosteroids alone', 'NSAIDs'], correct: 'IVIG + high-dose aspirin', explanation: 'Kawasaki disease treatment: IVIG 2 g/kg single infusion + high-dose aspirin, then low-dose aspirin after fever resolves.' },
        { id: 'sq32', type: 'scenario', question: 'A preterm infant develops cyanotic spells at 3 months. Echo shows ToF. Immediate management of a "tet spell"?', options: ['Knee-chest position + O2', 'IV furosemide', 'Emergency surgery', 'Adenosine'], correct: 'Knee-chest position + O2', explanation: 'Tet spells: knee-chest position (increases SVR), O2, IV fluids, morphine. Phenylephrine if refractory. Surgery is definitive but not emergent first step.' },
        // MIXED ID (8)
        { id: 'sq33', type: 'bug_case', question: 'An unvaccinated 3-year-old with barking cough, stridor, and steeple sign on CXR. Diagnosis?', options: ['Croup (parainfluenza)', 'Epiglottitis', 'Foreign body aspiration', 'Bacterial tracheitis'], correct: 'Croup (parainfluenza)', explanation: 'Croup from parainfluenza virus shows steeple sign (subglottic narrowing). Treat with dexamethasone; nebulized epinephrine for severe cases.' },
        { id: 'sq34', type: 'bug_case', question: 'A 6-month-old with paroxysmal cough, post-tussive emesis, and inspiratory whoop. Only 1 DTaP received. Diagnosis?', options: ['Pertussis', 'RSV bronchiolitis', 'Croup', 'Asthma'], correct: 'Pertussis', explanation: 'Pertussis (B. pertussis): catarrhal â†’ paroxysmal â†’ convalescent. Incomplete vaccination is a key risk factor. Diagnose with PCR; treat with azithromycin.' },
        { id: 'sq35', type: 'bug_case', question: 'A 2-year-old with high fever for 4 days that suddenly resolves, followed by a diffuse maculopapular rash. Diagnosis?', options: ['Roseola (HHV-6)', 'Measles', 'Rubella', 'Fifth disease'], correct: 'Roseola (HHV-6)', explanation: 'Roseola: high fever for 3-5 days â†’ defervescence â†’ rash appears. Caused by HHV-6. The rash spares the face and starts on the trunk.' },
        { id: 'sq36', type: 'bug_case', question: 'A child with "slapped cheek" facial erythema and lacy reticular rash on extremities. Diagnosis?', options: ['Erythema infectiosum (Parvovirus B19)', 'Scarlet fever', 'Roseola', 'Measles'], correct: 'Erythema infectiosum (Parvovirus B19)', explanation: 'Fifth disease: slapped cheek rash + lacy reticular body rash. Risk: aplastic crisis in sickle cell disease; hydrops fetalis in pregnancy.' },
        { id: 'sq37', type: 'bug_case', question: 'A 10-year-old with sandpaper rash, strawberry tongue, and pharyngitis. Treatment?', options: ['Penicillin or amoxicillin', 'Azithromycin', 'Ceftriaxone', 'Supportive care'], correct: 'Penicillin or amoxicillin', explanation: 'Scarlet fever from GAS: sandpaper rash + strawberry tongue + pharyngitis. Treat with penicillin to prevent rheumatic fever.' },
        { id: 'sq38', type: 'bug_case', question: 'Infant with honey exposure now presents with descending paralysis, constipation, and poor feeding. Diagnosis?', options: ['Infant botulism', 'GBS meningitis', 'Spinal muscular atrophy', 'Myasthenia gravis'], correct: 'Infant botulism', explanation: 'Clostridium botulinum from honey causes infant botulism. Descending flaccid paralysis, constipation, weak cry. Treat with BabyBIG (botulism IG).' },
        { id: 'sq39', type: 'bug_case', question: 'A 15-year-old with mononucleosis develops a rash after receiving amoxicillin. Cause?', options: ['EBV-induced drug rash', 'Amoxicillin allergy', 'Scarlet fever', 'Steven-Johnson syndrome'], correct: 'EBV-induced drug rash', explanation: 'EBV mononucleosis + aminopenicillin â†’ maculopapular rash in ~80% of patients. This is NOT a true penicillin allergy.' },
        { id: 'sq40', type: 'bug_case', question: 'A child in daycare with bloody diarrhea, fever, and HUS (hemolytic anemia, thrombocytopenia, renal failure). Organism?', options: ['E. coli O157:H7 (STEC)', 'Salmonella', 'C. difficile', 'Rotavirus'], correct: 'E. coli O157:H7 (STEC)', explanation: 'STEC produces Shiga toxin causing HUS. Do NOT give antibiotics â€” they increase toxin release and HUS risk. Supportive care only.' },
      ];

      // Generate personalized quiz: prioritize weak areas, shuffle, no repeats
      const questions = useMemo(() => {
        const pool = [...QUESTION_BANK];
        const weakTypes = new Set();
        const moduleTypeMap = { bug_drug: 'bug_drug', whats_the_bug: 'bug_case', vaccines_quiz: 'vaccine', cardio_murmur_quiz: 'murmur', cardio_shelf_scenarios: 'scenario' };
        // Identify weak modules
        Object.entries(moduleTypeMap).forEach(([key, type]) => {
          const prog = IDProgress.getModule(key);
          const latest = prog?.attempts?.[prog.attempts.length - 1];
          if (!latest || latest.pct < 70) weakTypes.add(type);
        });
        // Prioritize weak area questions first, then fill with others
        const weakQs = pool.filter(q => weakTypes.has(q.type)).sort(() => Math.random() - 0.5);
        const strongQs = pool.filter(q => !weakTypes.has(q.type)).sort(() => Math.random() - 0.5);
        const combined = [...weakQs, ...strongQs];
        // Ensure variety: max 4 from any single type
        const result = []; const typeCounts = {};
        for (const q of combined) {
          typeCounts[q.type] = (typeCounts[q.type] || 0) + 1;
          if (typeCounts[q.type] <= 4) result.push(q);
          if (result.length >= 15) break;
        }
        return result;
      }, []);
      const q = questions[activeQuestion] || { id: '', question: '', options: [], correct: '', explanation: '' };
      const currentAnswer = q ? answers[q.id] : undefined;
      const isCorrect = q && currentAnswer === q.correct;

      const handleAnswer = (option) => {
        if (q && q.id) setAnswers({ ...answers, [q.id]: option });
      };

      const handleNext = () => {
        if (activeQuestion < questions.length - 1) {
          setActiveQuestion(activeQuestion + 1);
        } else {
          setShowResults(true);
        }
      };

      const score = Object.keys(answers).filter(qid => {
        const question = questions.find(q => q.id === qid);
        return question && answers[qid] === question.correct;
      }).length;

      if (showResults) {
        const pct = Math.round((score / questions.length) * 100);
        const weakTopics = questions
          .map((q, i) => ({ ...q, idx: i, answered: answers[q.id], correct: answers[q.id] === q.correct }))
          .filter(q => !q.correct);

        return (
          <div className="animate-fadeIn p-8 max-w-3xl mx-auto space-y-8">
            <div>
              <h1 className="text-2xl font-bold text-slate-800 tracking-tight">Smart Study Results</h1>
              <p className="text-slate-500 mt-2 text-sm">Review your performance on this mixed-topic study session.</p>
            </div>

            <div className="grid grid-cols-3 gap-4">
              <div className="bg-white border border-slate-200 rounded-lg p-5 shadow-sm text-center">
                <div className={`text-3xl font-bold tabular-nums ${pct >= 80 ? 'text-emerald-600' : pct >= 60 ? 'text-amber-600' : 'text-red-600'}`}>{pct}%</div>
                <div className="text-sm text-slate-700 mt-1 font-medium">Your Score</div>
              </div>
              <div className="bg-white border border-slate-200 rounded-lg p-5 shadow-sm text-center">
                <div className="text-3xl font-bold text-slate-800 tabular-nums">{score}/{questions.length}</div>
                <div className="text-sm text-slate-700 mt-1 font-medium">Correct</div>
              </div>
              <div className="bg-white border border-slate-200 rounded-lg p-5 shadow-sm text-center">
                <div className="text-3xl font-bold text-slate-800 tabular-nums">{weakTopics.length}</div>
                <div className="text-sm text-slate-700 mt-1 font-medium">To Review</div>
              </div>
            </div>

            {weakTopics.length > 0 && (
              <div>
                <h2 className="text-lg font-bold text-slate-800 mb-4">Review Missed Questions</h2>
                <div className="space-y-4">
                  {weakTopics.map(q => (
                    <div key={q.id} className="p-5 bg-red-50 border border-red-200 rounded-lg">
                      <div className="flex items-start justify-between mb-2">
                        <h3 className="font-semibold text-slate-800">{q.question}</h3>
                        <span className="text-xs font-bold text-red-600 bg-red-100 px-2 py-1 rounded">Wrong</span>
                      </div>
                      <div className="bg-white p-3 rounded border border-red-200 text-sm mt-2">
                        <div className="text-red-700"><strong>Your answer:</strong> {q.answered}</div>
                        <div className="text-emerald-700 mt-1"><strong>Correct answer:</strong> {q.correct}</div>
                      </div>
                      <div className="bg-blue-50 p-3 rounded border border-blue-200 text-sm mt-2">
                        <strong className="text-blue-900">Explanation:</strong> {q.explanation}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {pct >= 80 && (
              <div className="p-5 bg-emerald-50 border border-emerald-200 rounded-lg">
                <h3 className="font-semibold text-slate-800 mb-2">Great job!</h3>
                <p className="text-sm text-slate-700">You're demonstrating strong knowledge across multiple topics. Keep practicing to maintain your edge!</p>
              </div>
            )}

            <div className="flex gap-3">
              <button onClick={() => { setActiveQuestion(0); setAnswers({}); setShowResults(false); }}
                className="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 transition font-medium">
                Try Again
              </button>
              <button onClick={() => setView({ type: 'performance' })}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                View Full Summary
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className="animate-fadeIn p-8 max-w-3xl mx-auto space-y-6">
          <div>
            <h1 className="text-2xl font-bold text-slate-800 tracking-tight">Smart Study Session</h1>
            <p className="text-slate-500 mt-2 text-sm leading-relaxed">Personalized quiz focusing on your weak areas and topics you haven't mastered yet. 12 questions covering ID, Antibiotics, Vaccines, and Cardiology.</p>
          </div>

          <div className="bg-white border border-slate-200 rounded-lg p-6">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-sm font-bold text-slate-700 uppercase tracking-widest">Question {activeQuestion + 1} of {questions.length}</h2>
              <div className="w-64 h-2 bg-slate-200 rounded-full overflow-hidden">
                <div className="h-full bg-blue-600 transition-all" style={{ width: `${((activeQuestion + 1) / questions.length) * 100}%` }}></div>
              </div>
            </div>

            <h3 className="text-lg font-semibold text-slate-800 mb-6">{q ? q.question : 'Loading...'}</h3>

            <div className="space-y-2 mb-6">
              {q && q.options && q.options.map((option, i) => (
                <button
                  key={i}
                  onClick={() => handleAnswer(option)}
                  className={`w-full p-4 text-left rounded-lg border-2 transition ${
                    currentAnswer === option
                      ? 'border-blue-600 bg-blue-50'
                      : 'border-slate-200 bg-white hover:border-slate-300'
                  }`}
                >
                  <div className="flex items-center gap-3">
                    <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${
                      currentAnswer === option ? 'border-blue-600 bg-blue-600' : 'border-slate-300'
                    }`}>
                      {currentAnswer === option && <div className="w-2 h-2 bg-white rounded-full"></div>}
                    </div>
                    <span className={`font-medium ${currentAnswer === option ? 'text-blue-900' : 'text-slate-800'}`}>{option}</span>
                  </div>
                </button>
              ))}
            </div>

            {currentAnswer && (
              <div className={`p-4 rounded-lg mb-6 ${isCorrect ? 'bg-emerald-50 border border-emerald-200' : 'bg-red-50 border border-red-200'}`}>
                <div className={`font-semibold mb-1 ${isCorrect ? 'text-emerald-900' : 'text-red-900'}`}>
                  {isCorrect ? 'âœ“ Correct!' : 'âœ— Incorrect'}
                </div>
                <p className={`text-sm ${isCorrect ? 'text-emerald-800' : 'text-red-800'}`}>{q ? q.explanation : 'No explanation available'}</p>
              </div>
            )}

            <button
              onClick={handleNext}
              disabled={!currentAnswer}
              className={`w-full py-2 rounded-lg font-medium transition ${
                currentAnswer
                  ? 'bg-blue-600 text-white hover:bg-blue-700 cursor-pointer'
                  : 'bg-slate-200 text-slate-400 cursor-not-allowed'
              }`}
            >
              {activeQuestion === questions.length - 1 ? 'See Results' : 'Next Question'}
            </button>
          </div>
        </div>
      );
    }

    // â”€â”€â”€ APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function App() {
      const [currentView, setView] = useState({ type: 'dashboard' });
      const [sidebarOpen, setSidebarOpen] = useState(false);
      const [searchQuery, setSearchQuery] = useState('');
      const navigate = useCallback((view) => { setView(view); setSidebarOpen(false); window.scrollTo(0, 0); }, []);
      return (
        <ThemeProvider><DataProvider><ProgressProvider>
          <div className="flex h-screen overflow-hidden">
            <Sidebar currentView={currentView} setView={navigate} sidebarOpen={sidebarOpen} setSidebarOpen={setSidebarOpen} />
            {sidebarOpen && <div onClick={() => setSidebarOpen(false)} className="fixed inset-0 bg-black/50 z-30 lg:hidden" />}
            <div className="flex-1 flex flex-col overflow-hidden">
              <TopBar setSidebarOpen={setSidebarOpen} searchQuery={searchQuery} setSearchQuery={setSearchQuery} currentView={currentView} setView={navigate} />
              <main className="flex-1 overflow-y-auto scrollbar-thin">
                {currentView.type === 'dashboard' && <DashboardView setView={navigate} />}
                {currentView.type === 'domain' && <DomainView domain={currentView.domain} setView={navigate} />}
                {currentView.type === 'vignette' && <VignettePlayer vignetteId={currentView.vignetteId} domain={currentView.domain} setView={navigate} fromDomain={currentView.fromDomain} />}
                {currentView.type === 'all_vignettes' && <AllVignettesView setView={navigate} />}
                {currentView.type === 'id_hub' && <IDHubView />}
                {currentView.type === 'cardio_hub' && <CardioHubView />}
                {currentView.type === 'nbme_strategy' && <NBMEStrategyView />}
                {currentView.type === 'rapid_review' && <RapidReviewView />}
                {currentView.type === 'performance' && <PerformanceSummaryView setView={navigate} />}
                {currentView.type === 'smart_study' && <SmartStudyView setView={navigate} />}
                {currentView.type === 'achievements' && <AchievementsView />}
                {currentView.type === 'search' && <SearchView query={currentView.query} setView={navigate} />}
              </main>
            </div>
          </div>
        </ProgressProvider></DataProvider></ThemeProvider>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
